CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C                                                                    C
C                       SUBROUTINE: PBCIR                            C
C                                                                    C
C       THIS SUBROUTINE BUILDS AN AUXILIARY CIRCUIT TO PROBE.        C
C       PORT NUMBER IS PLACED INTO COMMON BLOCK: AUX.                C
C                                                                    C
C       FORMAT: CALL PBCIR(IERR)                                     C
C       ARGUMENTS:                                                   C
C          IERR : ERROR FLAG. SET TO 0 = NO ERROR. CIRCUIT BUILT.    C
C                 SET TO 1 = UNABLE TO BUILD CIRCUIT.                C
C                 SET TO 2 = BAD RESPONSE FROM PROBE DURING LOGIN    C
C                                                                    C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC

        SUBROUTINE PBCIR(IERR)

        IMPLICIT INTEGER(A-Z)

        DIMENSION PROBE(2),PASSWD(12),USERNA(8)

C PLACE THE PORT NUMBER INTO COMMON
        COMMON /AUX/PORT

C INITIALIZE PROBE LOGIN STRING VARIABLES
        DATA PROBE/'PROBE:*;  '/
        DATA USERNA/7,78,69,84,83,89,83,13/
        DATA PASSWD/11,67,82,65,78,75,32,73,84,85,80,13/
        DATA COLON/58/

C BUILD THE AUXILIARY CIRCUIT TO PROBE
100     CALL FBCIR(PROBE,PORT,IERR2)

C IF ERROR RETURN IS NON ZERO, UNABLE TO BUILD CIRCUIT
110     IF (IERR2.EQ.0) GO TO 120
        IERR=1
        GO TO 900

C PROBE SHOULD RETURN A COLON - LOOK FOR IT
120     CALL SCAN(COLON,RESLT1)
        IF (RESLT1.EQ.1) GO TO 130

C ERROR. BAD RESPONSE FROM PROBE
125     IERR=2
        GO TO 900

C SEND PROBE USERNAME
130     CALL SEND(USERNA)

C PROBE SHOULD RESPOND WITH A COLON - LOOK FOR IT
135     CALL SCAN(COLON,RESLT2)
        IF (RESLT2.EQ.1) GO TO 150

C DIDN'T GET THE COLON
140     IERR=2
        GO TO 900

C SEND PROBE PASSWORD
150     CALL SEND(PASSWD)

C PROBE SHOULD RESPOND WITH A COLON - LOOK FOR IT
155     CALL SCAN(COLON,RESLT3)
        IF (RESLT3.EQ.1) GO TO 165

C DIDN'T GET THE COLON
160     IERR=2
        GO TO 900

C LOGIN COMPLETED
165     IERR=0

C RETURN
900     RETURN
        END

CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C                                                                    C
C                       SUBROUTINE: PBKER                            C
C                                                                    C
C       THIS SUBROUTINE FINDS THE KERNAL HOST NUMBER FOR A SPECIFIED C
C       NODE NUMBER.  THE KERNAL IS OBTAINED FROM PROBE. CURRENTLY   C
C       THIS SUBROUTINE RETURNS KERNALS FOR TYMNET-II STAND ALONE    C
C       TYMSATS ONLY.                                                C
C                                                                    C
C       FORMAT: CALL PBKER(NODE HOST,IERR)                           C
C       ARGUMENTS:                                                   C
C          NODE : VARIABLE CONTAINING TYMNET-II NODE NUMBER          C
C          HOST : VARIABLE RETURNING KERNAL HOST NUMBER FOR NODE     C
C          IERR : VARIABLE RETURNING ANY ERROR CONDITIIONS           C
C                 IF SET TO 0 = NO ERROR                             C
C                 IF SET TO 1 = UNABLE TO FIND HOST NUMBER           C
C                 IF SET TO 2 = MORE THAN ONE HOST NUMBER FOUND      C
C                                                                    C
C       ACCESSES: COMMON/AUX/PORT                                    C
C                                                                    C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC


        SUBROUTINE PBKER(NODE,HOST,IERR)

        IMPLICIT INTEGER(A-Z)

        DIMENSION COMAND(13),OUTARR(50,80),HSCAN(15),LSCAN(15),TEMP(80)

        COMMON /AUX/PORT

        HOST=0
        IERR=0

C SET UP "HOST STATUS" STRING
        DATA  HSCAN/'HOST STATUS    ',12*' '/

C SET UP "LINK STATUS" STRING

        DATA LSCAN/'LINK STATUS    ',12*' '/

C THE PROBE PROMPT IS A COLON. SET VARIABLE PROMPT TO A COLON
        DATA PROMPT/58/

C SET OUTPUT ARRAY SIZE
        DATA ASIZE/50/


C BUILD THE PROBE "NODE" COMMAND
100     CALL AXBCOM('N',NODE,COMAND)

C ISSUE THE COMMAND TO PROBE
110     CALL SEND(COMAND)

C GET THE OUTPUT FROM THE "NODE" COMMAND AND STORE IT IN OUTARR

120     CALL AXMOUT(PROMPT,ASIZE,OUTARR,ARREND)

C SEARCH OUTPUT ARRAY FOR "HOST STATUS"
130     CALL AXASCA(OUTARR,ASIZE,HSCAN,CLIN,CPOS)

C SEE IF STRING WAS FOUND
140     IF (CLIN.NE.0) GO TO 150

C LINE NOT FOUND
145     TYPE 146
146     FORMAT (1X,48HDID NOT LOCATE "HOST STATUS" IN OUTPUT FROM PROBE)
        IERR=1
        GO TO 900

C LINE WAS FOUND. NOW LOOK AT NEXT LINE FOR HOST NUMBER. FIRST 
C INCREMENT OUTARR POINTER TO NEXT LINE

150     CLIN=CLIN+1

C PUT THIS LINE OF OUTPUT INTO TEMP ARRAY
        DO 160 I=1,80
        TEMP(I)=OUTARR(CLIN,I)
160     CONTINUE

C SCAN THIS LINE FOR HOST NUMBER
170     CALL AXISCA(TEMP,1,HOST1,IERR2)

C SEE IF NUMBER WAS FOUND
175     IF (HOST1.NE.0) GOTO 185

C NOT FOUND. ERROR
180     TYPE 182
182     FORMAT (1X,42HA HOST NUMBER DID NOT FOLLOW "HOST STATUS",/)
        IERR=1
        GO TO 900

C NOW LOOK AT NEXT LINE OF OUPUT FOR 'LINK STATUS'. FIRST INCREMENT 
C OUTARR POINTER TO NEXT LINE
185     CLIN=CLIN+1

C PLACE LINE OF OUTPUT INTO TEMP ARRAY
        DO 190 I=1,80
        TEMP(I)=OUTARR(CLIN,I)
190     CONTINUE

C SCAN FOR "LINK STATUS"

200     CALL AXLSCA(TEMP,LSCAN,1,CPOS)

C SEE IF STRING WAS FOUND
210     IF (CPOS.NE.0) GO TO 225

C NOT FOUND. ERROR
215     TYPE 216
216     FORMAT(1X,'MORE THAN ONE HOST ON NODE',/
     +         1X,'UNABLE TO RECOGNIZE KERNAL HOST',/)
        IERR=2
        GO TO 900

C ONLY ONE HOST ON NODE. THEREFORE, THIS IS THE KERNAL
225     HOST=HOST1

C FINISHED. RETURN
900     RETURN
        END
