



                                                         February 1, 1988








                   SNA/SDLC External Reference Manual


                          Version 3 Revision 03











                                 TYMNET
                     NETWORK TECHNOLOGY DEVELOPMENT
                            February 1, 1988





  ====================================================================
  |       TYMNET's  proprietary  rights  are  included  in  the      |
  |       information disclosed herein. The recipient, by receiving  |
  |       this document, agrees that neither this document nor the   |
  |       information disclosed herein nor any part thereof shall be |
  |       reproduced or transferred to other documents or used or    |
  |       disclosed to others for manufacturing or for any other     |
  |       purpose except as specifically authorized in writing by    |
  |       TYMNET.                                                    |
  ====================================================================



Copyright 1988 by Tymnet -- The McDonnell Douglas Network Systems Company











                    SNA/SDLC External Reference Manual         SNAE03.D03




                                                         February 1, 1988







                             TABLE OF CONTENTS

  Section                                                            Page



  1.   Introduction and Scope                                           2
    1.1   Introduction                                                  3
    1.2   References and Documents                                      4


  2.   Support in a TYMNET Network                                      5
    2.1   TYMNET SNA/SDLC Network                                       5
    2.2   Layout of the TYMNET SNA/SDLC Interface                       7
    2.3   Outline of Services                                           9


  3.   TYMNET SNA/SDLC Interface - Principle of Operation              11
    3.1   SNA/SDLC Terminal Interface                                  11
       3.1.1    SDLC/EIA signalling                                    11
       3.1.2    ACTPU                                                  12
       3.1.3    ACTLU                                                  13
       3.1.4    Network Services Manager                               13
          3.1.4.1     NSM Initiated by TIF                             14
          3.1.4.2     NSM requested from user                          15
          3.1.4.3     Local Session Bind Timeout                       15
          3.1.4.4     Network Logon                                    16

       3.1.5    Data Flow                                              19
       3.1.6    Logging Off                                            19
          3.1.6.1     Application Logoff                               20
          3.1.6.2     Application Logoff and Network Logoff            20

    3.2   SNA/SDLC Host Interface                                      21
       3.2.1    Startup                                                21
       3.2.2    Logon                                                  22
       3.2.3    Data Flow                                              24
          3.2.3.1     Native mode                                      24
          3.2.3.2     Virtual DSP mode                                 24

       3.2.4    Logoff                                                 24
          3.2.4.1     Application logoff                               24
          3.2.4.2     Application timeout                              25
          3.2.4.3     Network logoff                                   26
          3.2.4.4     Abnormal break of connection, inactivity timeout 26

    3.3   Network Services Manager                                     28
       3.3.1    Activating the Network Services Manager                28

                    SNA/SDLC External Reference Manual         SNAE03.D03




                                                         February 1, 1988


          3.3.1.1     Network Service Screen Functions                 28

       3.3.2    Manual logon screen                                    29
       3.3.3    Preset Logon Screen                                    29
       3.3.4    DSP information screen                                 30
       3.3.5    Printer logon                                          33

    3.4   SNA/DSP protocol convertor                                   34
       3.4.1    Data transfer from host to terminal                    34
       3.4.2    Terminal to host data transfer                         35
       3.4.3    3270 SYS/REQ Function Key Emulation                    37

    3.5   Virtual Host Printer                                         38
       3.5.1    LU type 3 support for Virtual Host printer             38
          3.5.1.1     Logon processing                                 38
          3.5.1.2     End-to-end operation                             38

       3.5.2    Network I/O procedures for printer support             39
          3.5.2.1     CRM1 usage                                       40
          3.5.2.2     CRM2 and CRM3 usage                              41
          3.5.2.3     CRM4 usage - to be implemented in version 2.00   41

       3.5.3    Special functions of VHP                               42
          3.5.3.1     Handling of backpressure and other printer delays42
          3.5.3.2     Printer copy initiated by host                   43

    3.6   Terminal Dial Up                                             45
       3.6.1    Constraints                                            46
       3.6.2    Signalling Protocol                                    46
       3.6.3    Disconnection                                          47

    3.7   Virtual Host Reflect                                         48
       3.7.1    Product Overview                                       48
       3.7.2    Functional Overview                                    49
       3.7.3    Virtual Circuit Building                               50
       3.7.4    SNA/DSP protocol and mapping functions                 56
          3.7.4.1     SNA/DSP mapping for host-terminal data transfer  56
          3.7.4.2     SNA/DSP mapping for terminal-host data transfer  61

       3.7.5    SSCP-LU handling                                       63


  4.   User Interface - Operational Aspects                            64
    4.1   SNA/SDLC Connection Types                                    64
       4.1.1    Natve Mode                                             64
       4.1.2    SNA Virtual Host Mode                                  66

    4.2   Network Services Screen                                      68
       4.2.1    Native Mode                                            68
       4.2.2    Virtual Host Mode                                      68

    4.3   User Interface - Configuration                               69
       4.3.1    Host Access                                            69

                    SNA/SDLC External Reference Manual         SNAE03.D03




                                                         February 1, 1988


       4.3.2    Terminal Access                                        70
       4.3.3    Polling Address and Logical Unit Address               70

    4.4   System Generation Parameters                                 71
       4.4.1    General Slot Parameters                                71
       4.4.2    Host Link Parameters                                   71
       4.4.3    Terminal Link Parameters                               72


  5.   CRM 4 for Host Interface                                        73
    5.1   Overview                                                     73
    5.2   CRM 4 Calling Procedures                                     74
       5.2.1    Call Establishment                                     75
       5.2.2    Call Clearing                                          77
       5.2.3    Associating Terminals and Printers                     78


  6.   LU Type 1 Virtual Host Printer                                  79
    6.1   Overview                                                     79
    6.2   Conversion Between LU_T1 SCS Data and 3270 DSP WSF           80
       6.2.1    LU_T1 SCS Data                                         80
          6.2.1.1     SCS Data Structured Field                        81
          6.2.1.2     SCS Data without FMH                             84

       6.2.2    3270 DSP                                               85
       6.2.3    Mapping Between LU_T1 SCS and 3270 DSP                 88
          6.2.3.1     SCS Structured Field Mapping to DSP WSF          88
          6.2.3.2     SCS Data without FMH Mapping to DSP WSF          89


  7.   Virtual Host Reflect Mode                                       92
    7.1   Virtual Host Reflect Introduction                            92
    7.2   Virtual Host Reflect Function                                93
    7.3   Network I/O Reversed Functions                               94
       7.3.1    Virtual Cuircuit Building                              94
       7.3.2    SNA/DSP protocol and mapping functions                101
          7.3.2.1     SNA/DSP host to terminal data transfer          102
          7.3.2.2     SNA/DSP terminal to host data transfer          108

    7.4   Special SNA considerations for VHR                          110
       7.4.1    SSCP-LU handling                                      110
       7.4.2    Half Duplex/Full Duplex mode of operation             110
       7.4.3    Printer support                                       111


  8.   Virtual Terminal Mode                                          114
    8.1   Virtual Terminal Introduction                               114
    8.2   Principles of Operation for Virtual Terminal Interface      115
       8.2.1    SDLC level                                            116
       8.2.2    PU level                                              116
       8.2.3    SSCP-LU level at session establishment                116
       8.2.4    LU-LU level                                           117
       8.2.5    SSCP-LU vs. LU-LU FMD RU's                            118

                    SNA/SDLC External Reference Manual         SNAE03.D03




                                                         February 1, 1988


       8.2.6    SNA/DSP host to terminal data transfer                120
       8.2.7    SNA/DSP terminal to host data transfer                121


                               APPENDICES
                               ==========


  I.   Structured Fields                                              123


  II.  Function Management Header Type 1                              125


                               APPENDICES
                               ==========


  I.   LU Type 3 Support for VHR/VTR                                  128


                                INDEX
                                =====                                 130































                    SNA/SDLC External Reference Manual         SNAE03.D03




                                                         February 1, 1988





                              LIST OF TABLES
                              ==============


  Table                                                              Page


  1.     "EBCDIC" Error Messages                                       77

  2.     Structured SCS RU Fields                                      83

  3.     Unstructured SCS RU Fields                                    85

  4.     DSP WSF Message Fields                                        87

  5.     Types of Structured Fields                                   124

  6.     FMH-1 Description                                            125

































                    SNA/SDLC External Reference Manual         SNAE03.D03




                                                         February 1, 1988





                              LIST OF FIGURES
                              ===============


  Figure                                                             Page


  1.     TYMNET Network with SNA/SDLC interface                         6

  2.     Tymnet SNA/SDLC Interface usage Conceptual layout              7

  3.     Native Mode Service                                           65

  4.     SNA Virtual Host Mode Service                                 67

  5.     Example Configuration                                         75

  6.     Structured SCS RU Format                                      82

  7.     Unstructured SCS RU Format                                    84

  8.     DSP WSF Message Format                                        86

  9.     SCS Structured Field Mapping to DSP WSF                       89

  10.    SCS Unstructured Field Mapping to DSP WSF                     91

  11.    VTR - VHR Manual Logon Scenario                               98

  12.    VTR - VHR Prestore Logon Scenario                             98

  13.    VTR - VHR Data Exchange Flow                                 105

  14.    VTR - VHR Data Conversion                                    108

















                    SNA/SDLC External Reference Manual         SNAE03.D03




                                                         February 1, 1988


                                  Preface



  This    manual   describes    the   technical    aspects,   operational
  characteristics, and application  of the TYMNET SNA/SDLC  support. This
  manual is organized into 6 main sections.


  The first section is an overview. This section gives an overview of the
  applications  of  the  SNA/SDLC  Interface,  an  introduction   to  SNA
  environments, and document references.


  The  second  section is  a  brief introduction  to  IBM  SNA/SDLC. This
  section describes some of  the SNA terminology and definitions  used in
  this manual.


  The third  section describes  support for the  SNA/SDLC Interface  in a
  TYMNET Network.


  The  fourth  section  describes the  principle  of  operations  for the
  SNA/SDLC Interface.


  The fifth section explains  the different user interfaces  supported by
  the SNA/SDLC Interface.


  The  sixth  section  deals  with  the  different   system  environments
  supported by this interface.





















  1                 SNA/SDLC External Reference Manual         SNAE03.D03




  Introduction and Scope                                 February 1, 1988






                        1 -  Introduction and Scope




  The TYMNET  SNA/SDLC Interface product  provides access between  an SNA
  SDLC PU.T2 (such as a cluster controller) and an SNA/SDLC PU.T4/5 (such
  as a communication controller).


  In addition, this interface  allows for non-SNA terminal  devices (such
  as ASYNC and BISYNC terminals)   access to an SNA/SDLC PU.T4/5.  When a
  non-SNA terminal device is  used, other TYMNET interfaces must  be used
  in conjunction with the SNA/SDLC Interface to provide for  the terminal
  support. Usage of a non-SNA terminal device is very close to that of an
  SNA/SDLC terminal once the network signon procedures are completed.


  All of the original functions  and capabilities of the PU.T4/5  and the
  remote  PU.T2 are  preserved with  little or  no change  to  the system
  generation  of   either  the    communication  controller   or  cluster
  controller.


  The SNA/SDLC Interface runs in a job slot on an ISIS network node. Host
  and terminal interfaces may reside in the same slot. The host interface
  appears as one or  more SNA/SDLC cluster/terminal controller(s)  to the
  host  front-end   communication  controller.  The   terminal  interface
  provides local control of the SNA/SDLC cluster/terminal controllers.





















  2                 SNA/SDLC External Reference Manual         SNAE03.D03




  Introduction and Scope                                 February 1, 1988


                             1.1  Introduction



  A TYMNET  network  consists of  a collection  of  minicomputers (nodes)
  interconnected by  communication lines to  allow information  to travel
  along alternative   paths between nodes   in the network.   The primary
  function of  a  node is  to pass   information. Nodes, typically   , do
  little or no   processing of application tasks  but do  provide  a wide
  range of  communication interfacing capability.   As an  enhancement to
  the  range  of   communication  interfaces  provided   by  the   Tymnet
  network,  Tymshare is  extending its  TYMNET  products  to  include the
  support of the IBM SNA/SDLC communication protocol.


  SNA/SDLC Revision 1.03 includes native terminal and host  interface and
  virtual (DSP)  host interface. Native  mode interface  provides support
  for connections between SNA  PU type 4 (communication  controllers) and
  PU type 2 (cluster controllers)  nodes and LU-LU type 2  sessions.  The
  interface  running  a  native  mode  gives  a  capability  to  build  a
  connection  from  a  terminal  to  any  host  atteched  to  the network
  (manually  or  with  pre-set  logon  stream)  independently  from other
  terminals on the same CU.


  The Tymnet SNA DSP  Virtual Host Interface product provides  the access
  (1)  between  IBM  8100   Information  System  (or  other  PU   type  4
  Communication  Controllers)  and BSC  Cluster  Controllers  (e.g. 3274,
  3276,  etc.)  (2)  between  IBM  Commtion  Controllers  and  ASYNC
  terminals (such as,ADM-3A,VT-100,etc.).  SNA DSP Virtual Host Interface
  provides support for LU types 2 and 3.


  Devices (e.q. 3278, 3279, etc)  on an BSC cluster controller  which are
  connected  to the  TYMNET BSC3270  Terminal interface  can individually
  access    different    hosts    (SNA,BSC    or    other    hosts)   and
  applications,increasing the  flexibility of  those BSC  remote devices.
  Printer support is also provided.


  ASYNC terminals connected  to TYMSAT can individually  access different
  IBM  hosts  which  are connected  to the  TYMNET SNA  DSP  Virtual Host
  Interface  via TYMNET  CMT Interface.  The types  of CRT's  or printers
  supported are limited only by the current capabilities of CMT.


  If BSC or  ASYNC devices are used  as terminals, other  TYMNET products
  (BSC3270  TIF  and/or CMT)  must  be used  as  terminal  interface. The
  corresponding information on these products could be found elsewhere.





  3                 SNA/SDLC External Reference Manual         SNAE03.D03




  Introduction and Scope                                 February 1, 1988


                       1.2  References and Documents



  The relevant documents include the following:


  [1] IBM SDLC General Information (GA27-3093)

  [2] IBM SNA General Information (GA27-3102)

  [3] IBM SNA Logical Unit Types (GC20-1868)

  [4] IBM SNA Format and Protocol Reference Manual (SC30-3112)

  [5] IBM 3270 Component Description (GA27-2749)

  [6] IBM 3776/3777 Component Description (GA27-3145)

  [7] ECMA Standard ECMA-71 HDLC Selected Procedures

  [8] TYMNET ISIS-II Reference Manual

  [9] TYMNET Interface Information Exchange (IIX)

  [A] TYMNET 3270 ERS

  [B] TYMNET SNA/SDLC Network Interface ERS

  [C] TYMNET SNA/SVC Sysgen Manual

  [D] TYMNET CMT/3270 ERS

  [E] IBM General Information - Binary Synchronous Communications

  [F] 3270 Display System Protocol


















  4                 SNA/SDLC External Reference Manual         SNAE03.D03




  Support in a TYMNET Network                            February 1, 1988






                     2 -  Support in a TYMNET Network









                       2.1  TYMNET SNA/SDLC Network



  TYMNET  SNA/SDLC  Interfaces  can  be  used  to  replace  links between
  SNA/SDLC hosts and SNA/SDLC terminal/Cluster controllers and to convert
  BSC 3270  type (DSP)  protocol into SNA.  (For ASYNC  device conversion
  from ASYNC to DSP is performed by CMT product).
































  5                 SNA/SDLC External Reference Manual         SNAE03.D03




  Support in a TYMNET Network                            February 1, 1988


  The following diagram illustrates the interconnection of SNA/SDLC hosts
  and terminals of various type using TYMNET.


              ----------              ----------
              |        |              |        |
              |  IBM   |              |  IBM   |
              |   370  |              |   370  |
              |        |              |        |
              ----------              ----------
                   |                       |
                   |                       |
               --------                --------
               |      |                |      |
               | 370X |                | 370X |
               |      |    +++++++     |      |
               --------   +       +    --------       --------
              SNA | SDLC +         +   SNA / SDLC     | 3276 |
   --------     H | I F +           +   H /  I F      --------
   |      |  BSC  ++++++             +++++++         /
   | 3274 |-------+                         +  SNA  / --------
   |      |  TIF   +                         +--------| 3276 |
   --------         +                        + TIF    --------
                     +                       +
         --------     +      TYMNET          + BSC    --------
         |      | SNA +                     +---------| 3276 |
         | 8100 |-----+                  +++   TIF    --------
         |      | HIF +                 +
         --------     +                +     --------
                      +                +-----| 3275 |
                       +              +      --------
                        +        +++++
                         +      +     |     
                          ++++++      |
                           C|MT       --------
                         TYM|SAT      | 3271 |
                            |         --------
                         --------
                         | VT-  |
                         | 100  |
                         |      |
                         --------





             Figure 1 - TYMNET Network with SNA/SDLC interface






  6                 SNA/SDLC External Reference Manual         SNAE03.D03




  Support in a TYMNET Network                            February 1, 1988


               2.2  Layout of the TYMNET SNA/SDLC Interface


  Figure 4 shows the conceptual layout of the Tymnet SNA/SDLC Interface.

    ----------
    |SNA/SDLC|
    |  Host  |
    |--------|
    |  Front |
    |   End  |
    ----------
       \                     **                ----------
        \                  *     **            |SNA/SDLC|
         \/             *          *           |Terminal|
             \        *              *         |  or    |
              \   *                   *        | Cluster|
    ------------------                  *      ----------
    |   |  HILM    |  |                   *          /
    |   |----------|  |                    *        /
    |   |  HSNM    |  |                      *   /\/
    |   |----------|  |                      *  /
    |   |  SDPHM   |  |                      *  |
    |   |----------|  |                      *  |
    |   |  VNPHM   |  |                  -------------------
    |   ------------  |                  |  |   TILM   |   |
    |    \  \  \      |                  |  |----------|   |
    -------------------                  |  |   TSNM   |   |
   *       \  \  \                       |  |----------|   |
  **        \  \  \/\             -------|  |  VNPTM   |   |
  *          \  \/\  \           /       |  -------------  |
  *           \    \  ----------/        |                 |
   *           \    \------\             -------------------
    *       ----------      -----                 * 
     *      | CMT IF |           \                *
     *      ----------            \             *
        *     /                    \ -------------------
          **  \       T Y M N E T    |   |   PBTM  |   |
         -------------               |   -----------   |
         |   TYMSAT  |            *  |   |  BDPTM  |   |
         -------------*      *       |   -----------   |
               /         **          -------------------
           -----------                           \
           |  ASYNC  |                       ------------
           | terminal|                       | BSC 3270 |
           -----------                       | terminal |
                                             |   or CU  |
                                             ------------



       Figure 2 - Tymnet SNA/SDLC Interface usage Conceptual layout


  7                 SNA/SDLC External Reference Manual         SNAE03.D03




  Support in a TYMNET Network                            February 1, 1988


  The SNA/SDLC Interface product consists of the following:


  1. SNA/SDLC Terminal Access

      -  SNA/SDLC Terminal Interface Link Module (TILM)
      -  SNA/SDLC Native Mode Terminal Module (TSNM)
      -  SNA/SDLC VNP (Virtual Network Protocol) Terminal Module
         (VNPTM)


  2. SNA/SDLC Host Access

      -  SNA/SDLC Host Interface Link Module (HILM)
      -  SNA/SDLC Native Mode Host Module (HSNM)
      -  SNA/DSP Virtual Host Convertor Module (SDPHM)
      -  SNA/SDLC VNP (Virtual Network Protocol) Host Module (VNPHM)


  The TILM is the interface by which an IBM or IBM-compatible terminal or
  cluster controller is connected to a TYMNET network. The  protocol used
  by this  module can  be HALF-Duplex  Point-to-Point/Multi-Point Primary
  SDLC link procedures.  The  connected external controller must  use the
  corresponding Secondary SDLC link procedure.


  The  TSNM emulates  subset  of SNA  higher layer  protocols  to locally
  control the connected  IBM or IBM compatible  SNA/SDLC terminal/cluster
  controllers.


  The VNPTM  is paired  with the VNPHM  to permit  an SNA/SDLC  device to
  establish a logical connection  (virtual circuit) to an  SNA/SDLC host.
  The  protocol used  by these  two modules  is SNA/SDLC  Virtual Network
  protocol.   This protocol  provides the  necessary  translation between
  SNA/SDLC  protocols and  the Tymnet  network protocols.  The  VNPTM and
  VNPHM protocols are compatible  to the TYMNET Bisync 3270  DSP (Display
  System Protocol) protocol.


  The HILM  is the interface  by which an  IBM or IBM-compatible  host or
  front-end processor may  be connected to  a TYMNET network  using Half-
  Duplex Point-to-Point/Multi-Point SDLC Link procedure.


  The HSNM emulates subset of  the SNA higher layer protocols  to locally
  respond to the connected host.


  The SDPHM converts DSP response  message arriving from BSC 3270  TIF or
  CMT into SNA  RU. Alternately, it converts  SNA RU's arriving  from SNA
  host to  DSP command message.  Local support of  other SNA  messages is
  also provided.

  8                 SNA/SDLC External Reference Manual         SNAE03.D03




  Support in a TYMNET Network                            February 1, 1988


  Current SNA/SDLC users may use the TILM and HILM with the  SNA/SDLC SNM
  modules and  SNA/SDLC VNP modules  with little or  no changes  to their
  software.  (Changes  may be  necessary to  properly handle  timings and
  disconnects.) Also no  changes are required  to TYMNET BSC  3270 and/or
  CMT products for  the users which already  had them for other  types of
  connections.








                         2.3  Outline of Services




  The following  are points  of interest  as an  outline of  the SNA/SDLC
  interface services.  The  supported PU_T2 nodes  or devices for  such a
  connection are: 3274, 3276, 8100, 8140, 8150. If the terminal interface
  used is other then SNA/SDLC the list of supported devices can  be found
  in corresponding TIF documentation.


  The  supported PU_T4|5  nodes and  systems for  such a  connection are:
  37X5, 8100, 8150, 8140.


  The outline of such services are :


     -   Each device  utilizes a separate virtual circuit. Here, a device
         means one 'Logical Unit' for SNA devices.

     -   A virtual  circuit will normally  be established by  a formatted
         network services screen.

     -   A printer virtual circuit will normally be established  by using
         the Network Service Screen of a CRT connected to the same TYMNET
         TIF.

     -   A remote user/device is  capable of communicating with  a number
         of hosts by changing the network signon.

     -   Data transfers will be locally acknowledged by the HILM and TILM
         by following the SDLC  link procedures. For non-SNA  devices see
         corresponding TIF documentation.

     -   The interface has configurable  retry limits and timers  for the
         link level procedures.


  9                 SNA/SDLC External Reference Manual         SNAE03.D03




  Support in a TYMNET Network                            February 1, 1988


     -   The interface  has configurable parameters  to match  the system
         characteristics of the connected external IBM  or IBM-compatible
         SNA/SDLC systems.

     -   The interface has configurable inactivity timers for each device
         to logoff the user from host application.

     -   Only LU session types 2 and 3 are currently supported (LU type 3
         support is limited to Virtual Host Mode only).

     -   Dial-Up from terminal to SNA Terminal Interface is  available on
         TYMNET SNA 1.05 and later versions.










































  10                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988






          3 -  TYMNET SNA/SDLC Interface - Principle of Operation




  This section describes the principles of operation of Tymnet's SNA/SDLC
  Network  interfaces.  It  assumes that  readers are  familiar  with SNA
  protocols and Tymnet ISIS technology.








                     3.1  SNA/SDLC Terminal Interface



  This document covers  terminal interface operation for  SNA/SDLC native
  mode only.  See corresponding documentation  for operation  of terminal
  interface for non-SNA terminals.






              3.1.1  SDLC/EIA signalling

        3276             TIF
          |               |
          |<--- DTR off   | DTR dropped when link is initialized
          |               | until either DSR drops or timer expired
          |<--- DTR on    | DTR raised
          |               |
          /               /
          |    DSR on --->| modem signals incoming call
          |               |
          |<-- SNRM ------|
          |               |
          |----- UA ----->| controller is ready
          |               |


  On a switched line, the TIF waits for DSR before issuing an SNRM.



  11                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


        3276             TIF
          |               |
          |               | Link initialized
          |<--- SNRM -----|
          |               |
          |---- UA ------>| controller is ready
          |               |


  On  a  leased  line,  the  TIF issues  SNRM  after  the  link  has been
  initialized or re-initialized.

        3276              TIF
          |               |
          |<--- SNRM -----| Polling timer starts
          |               |
          |               |
          |               |
          |               | timeout
          |<--- SNRM -----| Polling timer restarts
          |               |


  In either configuration,  if no response is  received, an SNRM  will be
  issued after the timer expired.







              3.1.2  ACTPU

        3276             TIF
          |               |
          |<--- ACTPU ----|
          |               |
          |- +RSP,ACTPU ->| PU activated
          |               |


  Once the link is established, the TIF issues ACTPU to the controller.

        3276              TIF
          |               |
          |<--- ACTPU ----| APUTO starts
          |               |
          |               |
          |               | timeout,
          |<--- ACTPU ----| re-issue ACTPU, APUTO restarts
          |               |


  12                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  If a +RSP(ACTPU) is not  received within a timeout period  specified in
  the Tymfile, or any other  response is received, the ACTPU will  be re-
  issued.  The interval  between ACTPU's is  specified in seconds  in the
  Tymfile parameter APUTO. (This feature is not implemented in  the first
  phase.)





              3.1.3  ACTLU

        3276             TIF
          |               |
          |<--- ACTLU ----|
          |               |
          |- +RSP,ACTLU ->| LU activated
          |               |


  Once the  PU is activated  the TIF issues  ACTLU to each  LU associated
  with the PU.  If a +RSP(ACTLU) is not received within a  timeout period
  specified in the Tymfile, or any other response is received,  the ACTLU
  will  be  re-issued.   The interval  between  ACTLU's  is  specified in
  seconds in  the Tymfile  parameter ALUTO. (The  timeout feature  is not
  implemented in the first phase.)






              3.1.4  Network Services Manager


  The TIF Network Services Manager (NSM) provides network  services, such
  as call establishment and call clearing, to the 3276 user.  It delivers
  these and  other services through  four screens; services  menu screen,
  network  services screen,  manual logon  screen, and  DSP  screen.  See
  section  4.3 for  a complete  description of  the NSM  and  the various
  screens.













  13                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  3.1.4.1  NSM Initiated by TIF

        3276             TIF
          |               |
          |<--- BIND -----| NSM BIND
          |               |
          |- +RSP,BIND -->| controller accepts
          |               |
          |<--- SDT ------| Start Data Traffic
          |               |
          |- +RSP,SDT --->|
          |               |
          |<-- NSM menu --| NSS menu
          |               |
          |-- +RSP ------>|
          |               |


  All NSM screens are sent on a local LU-LU session.  The BIND parameters
  for this session are defined in the Tymfile.  The NSM services  menu is
  sent:

    o after +RSP to ACTLU request
    o after network call is cleared
    o on request from user (not available in Phase I)





























  14                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  3.1.4.2  NSM requested from user


  Note: This feature is not available for Phase I.

         3276            TIF
          |               |
          |-- SSCP/LU --->| User entered SYS REQUEST, "Keyword"
          |               |
          |<-- SSCP/LU ---| TIF +rsp
          |               |
          |<-- UNBIND ----| TIF unbind LU/LU end-to-end session
          |- +RSP,UNBIND->|
          /               / See 4.1.4.1 
          |               | NSS menu is sent using the
          |               | local bind profile
          /               /
          |               | while in this state, RUs on the LU-LU
          |               | session from the host get an exception
          |               | response indicating LU BUSY
          |               | <-- LU-LU RU ------
          |               | --- -RSP,LU BUSY -->
          /               /
          |-- menu entry >| once an entry is selected and the
          |<-- exit NSM   | network service is completed,
          |               | TIF unbind the local LU/LU session,
          |               | and bind a LU/LU session using the 
          |               | saved end-to-end bind profile
          |               | the host is sent LUSTAT indicating
          |               | presentation area lost
          |               |--- LUSTAT,082B ---->
          |               |
          /               /


  All SSCP-LU RUs, except those directed to network services, are end-to-
  end.  The ability to log on again while an end-to-end LU-LU  session is
  established is required to  support printer logon.  The string  used to
  invoke this function is  defined in the Tymfile  and is not sent  on to
  the host SSCP.



  3.1.4.3  Local Session Bind Timeout

         3276            TIF
          |               |
          |<--- BIND -----| BINDTO starts
          |               |
          |               | timeout or -RSP
          |<--- BIND -----| BINDTO restarts
          |               |


  15                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  If +RSP is not received in response to the NSM BIND, then  after BINDTO
  seconds, a Tymfile parameter, the BIND is re-issued.



  3.1.4.4  Network Logon

        3276             TIF                     HIF          3705
          |   Logon       |                       |               |
          |- menu entry ->|                       |               |
          |<--- +RSP -----|                       |               |
          |               |                       |               |
          |<-- call in ---|---- call request ---->|               |
          |    progress   |                       |               |
          |<- call cmplt -|<-- call accepted -----|               |
          |               |                       |               |
          |<-- UNBIND ----|                       |               |
          |- +RSP,UNBIND >|                       |               |
          |               |                       |               |


  The are two ways to perform the network logon:

    1) Manual Logon
    2) Preset Logon


  Manual Logon allows  the user to logon  into any host  interface he/she
  desired.  The Preset Logon method minimizes keystrokes and avoids human
  errors by displaying a pre-defined logon selection menu.


  Once the user has completed the input to the manual logon menu and hits
  the enter key or an  entry is selected from the preset  logon selection
  menu, a network call is placed to the indicated destination.  This call
  indicates the type of  connection desired (native in this  case).  Call
  progress signals  are displayed  on the  network services  screen, i.e.
  call in progress, call completed, etc.  When the call is completed, the
  local LU-LU network services session is unbound.  The screen is unowned
  at this point.














  16                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


         3276            TIF                     HIF          3705
          |               |                       |               |
          |               |                       |               |
          |               |--- network call ----->|               |
          |               |<---- call accepted ---|               |
          |               |                       |--- Host is -->|
          |               |                       |  informed of  |
          |               |                       | incoming call |
          |               |                       |<- SSCP-LU RU's|
          |               |<--- SSCP/LU RU's -----|               |
          |<-- SSCP/LU ---|                       |               |
          |    RU's       |                       |               |
          |               |                       |               |
          |--- SSCP/LU -->|                       |               |
          |     RU's      |---- SSCP/LU RU's ---->|               |
          |               |                       |-- SSCP/LU --->|
          |               |                       |    RU's ----->|
          |               |                       |               |


  Once the call is completed  the host interface informs the host  of the
  call recieved to  solicit the host  welcome banner (see  description of
  the  opration  of the  host  interface for  more  details).   From this
  moments on most of the  SSCP-LU data and LU-LU data will be  treated as
  end-to-end data.  In  the example above  the host sends  SSCP-LU banner
  message in response to host interface actions.  The 3276 screen  is now
  owned  by the  SSCP.   All SSCP-LU  data, except  for  network services
  commands, are handled end-to-end.  SSCP-LU message sent by the terminal
  operator  in  this  example  is actually  a  part  of  end-to-end logon
  procedure, the same as in case of straight connection between  3274 and
  3705 after banner message was received (say, the operator could  key in
  TSO to connect to TSO host application).


  Some of the hosts skip this  stage and go immediately to the  next one.
  Others go to the next stage of ene-to-end logon only after the operator
  sends SSCP-LU  message to the  host. In either  case, the  operation of
  both terminal  and host interface  is exactly the  same as  for regular
  data transmission (see  below), that is essentially  transparent.  From
  the standpoint  of the network,  signon process is  already compeleted,
  but end-to-end signon may continue as follows.













  17                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


         3276            TIF                     HIF          3705
          |               |                       |               |
          |               |                       |<-- BIND ------|
          |               |<--- BIND -------------|    menu       |
          |<-- BIND ------|     menu              |               |
          |    menu       |                       |               |
          |               |                       |               |
          |- +RSP,BIND -->|                       |               |
          |               |---- +RSP,BIND ------->|               |
          |               |                       |- +RSP,BIND -->|
          /               /                       /               /
          |               |                       |<-data traffic-|
          |               |<--data traffic (menu)-|   or nothing  |
          |<-data traffic-|        or nothing     |               |
          |   or nothing  |                       |               |
          /               /                       /               /
          |-data traffic->|                       |               |
          |   or nothing  |-data traffic (menu)-->|               |
          |               |        or nothing     |-data traffic->|
          |               |                       |   or nothing  |
          /               /                       /               /
          |               |                       |<-- UNBIND ----|
          |               |<---- UNBIND ----------|     menu      |
          |<-- UNBIND ----|       menu            |               |
          |     menu      |                       |               |
          |               |                       |               |
          |- +RSP,UNBIND >|                       |               |
          |               |--- +RSP,UNBIND ------>|               |
          |               |                       |- +RSP,UNBIND >|
          /               /                       /               /
          |               |                       |<-- BIND ------|
          |               |<---- BIND ------------|  application  |
          |<-- BIND ------|    application        |               |
          |  application  |                       |               |
          |               |                       |               |


  Once a logon is entered to the host SSCP, an end-to-end BIND  is issued
  by the host.  Some hosts may send an application menu on  this session,
  and  UNBIND  the  menu  session before  making  a  BIND  to  the target
  application.













  18                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


         3276            TIF                     HIF          3705
          |               |                       |               |
          |               |                       |<-- UNBIND ----|
          |               |<---- UNBIND ----------|  application  |
          |<-- UNBIND ----|    application        |               |
          |  application  |                       |               |
          |               |                       |               |
          |- +RSP,UNBIND >|                       |               |
          |               |---- +RSP,UNBIND ----->|               |
          |               |                       |- +RSP,UNBIND >|
          /               /                       /               /
          |               |                       |               |
          |               |                       |<-- BIND ------|
          |               |<---- BIND ------------|    menu       |
          |<-- BIND ------|      menu             |               |
          |    menu       |                       |               |
          |               |                       |               |


  On completion  of the application  session, the application  UNBIND may
  result in a menu BIND.






              3.1.5  Data Flow


  Once the network call is completed, all LU-LU RUs are end-to-end.  This
  includes not only SNA requests but also responses. In fact,  almost all
  SNA FMD's and DFC's are sent end-to-end in native mode.






              3.1.6  Logging Off




  3.1.6.1  Application Logoff









  19                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


         3276            TIF                     HIF          3705
          |               |                       |               |
          |-- SSCP/LU --->|                       |               |
          |   logoff      |--- SSCP/LU logoff --->|               |
          |               |                       |--- SSCP/LU -->|
          |               |                       |     logoff    |
          |               |                       |<--- UNBIND ---|
          |               |<---  UNBIND ----------|               |
          |<--- UNBIND ---|                       |               |
          |- +RSP,UNBIND >|                       |               |
          |               |---- +RSP,UNBIND ----->|               |
          |               |                       |- +RSP,UNBIND >|
          |               |                       |               |
          |               |                       |               |


  For the  above case  the network circuit  is not  cleared. If  the user
  wishes to  clear the  network circuit,  he/she must  enter the  NSM and
  select the Network Logoff function.





  3.1.6.2  Application Logoff and Network Logoff

         3276            TIF                     HIF            3705
          |               |                       |               |
          |---  LU-LU --->|                       |               |
          |     logoff    |---   LU-LU logoff --->|               |
          |               |                       |---  LU-LU --->|
          |               |                       |     logoff    |
          |               |                       |<--- DACTLU ---|
          |               |<--- call cleared ---->|- +RSP,DACTLU->|
          |<--- UNBIND ---|                       |               |
          |- +RSP,UNBIND >|                       |               |
          |               |                       |               |
          |<-- BIND ------|                       |               |
          |   NSS menu    |                       |               |
          |               |                       |               |


  For  the above  case  when the  SSCP  deactivates the  LU,  the network
  circuit is also cleared.  See host interface operation for more details
  on logoff process.









  20                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


                       3.2  SNA/SDLC Host Interface







              3.2.1  Startup


  Startup procedure at  the host interface  follows the host  line enable
  process.   There  might  be  several  CU's  on  1  line,  but  they are
  independent from each other.  Typically the process will be  as follows
  (only 1 CU is shown):

                    HIF                    8150/3705
                     |                         |
                     |     <---- SNRM ----     |  Link level
                     |     -----  UA  ---->    |  set up
                     /                         /
                     |     <---- ACTPU ---     |  SSCP-PU
                     |     -- +RSP(ACTPU) ->   |  activatied
                     /                         /
                     |     <---- ACTLU ---     |  SSCP-LU
                     |     -- +RSP(ACTLU) ->   |  activated
                     |                         |


  The  HIF responds  to ACTPU  and ACTLU  from SSCP  with +RSP.   At this
  moment 1  port is made  available for signon  from the network  and the
  network  supervisor is  informed correspondingly.  As more  ACTLU's are
  coming from the host in a similar fashion, more ports become available.
  This principle (1 active LU = 1 network port) is adhered to through all
  activation  and deactivation  procedures (there  is one  exception, see
  "Application Timeout" for details).


  More messages could be sent by the host when an LU (device) is enabled.
  They may  have SSCP-LU  FMD's (containing banner  message) or  BIND (to
  start a  session for menu  screen).  The HIF  will refuse any  of these
  requests if  a network  circuit is not  established.  The  principle in
  this case is to equate "no network circuit" condition to "power off" or
  "not available" SNA sense codes.


  Follwing are 2 examples of possible continuations of  device activation
  process.






  21                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


                   HIF                     8100/3705
                    |                          |
                    |     <--- SSCP-LU FMD -   |   Banner message from
                    \                          \   host
                    |     ----  -RSP(0831) ->  |   Power off
                    |                          |


  Banner message  is sent on  SSCP-LU session in  this example.  The host
  will not send anything at all after -RSP from HIF.


                    HIF                   8100/3705
                     |                        |
                     |    <---- BIND ----     |   Start session for
                     \                        \   menu screen
                     |    - -RSP(BIND,080A) ->|   Not available
                     \                        \
                     |    <---- DACTLU --     |   Deactivate device
                     \                        \
                     |    ---- +RSP(DACTLU) - |   +RSP, 1 port less
                     \                        \
                     |    <---- ACTLU ---     |   Activate device
                     \                        \
                     |    ---- +RSP(ACTLU) -  |   +RSP, 1 more port
                     |                        |


  Deactivation and  subsequent immediate activation  is very  typical for
  various IBM SNA products (see logoff procedure for example).






              3.2.2  Logon


  When the  circuit is being  built the HIF  and TIF  exchage information
  according to X.25/DSP standards. This information allows HIF to map the
  connection  request  to  appropriate  LU  (see  DSP   documentation  on
  connection request modes). It also  tells the HIF what kind  of support
  will be required during normal data flow (native or DSP virtual).


  Now the HIF  tries to inform the  host of "circuit built  condition" by
  sending something  of "power  on" or "now  available" kind  of message.
  The goal is to solicit any welcome banner which was rejected when there
  was no circuit.  The following 2 examples correspond to the examples of
  disconnected condition in 4.2.1.



  22                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


        TYMNET      HIF              8100/3705
                     |                   |
   - network call -> |                   |
   <- call accepted -|                   |
   - device status ->|                   |
                     | -- LUSTAT(082B) ->|   Now available, screen
                     |                   |   destroyed
                     \                   \   HIF goes to end-to-end
                     |                   |   mode
                     | <-- +RSP(LUSTAT) -|   +RSP 
                     \                   \
                     | <- SSCP-LU FMD -- |   Host banner welcome


  Everything after +RSP(LUSTAT) is processed in  corresponding end-to-end
  mode (that is either sent  end-to-end as is in native mode  or stripped
  of SNA headers and enclosed in  DSP framing in virtual DSP mode).  As a
  matter of  principal, the  logon process  in finished  for HIF  at this
  point,  and the  banner  message is  processed as  described  below for
  regular data flow.


        TYMNET      HIF              8100/3705
                     |                   |
   - network call -> |                   |
   <- call accepted -|                   |
   - device status ->|                   |
                     |  -- dummy RU -->  |    Now available
                     |                   |    HIF end-to-end
                     |  <-- +RSP ------  |    +RSP
                     \                   \
                     |  <--- BIND ----   |    BIND for menu screen
                     |  -- +RSP(BIND) -> |    +RSP
                     | <-- data traffic -|    Menu screen


  Here  everything after  +RSP  for dummy  RU goes  through  regular data
  traffic  logic of  HIF.  Same is  true  for any  possible  data traffic
  necessary for  the host signon.  HIF (and TIF)  treats this  traffic no
  different than other data between terminal and host.






              3.2.3  Data Flow







  23                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  3.2.3.1  Native mode


  Almost no intervention with data traffic is preformed by  the interface
  in this  mode.  Segmented  LU-LU RUs  are sent  on the  network circuit
  without waiting for the complete RU.




  3.2.3.2  Virtual DSP mode


  See section 4.4 "SNA/DSP protocol convertor".







              3.2.4  Logoff




  3.2.4.1  Application logoff


  Two distinctly different procedures are involved in logoff  process: 1.
  End-to-end logoff; 2. Network logoff (tearing down the circuit).


  The  1st  one  is  normally  performed  the  same  way  as   in  native
  environment,  that  is  by keying  some  special  word  (like "logoff",
  "sysoff", etc.).   No deliberate attempt  to perform network  logoff is
  made in the interface if the user performs application logoff.


  However, some of  the host systems would  send DACTLU as part  of their
  logoff sequence.  The  virtual circuit will be  torn down in  this case
  according to the principle "active LU - active network port"  (see also
  "Application timeout").











  24                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


        TYMNET      HIF              8100/3705
                     |                   |
    -- logoff word ->|                   |
                     | LU-LU FMD logoff->|   Logoff keyword from user
                     | <--- +RSP ------- |   +RSP
                     \                   \
                     | <-- data traffic -|   Job summary, etc. from
    <-- data traffic-|                   |   host
                     \                   \
                     | <--- DACTLU ----  |   Deactivate
                     | ---- +RSP ----->  |   LU deactivated, port
  <- call cleared -> |                   |   zapped
                     | <---- ACTLU ----  |   Activate
                     | ---- +RSP ----->  |   LU activated, port
                     |                   |   available


  Circuit is cleared in this example solely due to the fact that the host
  sent DACTLU. See example in  4.1.6.1 for illustration of the  case when
  application logoff does not cause network logoff.


  The circuit will be cleared the same way if DACTLU or DACTPU comes from
  the host unsolicited.  The difference in this  case will be  that ACTLU
  will most likely not follow immedeately. The port will stay unavailable
  for network  logon until  ACTLU is  received from  the host  again (see
  Startup).




  3.2.4.2  Application timeout


  Application logoff  sequence described in  4.2.4.1 is very  typical for
  vaious IBM host products (TSO,  CICS, DPCX for example). For  all these
  cases application logoff will cause simultaneous network logoff  due to
  the fact  that the host  issues DACTLU in  logoff sequence.   This side
  effect of application logoff could be desirable for the user.


  However there might be cases when the user wants to retain  the network
  circuit  after  application  logoff.  A  special  feature  (application
  timeout)  is provided  for this  purspose. If  it is  used  the network
  circuit  is  retained if  DACTLU  is  followed by  ACTLU  and  the time
  interval between the two does not exceed the user specified application
  timeout value.







  25                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  3.2.4.3  Network logoff


  If network logoff is  not performed during application logoff  and user
  wants  to  break the  network  connection the  network  services screen
  should  be  used  (see  Network Services  Manager  for  native  mode of
  operation  or  corresponding sections  of  BSC3270 or  CMT  manuals for
  virtual mode).  Virtual Host Printer connection will  typically require
  this type of logoff.


  Invitation to clear coming from  the terminal iterface could be  at the
  moment  when the  application  end-to-end session  (LU-LU  session) was
  already  terminated  by  the user  issuing  application  logoff command
  before breaking the network  connection. There is nothing for  the host
  interface to do  but break the network  circuit in this case.   Same is
  true for the  printer session if the  circuit break happened  after the
  host transmitted  the whole  print file  and then  send UNBIND  for the
  printer session.


  However if LU-LU session is  still active the HIF must inform  the host
  of circuit  break in such  a way so  that LU-LU session  is terminated.
  This is accomplished by sending SNA TERM-SELF message to the host.

        TYMNET      HIF              8100/3705
                     |                   |
  <- call cleared -> |                   |
                     | --- TERM-SELF --> |   Inform the host
                     | <---- +RSP ------ |   +RSP
                     \                   \
                     | <---- DACTLU ---- |   Deactivate LU
                     | ----- +RSP -----> |   Ok
                     \                   \
                     | <---- ACTLU ----- |   Activate LU
                     | ----- +RSP -----> |   Port available again
                     |                   |


  Appcation end-to-end session is terminated in the host system and ready
  to accept the next logon from the user after this sequence.




  3.2.4.4  Abnormal break of connection, inactivity timeout


  Network connection  can occaionally break  in the middle  of end-to-end
  application  session.  The  host  is  notified  in  this  case  and the
  application  is  logged  off  the  same  way  as  desribed  in previous
  paragraph.


  26                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  As an option,  the HIF will  maintain inactivity timeout  selectable by
  individual LU.  When this timeout occurs, the HIF will  issue TERM-SELF
  and initiate the  process of tearing  down the network  connection. The
  procedure is again the same as described in previous paragraph.


















































  27                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


                       3.3  Network Services Manager



  This section describes the functions of Network Service manager for SNA
  native  mode  terminal  interface only.  See  corresponding  manual for
  Network Service description if other terminal interface is used.


  Printer support  functions are currently  limited to Virtual  Host Mode
  only. See the description of Network Service Manager in a corresponding
  TIF manual for  the detail on building  a printer virtaul  circuit. See
  also the chapter on special printer considerations for the functions of
  this interface in case of printer support.


  The Network Services  Manager provides user-friendly access  to network
  functions, such as network logon and logoff, through a set  of services
  screens.


  These screens are defined in the SNA TIF Tymfile.  A set of  screens is
  assigned to each individual logical unit, thus two logical units on the
  same controller may be assigned two different screen sets.






              3.3.1  Activating the Network Services Manager


  The NSM is active immediately  after a +RSP(ACTLU) is received.   It is
  also active after a network call is cleared.


  The NSM can  be contacted by the  user by entering  pre-defined keyword
  from the  SSCP owned screen  or by  a pre-defined PF  key from  the PLU
  owned screen.  The first screen  sent out by the NSM when  activated is
  the network services menu.




  3.3.1.1  Network Service Screen Functions


  The services menu provides the following functions:

    o chain to preset logon screen
    o network logoff
    o return to session

  28                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


    o chain to manual logon screen
    o chain to printer logon screen
    o chain to another services menu






              3.3.2  Manual logon screen


  The manual logon  screen provides a formatted  screen to guide  the the
  user to input proper network logon information.





              3.3.3  Preset Logon Screen


  The preset Logon  Selection Screen allows  user to select  desired host
  with  pre-defined   destinations. The  following   is an  example  of a
  Preset logon Screen. The entries on this screen are defined in  the TIF
  TYMFILE.


  -----------------------------------
  |   TYMNET SNA Interface  1.03    |
  |                                 |
  |                                 |
  | 1. Manual Logon                 |
  | 2. TSO                          |
  | 3. NY Stock Exchange            |
  | 4. Center 1                     |
  | 5. Center 2                     |
  |                                 |
  | Select Function:                |
  |                                 |
  |---------------------------------|













  29                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


              3.3.4  DSP information screen


  This screen asks user to provide further information for  attaching the
  LU to  the desired LU  on the host.  For information about  DSP, please
  refer to 3270 Display System Protocol document.


  CRM's 2 and 3 defined in DSP are treated identically. They  provide the
  capability to specify (if  necessary) destination CU and/or  LU address
  to be connected to. If  not specified, first available LU  within given
  host  (defined in  logon stream)  will be  selected in  HIF. If  any of
  destination addresses is  specified (CU and/or  LU) it will  be matched
  with polling address in HIF  (except when lables are used,  see below).
  Both of  them are represented  by 2  hex digits (1  byte). These  2 hex
  digits  should  be entered  on  DSP screen  if  specific  connection is
  desired.


  This mapping is unacceptable when BSC  or CMT is used as a  TIF because
  CU and device  addresses in BSC 3270  are one digit  graphic charaters.
  To compensate for this difference  one byte label could be  defined for
  every CU and/or LU in SNA HIF. If any of those labels are  defined they
  are used instead of polling addresses while matching CRM CU  and device
  information.


  If SNA TIF is used 2 hex digits corresponding to 1-byte label should be
  entered on DSP screen if specific request is desired and  connection is
  to  the  HIF  with  labels.   If TIF  is  running  BSC  or  CMT graphic
  characters should be used on  the screen (or stored logons). To  have a
  match the labels should also be griphics in this case.


  There is no requirement  for the labels to  be unique. If some  of CU's
  and/or LU's have  the same labels  they are treated  as a pool  for CRM
  purposes. CRM fields  are treated as  a pool name  to be signed  on to.
  Connection occurs with the first available device from the pool.


  For example, we may have 32  LU's on 1 CU, all capable of  running TSO,
  but only last 5 running TSO and CICS. The last 5 devices could be given
  a label (say, "A"), the rest have no label. In CMT TIF 2  stored logons
  are defined: a. non-specific, b. specific to device "A".  Then logon a.
  connects to the  first available device, logon  b.  connects to  one of
  the last 5 LU's.


  Labels can be also used for the selection of a printer in  Virtual Host
  Mode. See the chapter on printer considerations for more information.




  30                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  One of the elements of DSP information has no standard definition. This
  element is  appliction identifier.  Some interfaces  use this  field to
  request a specific line # to be logged in at the  destination interface
  (if wildcard selection does not satisfy the user).


  SNA  interface  uses  this  field  to  convey  2  different   units  of
  information:  user  class  and  line number  to  be  logged  in  at the
  destination.  Since  other  interfaces accept  only  graphics  as valid
  application ID's  only 6 low  bytes of this  1-byte field  are actually
  used to convey this information.



  The structure of this byte in SNA interface is CCUUWLLL where


     CC - graphic conversion bits to be found from the table below;

     UU - user class. Only 00 and 01 classes are currently defined. Class
         01  will override  whatever inactivity  timeout was  defined for
         host interface to no  timeout for this connection. 00  will have
         timeout defined at HIF;

     W  - if set  to 1 means  that next  3 bits will  be used  to request
         specific  line number  at destination.  Otherwise  wildcard line
         selection is assumed;

     LLL- if  W=1 defines  line number  to log  in at  destination (0-7).
         Otherwise these bits are ignored.



  For stored logon the same charcter must be sysgened rather than entered
  from screen.


  If a  non-graphic character is  sysgened as application  ID it  will be
  converted to 00  (null character) and sent  to the host. 00  user class
  and wildcard line selection will take place in this case. Same  is true
  if other interfaces  (BSC3270 ot CMT)  are used as  terminal interface.
  This concerns also "8D (CR) charater recomended for wild card selection
  in documentation for these other interfaces.











  31                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


                          GRAPHIC CONVERSION TABLE


  6-bit value   EBCIDIC  ASCII  Graphic   User class    Line selection


  00 0000         40      20     blank        00           Wildcard
  00 0001         C1      41       A          00           Wildcard
  00 0010         C2      42       B          00           Wildcard
  00 0011         C3      43       C          00           Wildcard
  00 0100         C4      44       D          00           Wildcard
  00 0101         C5      45       E          00           Wildcard
  00 0110         C6      46       F          00           Wildcard
  00 0111         C7      47       G          00           Wildcard


  00 1000         C8      48       H          00           Line 0
  00 1001         C9      49       I          00           Line 1
  00 1010         4A      5B       |          00           Line 2
  00 1011         4B      2E       .          00           Line 3
  00 1100         4C      3C       <          00           Line 4
  00 1101         4D      28       (          00           Line 5
  00 1110         4E      2B       +          00           Line 6
  00 1111         4F      21       !          00           Line 7


  01 0000         50      26       &          01           Wildcard
  01 0001         D1      4A       J          01           Wildcard
  01 0010         D2      4B       K          01           Wildcard
  01 0011         D3      4C       L          01           Wildcard
  01 0100         D4      4D       M          01           Wildcard
  01 0101         D5      4E       N          01           Wildcard
  01 0110         D6      4F       O          01           Wildcard
  01 0111         D7      50       P          01           Wildcard


  01 1000         D8      51       Q          01           Line 0
  01 1001         D9      52       R          01           Line 1
  01 1010         5A      5D       ]          01           Line 2
  01 1011         5B      24       $          01           Line 3
  01 1100         5C      2A       *          01           Line 4
  01 1101         5D      29       )          01           Line 5
  01 1110         5E      3B       ;          01           Line 6
  01 1111         5F      5E       ^          01           Line 7



  Note: some of the graphics  in this table might be  different depending
  on the keyboard used.


  Values not in the table are currently reserved.


  32                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


              3.3.5  Printer logon


  Printer  support  in  Native Mode  is  currently  not  implemented. See
  printer logon information in corresponding TIF manuals for Virtual Host
  Mode of operation.
















































  33                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


                      3.4  SNA/DSP protocol convertor






              3.4.1  Data transfer from host to terminal


  Only  requests of  FMD category  are converted  to DSP  and transmitted
  through the network.


  SNA  messages of  SC and  DFC categories  are handled  locally  by host
  interface except that COMMAND ABORTED indication (ENQ) is  provided for
  DSP  if CANCEL  was  received from  the  host. SNA  responses  are also
  provided locally by HIF.


  SNA chainig and segmentation protocols for FMD requests are mapped into
  DSP's trailing character in command  message (ETX, ETB or ITB)  or X.25
  M-bit.


  SNA chain is a set of  FMD RQ's starting with 3270 data  stream command
  byte.  This corresponds to one DSP command message which has ETB or ETX
  as the trailer byte.


  Therefore for the last SNA segment of last SNA chain element we have to
  specify ETX if change direction was also specified.  Either ETX  or ETB
  can be  used if  change direction was  not specified.   This is  a user
  option and it  may have some effect  on performance (TIF will  issue an
  extra  select if  only ETX's  are used),  but this  effect  is probably
  limited  (the  direction  is changed  most  likely  after  every screen
  anyway).


  SNA multi-element chains and segmants are mapped into X.25 M-bit if BSC
  does not allow transparency.  In case of transparency  multi-element RU
  chains could be  optionally mapped into ITB  (first but not  last chain
  element is first segment  ITB, intermediate is subsequent  segment ITB,
  last but not first  is subsequent ETB or  ETX, first and last  is first
  segment ETB or  ETX).  SNA segmentation is  still reflected in  X.25 M-
  bit.  Performance effect  of this option  should not be  significant if
  early data forwarding is employed by terminal interface.


  SNA brackets  received from  host are  treated the  same way  as change
  direction.  Additionally, there is an option to map end-of-bracket into
  DSP's ACK-bit.  Also,  SNA's end-of-bracket restores the  keyboard even


  34                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  if it  was not  done explicitly in  3270 data  stream. HIF  generates a
  dummy keyboard restore and sends it through the network in this case.


  One  additional  function  for  host  to  terminal  data   transfer  is
  conversion of SCS character streams which are used for FMD's on SSCP-LU
  session into corresponding 3270 character streams.  This  conversion is
  performed by  HIF if there  is no LU-LU  session when this  message was
  received from the host  (typically - host banner welcome).   If SSCP-LU
  data  message  came  during  LU-LU  session  it  is  discarded  without
  delivering  to terminal  and -RSP(082D)  (LU busy)  is returned  to the
  host.







              3.4.2  Terminal to host data transfer


  DSP RESPONSE consists of one or several segments, each of which in turn
  could be transmitted as several X.25 data packets. However  it contains
  only 1 3270  AID at the  beginning of 1st DSP  segment. On SNA  side we
  have for terminal  to host data transfer  only one FMD chain  (2 chains
  are possible if the first is LUSTAT). Multiple RU chains  are available
  or not as specified in BIND. Segmentation is available. Maximum RU size
  is specified in BIND.


  A segment in  DSP RESPONSE does not  exceed 256 bytes (including  a few
  bytes of header  and trailer information). On  the other hand,  RU size
  (as  specified in  BIND) is  never less  than 256.  This means  that if
  multiple RU chains are allowed  we can always map one DSP  segment with
  ETB as a  trailer into the first  or intermediate element of  RU chain.
  DSP segment with ETX could be mapped into last element of RU chain with
  change direction.


  This is actually  the conversion algorithm,  except that not  every DSP
  segment is mapped  into separate RU chain.  If RU size allows  for more
  data to be  put into the  same RU SNA  segments are used  instead. This
  should provide for better performance.


  If multiple  RU chains  are not allowed  on SNA  session all  ETB's are
  mapped into separate SNA segments.


  Segmentation is also used for mapping of X.25 M-bit. The net  result of
  such  mapping provides  for  early data  forwarding (that  is  the data


  35                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  message is  going through  the interface without  waiting for  the last
  byte of the message from the network).


  If the DSP RESPONSE ends with ENQ (that is aborted) SNA  CANCEL message
  is generated by host interface.


  There is one short-coming in this mapping process. Until the message is
  completely  received there  is no  way of  saying how  long it  will be
  (unless there is  only one DSP segment  there, in other words  the very
  1st segment  ends with ETX).  On the other  hand the  convertor program
  must specify chaining option in the very first SNA segment.  The result
  is that (if both chaining and segmentation were used) "not  last chain"
  will be specified very frequently even when "last chain" could  be used
  instead (if DSP  segment with ETX  had arrived earlier).  To compensate
  for this case a dummy RU with "last chain element" is  generated. There
  is some small loss of efficiency in such cases, but it should not cause
  any problems unless host application has a bug with handling this dummy
  RU.


  DSP RESPONSE's converted to SNA RU chains are sent to the host one at a
  time as soon  as all SNA  state machines maintained  by HIF will  be in
  send  state.  Every such  RU  chain specifies  change  direction. Begin
  bracket is specified if brackets  are allowed on LU-LU session  and the
  bracket state machine is in "between bracket" state. End of  bracket is
  never generated by host interface.


  There  are differences  between BSC  and SNA  treatment  of half-duplex
  exchange.   Possible contention  is resloved  by stacking  converted RU
  chains if SNA state machines do not allow to send them. Optionally, SNA
  SIG message can  be generated by the  interface with "request  to send"
  signal code. It appears however that some of IBM host  applications are
  not prepared to handle this SIGNAL in all conceivable cases.


  DSP STATUS  message is  converted to SNA  LUSTAT. Currently  all status
  codes are  converted to 082B  sense code (presentation  space integrity
  lost).  The same  LUSTAT message is  generated for some  error recovery
  procedures initiated by host interface.


  As in case  of host to terminal  data transfer host  interface converts
  3270 to SCS character stream if LU-LU session does not exist (typically
  during end-to-end signon).







  36                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


              3.4.3  3270 SYS/REQ Function Key Emulation


  The 3270 system/request function key is emulated by the coupled CMT TIF
  and SNA HIF.  The SYS/REQ function key is supported by the CMT  4.00 or
  later and the SNA 1.05 or later version.


  The SYS/REQ key is entered by an end user from the keyboard  to request
  a session change between the  LU-LU session and the SSCP-LU  session or
  between the unowned session and the SSCP-LU session.


  The SYS/REQ  key transferring  from the CMT  to the  SNA uses  the 3270
  command with 'F0' AID.  The message format is described as follows:

                  byte0    byte1    byte2    byte3
                +--------+--------+--------+--------+
                |   F0   |  SEQ#  | STATUS |   ETX  |
                +--------+--------+--------+--------+

          SEQ#   - 7E or 7F.
          STATUS - 40 (CMT currently displaying unowned session)
                 - C1 (CMT currently displaying SSCP-LU session)
                 - C2 (CMT currently displaying LU-LU session)
                 - C3 (CMT currently displaying force unowned session)


  The SYS/REQ key ack. transferring from the SNA to the CMT uses the 3270
  command with 'FF' AID.  The message format is described as follows:

                  byte0    byte1    byte2    byte3
                +--------+--------+--------+--------+
                |   FF   |  SEQ#  | STATUS |   ETX  |
                +--------+--------+--------+--------+

          SEQ#   - 40 (host initiates the session transaction)
                 - 7E or 7F (SYS/REQ key response)
          STATUS - 40 (current session is unowned)
                 - C1 (current session is SSCP-LU)
                 - C2 (current session is LU-LU)
                 - C3 (current session is force unowned)
                 - C4 (session error)











  37                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


                         3.5  Virtual Host Printer




  Printer device is recognized from CRT by SNA host interface by LU type.
  For 3270 oriented sessions the procedure attaching a device  checks for
  LU  type 2  (if device  is CRT)  or type  3 (if  it is  printer).  This
  information is contained in LUCB.


  The support of printer in virtual host mode is concentrated in 2 areas:
  1. LU service manager (presentation service); 2. Network I/O procedures
  (mapping  of DSP  information and  attaching a  device).   This chapter
  deals with both aspects of printer support in turns.







              3.5.1  LU type 3 support for Virtual Host printer





  3.5.1.1  Logon processing


  The main consideration for LU service during network logon is to notify
  the IBM  host that  the connection  is now  available to  establish (if
  necessary) an LU-LU session for transmission of print data.


  The logic for LU type 3  is different from what was described  in 4.2.2
  only in one respect, namely no SSCP-LU is ever sent to the host.  SSCP-
  LU LUSTAT(082B) is sent instead.





  3.5.1.2  End-to-end operation


  The end-to-end operation for LU type 3 is basically the same as  for LU
  type 2.  Following are the exceptions to this rule.





  38                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  No SSCP-LU  messages will be  accepted from the  host. Should  any such
  message  arrive, it  will be  rejected with  -RSP(1007) -  category not
  supported.



  After receiving a complete RU  chain from the host, the  interface will
  generate  RSP  as  required  (see below  the  cases  when  -RSP  can be
  generated). In case of +RSP and change direction from the host, it will
  be immediately  followed by  LUSTAT(0002) - no  data to  transmit, with
  change direction.







              3.5.2  Network I/O procedures for printer support



  Network  I/O  procedures for  VHP  (Virtual Host  Printer)  support all
  standard connection request modes (CRM's) provided by DSP  protocol. It
  is assumed that terminal interface uses one of these modes when printer
  signon is performed.


  The essence  of connection process  reflected in CRM's  is to  give the
  terminal operator some  freeedom to either  choose a specific  line, PU
  and LU combination during signon  or to be sign on the  first available
  LU.  Intermediate  case  when  user  supplies  only  1  or  2  of these
  parameters and leaves the rest to random choice should be considered.


  The connection  process has a  special significance for  printer signon
  because  the user  will normally  route a  print report  to  a specific
  printer which is the same as specific LU at the host.



  Another possibility is that a  printer (or a set of printers)  might be
  associated with  a terminal (or  a set of  terminals) for  some natural
  reasons.  Say,  these  could  be printers  and  terminals  on  one 3270
  controller or printer connected  to ASCII terminal via  auxiliary port.
  If  the user  knows what  host port  he is  using for  CRT, he  can use
  specific  host  port for  the  printer signon  too.  Otherwise,  he may
  request a printer "associated" with this CRT and this is what  CRM4 has
  to accomplish.





  39                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  The host interface contains the following means to describe  a specific
  line, CU (PU)  and device (LU)  and associations between  terminals and
  printers.



  Application ID in CRM information can be used by TIF user to  request a
  specific line number (see 4.3.4 for details of application ID structure
  in SNA HIF).



  PU number and origination LU  number could be used in HIF  for specific
  requests for CU and/or  device number. However, BSC and  SNA convention
  differ in this respect. Also, BSC-oriented TIF's allow only for graphic
  charaters for this purpose.


  For this reason,  LABEL macro's were introduced  in SNA HIF.  They give
  means to define  an arbitrary 1-character label  for any PU  and/or LU.
  Labels are not necessarily unique (that is, they could be the  same for
  different PU's and/or LU's). The  general rule is that if at  least one
  LABEL  macro is  defined  in the  interface, DSP  PU/LU  information is
  matched by label rather than PU/LU number.


  For the  purposes of  VHP, only label  approach is  useful and  will be
  considered in this chapter.





  3.5.2.1  CRM1 usage



  All  3 parameters  must be  given by  TIF user  if CRM1  is  chosen for
  signon. Application ID must  be constructed in accordance with  SNA HIF
  rules.


  More than 1 LU can satisfy the match on all 3 values if labels for PU's
  and/or LU's are not  unique. First available LU satisfying  the request
  is assgned in this case.


  A check is  performed on device type  during the LU assignment.  If the
  device type indicated  in CRM information is  CRT, LU type 2  device is
  assigned. If a printer device is indicated, LU type 3 will be assigned.




  40                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  3.5.2.2  CRM2 and CRM3 usage



  All considerations for  CRM1 are valid for  CRM2 and CRM3 except  it is
  not required to give all  three signon parameters. Those which  are not
  given  will come  to SNA  HIF as  0. Only  non-zero parameters  will be
  matched in this case.


  As in case of  CRM1 more than one  device could be available  and match
  the request. The first available is assigned in this case.



  CRM2 and CRM3 are imlemented identically in SNA HIF.





  3.5.2.3  CRM4 usage - to be implemented in version 2.00



  CRM4 is used  to connect "associated device".  In SNA HIF, it  could be
  used to connect printer.



  Certain  things must  be  done during  sysgen to  make  CRM4 processing
  possible. Namely,  a printer (or  printers) must be  somehow associated
  with a terminal (or  terminals). Current code will associate  a printer
  (or  printers) with  a terminal  (or terminals)  by giving  all devices
  associated in one group the  same LU label. It is understood  that this
  association  may be  somewhat restrictive  (say, it  does not  allow to
  associate 2 differently labeled  terminal LU's with 1 printer  LU). But
  it  is wide  enough  and does  not  require additional  tables  for the
  information about associations.



  Another  thing  which is  done  in SNA  HIF  code for  CRM4  is sending
  Additional  Destination  Designator  to TIF  in  CIRCUIT  ENABLE packet
  whenever a CRT connection is established with the use of other CRM's.


  Addtional Destination Designator  in SNA HIF consists  of 1 to  3 bytes
  (depending  on sysgen).  The  structure is:  LU label,  PU  label, line
  number (in this order). If less than 3 bytes are allowed by sysgen only
  first bytes are sent to TIF.



  41                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  When  TIF  originates  printer  signon  with  CRM4  it  sends  back the
  Additional Destination Designator (which was received and  saved during
  CRT signon) in CALL CIRQUIT REQUEST packet.


  Depending on the number  of bytes of Additional  Destination Designator
  received, SNA HIF will choose a printer with the same LU label,  or the
  same  PU and  LU label,  or the  same line  number and  PU/LU  label as
  Additional Destination Designator requires.  If more than 1  printer is
  associated whith this line  number and labels, first  available printer
  matching the request will be assigned.







              3.5.3  Special functions of VHP





  3.5.3.1  Handling of backpressure and other printer delays



  Printer  devices  may  generate long  delays  due  to  an "intervention
  required"  condition,  out  of paper,  for  example.  It  is important,
  therefore to handle various backpressure conditions without losing data
  intergrity.



  Data intergity is maintained in  SNA on SNA chain basis. Any  chain can
  be rejected with -RSP and then resent by the host.


  Another (and probably better) way to maintain the data integrity  is to
  send no  RSP for the  current chain if  the delay with  transmission of
  previous chains occurred.


  Both methods  of flow control  are implemented in  SNA HIF.  The choice
  should  be done  during the  SYSGEN. The  second (no  RSP)  approach is
  preferred if the host application can tolerate indefinitely long delays
  with SNA  +RSP. It should  be noted that  -RSP can also  cause problems
  (like UNBIND of the printer session) for some applications.  The option
  depends therefore on the host application to be used with this HIF.




  42                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  SNA HIF determines  the delay condition by  checking the status  of the
  data queue between SNA and Network I/O modules of the interface.


  In case of flow control with  no RSP/+RSP the RSP is delayed  until the
  last segment of the  current RU chain is  picked up by Network  I/O and
  excluded from the queue.


  In case of flow control with -RSP, the queue is checked when  the first
  segment of the chain arrives from the host. If it is not empty  -RSP is
  sent  to the  host and  the whole  chain is  discarded. When  the delay
  clears LUSTAT(available) is sent to the host.



  The following sense codes are available to send to the host  should the
  backpressure requires to reject a chain with -RSP.


  If the chain  starts a bracket -RSP(0814)  could be used. It  should be
  followed by RTR  when the backpressure clears.  This sense code  is not
  implemented.  The condition  is  treated the  same  way as  if  it were
  inside-bracket condition.


  If the chain to be rejected arrives in inside-bracket state,  the sense
  code is 0802 - intervention required.  When the  backpressure condition
  clears LUSTAT(0001) should be sent to the host.





  3.5.3.2  Printer copy initiated by host



  The  host can  initiate  a CRT-to-printer  copy function  by  sending a
  corresponding request to 3270.  This request is very different  for BSC
  and SNA sysgenned 3270s.



  In BSC environment there is a special copy command which is sent to the
  "to"  terminal  device  and contains  the  address  of  "from" terminal
  device. It is not clear whether a partition can be copied.



  In SNA  environment the printer  copy is initiated  by sending  a write
  request to CRT with WCC start printer bit turned on.


  43                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  The copy request is executed at the completion of write operation.


  Start printer can be also placed in the last staructured field.


  "To" device is not specified in SNA environment. Any printer configured
  on the CU  and available at  the moment can  serve as "to"  device. The
  host has no control over the selection of printer.



  SNA HIF scans the  FMD's received on LU  type 2 session for  Write type
  commands (including  Write Structured Field).  If start printer  bit is
  turned on in Write type  command's WCC or in OUTBOUND 3270DS  for Write
  Structured field, the search for  a printer circuit is started  at HIF.
  This must be  LU type 3  connected by Virtual  Circuit to the  same TIF
  (that is originations host number) and same origination CU as LU type 2
  FMD with start printer bit  on. If such circuit is available  the check
  is done whether LU-LU session exists for the LU type 3 and  the session
  is in "in-bracket"  condition. If not, the  printer is found and  a BSC
  Copy Command is generated and sent to TIF on the printer circuit.


  If the  latter condition  exists the printer  is considered  short term
  busy.  If  the  right  printer circuit  is  not  found  the  printer is
  considered not available. In both  cases -RSP is sent to the  host with
  corresponding sense code and the FMD is sent to CRT.



  The following sense codes are used for copy function:


  082F - no printer available (no printer circuit found);


  0807 - susidiary printer is busy (in-bracket state).



  The timing of copy function (before or after the screen update)  is not
  guaranteed in this implementation.











  44                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


                           3.6  Terminal Dial Up




  As illustrated in  following figure, the SNA  TIF, coupled with  an RS-
  232-C/V.24  compatible modem,  will be  able to  answer,  maintain, and
  disconnect calls from a circuit-switched network.  These functions will
  be provided  by the SNA  TIF through the  management of  modem signals,
  inactivity timers, and error recovery counters/timers.


       |-------|               *******                    *******
       | 3274  |              *       *                  *
       |  CU   |  |-------|  * circuit *                *
       |       |--| modem |==* switched *             |-----|
       | LU.T2 |  |-------|  * network  * |-------|   | SNA | 
       | PU.T2 |              *        *==| modem |---| TIF |
       |-------|               ********   |-------| ^ |-----|
                                                    |   *
                                                    |    *  Tymnet
                                          RS-232-C/V.24   *    
                                                           *******



  The SNA TIF will be able  to simulate some of the characteristics  of a
  modem through the use of a crossover cable, as illustrated in following
  figure.


                                 ***********
          |-------|             *
          | 3274  |          |-----|
          |  CU   |          | SNA |   
          |       |----------| TIF | 
          | LU.T2 |    ^     |-----|
          | PU.T2 |    |        *     Tymnet
          |-------|    |         *
                       |          **********
                       |
                  crossover cable
                  ASC-140-20











  45                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


              3.6.1  Constraints



  The features described for dial-up support apply to the SNA TIF only.


  Only  point-to-point  Two-Way  Alternate  link  configurations  can  be
  configured with modem signalling.


  Only  Logical  Unit  Type  2 and  Physical  Unit  Type  2  devices will
  initially  be  supported.    The  dial-up  feature  will   be  designed
  independent  of Logical  Unit types.   Therefore, as  new  Logical Unit
  types are added, dial-up support will also immediately be available.


  For modem simulation, the SIO hardware provides a 7200 bps clock speed.


  Modem signals are  scanned every half-second.  The  SNA TIF thus  has a
  worst-case response  to a  change in modem  signals of  approximately a
  half-second.


  Timing  parameters  for  modem signalling  are  defined  for  all lines
  configured in a slot.


  SDLC XID (Exchange Station Identification) frames are not supported.







              3.6.2  Signalling Protocol



  The  SNA TIF  uses  two RS-232-C  (V.24) signals,  Data  Terminal Ready
  (DTR),  and Data  Set Ready  (DSR)  on a  dial-up line  to  control the
  establishment and clearing of calls.  DTR is controlled by the SNA TIF,
  DSR is controlled by the modem.


  If  the line  is half-duplex,  RTS/CTS handshaking  is  required before
  sending the first SDLC frame  right after  line  is turned  around from
  RCV mode to XMT mode.




  46                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  When the SNA TIF is initially loaded or restarted DTR is dropped for at
  least 15  seconds to force  any existing calls  to be cleared.   DSR is
  subsequently monitored every half-second.  Note that it is possible for
  DSR to be up  (or down) at worst  case nearly a half-second  before the
  SNA TIF will notice the change.


  DSR must be  raised for a configurable  period of time, defaulted  to 2
  seconds, before the SNA TIF will consider DSR to be active.   This time
  period, which applies to all dial-up lines in a slot, is  controlled by
  the variable ONTIME.


  DTR is dropped within a half-second after DSR is dropped by  the modem.
  DTR is  held down  for a configurable  period of  time, defaulted  to 5
  seconds, before being raised again.  This time period, which applies to
  each individual dial-up line in a slot, can be adjusted by  coding  the
  LDSCTM macro.







              3.6.3  Disconnection



  Disconnection is accomplished when the SNA TIF drops DTR.   This causes
  the modem to go  on-hook, which clears the  call.  At the same  time as
  DTR is dropped, the SNA TIF clears all active network virtual circuits.


  The  conditions under  which  the SNA  TIF  will drop  DTR  include the
  following:

     o whenever the modem drops DSR

     o if link level becomes inactive, i.e. no information frames
       are exchanged for a pre-determined period of time

     o when configured SDLC link level error recovery retry limits
       are reached.










  47                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


                         3.7  Virtual Host Reflect




  This section describes the principles of operation of the  Virtual Host
  Reflect (VHR)  function, implemented in  the SNA Host  Interface (HIF).
  This description will include a product overview,  functional overview,
  the circuit building procedures,  the SNA/DSP mapping, and  special SNA
  considerations  such as  SSCP-LU handling.   VHR will  be  available in
  version 2.0, October 1986.







              3.7.1  Product Overview



  Microdata  has  requested project  development  to allow  IBM  SNA 327x
  display stations, attached to an SNA network, access to Microdata ASCII
  hosts  via  TYMNET.  The  primary  requirement is  for  a  327x display
  station to appear  as a PRISM terminal  operating in RMODE to  the host
  application.



  To satisfy this request, the  current SNA Host Interface (HIF)  will be
  enhanced  by adding  the VHR  function,  a  new  Microdata-written VTAM
  application will be written and  a new product called a  Character Mode
  Host Server (CMH) will be developed.



  The combined action of the new VTAM application (VTAM  Reflect program)
  and VHR function will appear to CMH as an SNA or Bisync (BSC)  Terminal
  Interface (TIF) which supports  Display System Protocol (DSP).  The CMH
  Server will convert the data stream from 3270 to ASCII and pass it to a
  TYMNET ASCII Host Interface (such as TYMCOM). TYMCOM will be  linked to
  the Microdata Reality.  This topology enables  a 327x, having  a native
  connection  to an  IBM  host, access  to  the Microdata  ASCII  host by
  signing on to  the special VTAM  Reflect application. Other  ASCII host
  connections should be possible if implemented in CMH.



  Any TYMNET  DSP HIF  (specifically SNA and  BSC 3270)  will be  able to
  communicate with VHR providing a wide variety of 3270 interconnections.



  48                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


              3.7.2  Functional Overview



  The Virtual  Host Reflect  Function (VHR) will  run as  part of  an SNA
  Virtual Host Interface. It will be compatible with other Host Interface
  options and will be sysgenned on a per LU basis.



  SNA/SDLC protocols  will be  LU.T2 sessions between  the primary  LU in
  PU.T4/T5 (represented by the VTAM reflect program) and the secondary LU
  in PU.T2 (represented by the TYMNET SNA HIF). The only  difference from
  the regular LU.T2  connection will be  on the presentation  level which
  will use 3270  outbound data stream in  the inbound direction  and 3270
  inbound data stream in the outbound direction.



  The Network I/O level will look as  if it was a TIF rather than  a HIF.
  This  includes  such  important  functions  as   circuit  building  and
  implementation  of  the DSP  protocol.  The DSP  support  would involve
  DSP/SNA chaining and segmentation  mapping.



  This  section  deals with  these  changes one  by  one,  discussing the
  problems and  their proposed  solutions. Printer  support will  also be
  considered  (mostly, it  is no  different  from CRT  as far  as  VHR is
  concerned).



  Proper  functioning  of  the Reflect  approach  depends  on coordinated
  actions between the developement  of VHR and the VTAM  Reflect program.
  This coordination  is performed by  adhering to the  exchange protocols
  specified below. These protocols require some additional information to
  be exchanged between VHR and  VTAM Reflect program (referred to  as VTR
  ).



  This additional  information could  be carried in  two or  three header
  bytes as  defined in  VTR DO. These  bytes are  meant to  imitate Write
  Command Code and WCC (from VTR to VHR) and AID and Cursor Address (from
  VHR to VTR).  Therefore,  we have six unused  bits of WCC (from  VTR to
  VHR) and twelve  unused bits of Cursor  Address (from VHR to  VTR). The
  suggested structure of these bits is described below.






  49                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


              3.7.3  Virtual Circuit Building



  VHR will be  capable of building  virtual circuits using  network logon
  and DSP information.



  Information necessary to  build virtual circuits  will be given  to the
  HIF during the logon exchange between HIF and VTAM Reflect program. The
  VTAM Reflect program may either have the logon pre-stored or taken from
  the 3270 logon screen.



   VTR   could  have the  pre-stored  logon information  or  it  could be
  supplied during manual stage-by-stage logon process.  In the first case
  all logon information is transmitted to VHR in one piece, in the second
  case it comes gradually.



  Regardless  of   which method for   supplying the logon  information is
  used, the  circuit building information   consists  of  network virtual
  circuit  information  followed  by  DSP  information.   Network virtual
  circuit  information  consists  of an   unspecified  number  of circuit
  building stages. These  stages correspond to  a piece of  circuit built
  between any two   TYMNET functional interfaces  such as between  an SNA
  HIF and CMH, or between CMH and TYMCOM.



  It should  be noted  that multistage logon  information is  typical not
  only when  VHR is communicating  with TYMCOM through  CMH,  but  when a
  circuit involves a  gateway.



  The format for the  logon information during the first  virtual circuit
  stage is as follows:

          username[:host#][;password]
          
          Host# and password are optional.



  The format of the one and only DSP information element is as follows:





  50                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988



         CRM;CLDADR;APLID;DCU;DDEV;CLR;EXTATR


         CRM   - Connection    request   mode    (currently   1-4,
                 disregarded by CMH);


         CLDADR- called address  as defined  in X.25  Call Request
                 packet;


         APLID - Any 1-byte graphic,  could be used to  define the
                 type of ASCII host to CMH;


         DCU   - destination Control Unit, 1-byte graphic, ignored
                 by CMH;


         DDEV  - Destination device, 1-byte graphic, could be used
                 in conjunction with CLDADR by CMH;


         CLR   - color (Y/N);


         EXTATR- extended attributes (Y/N).



  This logon  information is  supplied by VTR  to VHR  in the  first RU's
  following BIND and SDT. The  VTR logon information comes to  VHR either
  complete, in one  (first) RU chain (  for VTR pre-stored case),  or one
  logon element at a time, waiting  for the reply RU from VHR  before the
  next logon  element is  sent (logon element  is either  virtual circuit
  stage or DSP).



  VHR tries to build a circuit or a piece of circuit corresponding to the
  received logon  element. VHR  responds with a  reply RU.  This response
  contains status information (success or failure), a possible prompt for
  the next  element (VC stage  or DSP) and   a network data  message (the
  latter two response  elements are only included  in case of  VTR manual
  logon).



  The logon  exchange consists,  therefore, of a  sequence of  logon RU's
  from VTR  alternating with  reply RU's  from VHR;  each sending  one RU
  chain at a time in  a half-duplex fashion. VTR can abort  this sequence


  51                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  at  any moment  by sending  UNBIND  (or DACTLU).  VHR can  abort  it by
  sending TERM-SELF or RSHUTD. Other SNA protocol requirements to support
  logon exchange are no different from the regular data exchange mode and
  are described later in this document.



  The logon scenario may proceed as follows:


                  VTR                                     VHR
                   |  ----        BIND              ---->  |
                   |  ----        SDT               ---->  |
                   |  ---- logon RU (network stage) ---->  |
                   |  <--- reply RU (ok, give next) -----  |
                   |  ---- logon RU (network stage) ---->  |
                   |  <--- reply RU (ok, give DSP)  -----  |
                   |  ---- logon RU (DSP info)      ---->  |
                   |  <--- reply RU (ok, logon end) -----  |


                  SNA responses are omitted in this scenario.



  Other  scenarios, including  logon aborts  and failures,  are possible.
  The formats of logon and reply RU's are as follows.



  Format of a logon RU (VTR to VHR):

     WCMD WCC [logon information]


     WCMD is hex F1 or F5 or anything else (disregarded by VHR);


     WCC fakes 3270 WCC and consists of the following:

        bits 0 and 1   Determined from IBM 6/8 bit translation table
                       (disregarded by VHR),

        bits 2-5       reserved,

        bit 6 -        Override VHR pre-stored logon information (1 -
                       zap PVC-type circuit and use  VTR  information,
                       0 - error if VHR has a pre-stored information),

        bit 7          VTR manual/pre-stored (1 for manual, 0 for  pre
                       -stored);



  52                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  For VTR pre-stored logon, one RU chain would contain the complete logon
  information. One logon element would be present for VTR manual logon.



  Complete logon information is sent in the format


     VC stage,VC stage, ... ,VC stage!DSP element


     Any of these elements for the complete logon information
     could be omitted.



  Logon elements are transmitted in EBCDIC, no orders or other  3270 data
  stream insertions except for graphics are allowed.



  Reply RU's format (from VHR to VTR):



  EAID CADR1 CADR2 ERCDE [network data message]



  EAID is hex 7D (or anything else to fake AID);



  CADR1 consists of the following:


         bits 0-1-determined from IBM 6/8 bit translation table,


         bits 2-4-reserved,


         bit 5   -Continue/completed  (0  - logon  completed,  1 -
                 give  next logon  element,  always 0  in  case of
                 unrecoverable error or VTR-prestored),


         bit 6   -VC stage/DSP (0 - for VC element, 1 - for DSP),


         bit 7   -Enter  half/full  duplex  mode  of transmission,
                 valid  only  if  logon  completed  (bit  5  zero)


  53                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


                 successfully   (ERRCDE=0),   1   -   full  duplex
                 transmission, 0 - half duplex transmission.



  CADR2 carries SNA protocol  information and is described later  in this
  document;



  ERCDE is a binary value for error code which is defined as follows:


     0 - success,

     1 - Bad username (all last stage logon information to be  retyped in
         case of manual logon),

     2 - Bad password (only password could be changed during retry),

     3 - circuits busy (try again),

     4 - Host not available (problem with TYMNET destination interface or
         wrong host number,

     5 - host out of ports,

     6 - host down,

     7 - access not permitted,

     8 - insufficient information to build circuit,

     9 - incorrect VHR logon override,

     0A -problem with DSP information (followed by text).



  For error codes (ERCDE) 1 through 3, VHR will retry the  logon process.
  An UNBIND should  be sent by  VTR to VHR in  case of other  error codes
  (VHR will abort  the logon anyway).   Transfer to normal  data exchange
  state occurs when  ERCDE is 0  and the logon  complete bit in  CADR1 is
  set.



  Any network data messages will  be discarded in case of  VTR pre-stored
  logon.  In  case of manual  logon data messages  will be  translated to
  EBCDIC. All necessary  3270 commands and  orders (Write, WCC,  SBA, SF)
  will be attached to the message,  so that it may be output to  the 3270
  as FMD RQ (TH and RH to be attached by VTR to present RU chain with the


  54                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  same chaining indicators as the reply RU in which this data  message is
  sent  by  VHR).   The  only  piece  of  information  needed   for  this
  translation  is the  line  number on  the  screen to  start  the output
  message. This will be given to VHR as a SYSGEN parameter.


















































  55                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


              3.7.4  SNA/DSP protocol and mapping functions



  All DSP exchanges, including  logon procedures and data  transfer, will
  be  reversed. That  is VHR  will be  using the  terminal  interface DSP
  instead  of  the  host  interface  DSP  functions.   All  DSP  protocol
  (including logon procedure and data exchange) will be reversed; that is
  the  Reflect  Function in  VHR  will be  using  Terminal  Interface DSP
  protocols.



  The SNA/DSP Virtual Host mapping (as described in this document),  will
  be replaced  with a new mapping process for the LU's performing  in the
  Reflect  mode.  This new  mapping  process is  similar  to  the Virtual
  Terminal Interface (VTI) mapping, accept that VHR is mapping to primary
  station  on the  SDLC line,  where as  VTIU is  mapping to  a secondary
  station on the SDLC line.



  VHR  will appear  to  the network  as a  DSP  TIF. This  allows  VHR to
  communicate with any DSP  HIF (including the CMH Server).  DSP multiple
  user  circuits  will not  be  supported (similar  to  any  other TYMNET
  product).  The following subsections explain in detail the VHR mapping.





  3.7.4.1  SNA/DSP mapping for host-terminal data transfer



  The following considerations and restrictions apply for  this direction
  of data transfer.



  The data will be coming  from HIF enveloped in DSP command  headers and
  trailers. The overall length of  a command does not exceed  3000 bytes.
  Commands could be  chained by an ETX/ETB  trailer. A DSP command  has a
  standard  DSP header  followed  by a  valid outbound  3270  data stream
  command (like Write, Erase/Write, etc.).  There is one 3270 command per
  one DSP command.



  DSP commands travel through  TYMNET in X.25 packets (connected  by X.25
  M-bit). Each  packet could  be split  into a  few TYMNET  data messages
  (see TYMNET SNA IIX documents for the details).


  56                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  The protocol used to transmit  data from VTR to VHR will  be compatible
  with  the SNA  LU.T2  secondary  protocol.  To  accomplish  this, three
  header bytes (EAID, CADR1, CADR2 as described above for logon  reply RU
  format) will be attached right before 3270 data stream command  to form
  an SNA RU  (one such header  per every DSP  command). This is  the only
  modification  on  the  presentation  level.   The  format  of  CADR2 is
  described later in this section.



  SNA TH and  RH headers will also  be created and attached  right before
  the RU. The bits to be set during this process are BC and EC (Begin and
  End Chain Indicators),  BB and EB (Begin  and End Bracket),  CD (Change
  Direction) and BIU and EIU (Begin and End segment).



  Out  of  these  bits EB  is  always  0 for  the  secondary  because the
  secondary can not end  the bracket for LU type  2. BB will be set  to 1
  (Bracket started) if the session  is not in bracket when VHR  sends the
  RU to VTR. Otherwise BB will be set to 0.



  Begin Chain (BC)  bit will be  set on if and  only if VHR  received the
  beginning of the new  DSP command. The important consideration  here is
  that only one 3270 command is  allowed per RU chain and it must  be the
  fist byte of the RU (similar to DSP command).



  End Chain (EC) and  segmentation bits in the  TH do not have  any rigid
  requirements for DSP/SNA mapping.  From the SNA standpoint it  does not
  matter how the chain is split into RU's and RU's into segments  as long
  as RU and segment lengths do not exceed certain values. The  maximum RU
  value for secondary to primary direction is defined in the  BIND. Also,
  multiple element RU chains could be disallowed in BIND  altogether. The
  size of the segment is limited by the size of  the SDLC frame.



  For this reason  it is unimportant  to have any  correspondence between
  the way the DSP command is  split into X.25 and TYMNET packets  and the
  way SNA RU  chain is split into  chains and segments. The  algorithm of
  mapping  will try  to keep  segments and  RU's close  to  their maximum
  sizes, but also leave some room there for the next TYMNET packet (if it
  is expected) so that the mapping code is not over complicated.



  Mapping of one DSP  command into one RU  chain is only possible  if the
  BIND parameters are set properly.  One DSP command is up to  3000 bytes


  57                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  long. This means either multiple RU chains should be allowed in BIND or
  RU size should be no less than 3000.



  Change Direction (CD) indicator controls the direction  of transmission
  in Half Duplex Flip-Flop  mode. An LU type  2 performs in this  mode of
  operation while  in-bracket state.  We will  assume therefore  (for the
  duration of discussion on Change Direction) that VHR/VTR session  is in
  "in-bracket" state (see also the section on Half/Full  Duplex operation
  later in this section).



  In a typical 3270 environment, the application will use  Flip-Flop mode
  in the following  manner. The host application  paints the screen  as a
  whole or piece-by-piece  issuing one or  more 3270 Write  commands (one
  per RU chain). Change direction is specified only in the last  of these
  chains.  Until this happens, input from the keyboard is inhibited.



  Once the direction is changed  (and keyboard unlocked by WCC  or Reset)
  the user makes his  or her keystrokes and  hits one of the  enter keys.
  The direction is  changed at this moment.  The important point  is that
  there is only one enter action for (possibly) a few write commands.



  Correspondingly, SNA LU type  2 protocol allows an unlimited  number of
  RU chains in the host to terminal transmission before  Change Direction
  is  specified by  the  host. However,  every  RU chain  going  from the
  terminal to the  host (except DFC chains  which is unimportant  for the
  purpose of this discussion) must specify Change Direction.



  Typical native data exchange may look as follows:


                  370                                     3270
                   | ----- RU chain, RH(-CD), Wrt ---->    |
                   | ----- RU chain, RH(-CD), Wrt ---->    |
                   | ----- RU chain, RH(CD), Wrt  ---->    |
                   | <---- RU chain, RH(CD), Entr -----    |



  The screen is  painted with 3 Write  commands, first two have  -CD. SNA
  responses are omitted.




  58                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  Returning to VHR, it must specify Change Direction at the end  of every
  RU chain because  it imitates terminal to  host direction and  must act
  according to secondary-to-primary LU type 2 protocol.



  However,  this  does not  mean  that this  Change  Direction  is really
  desirable at this  moment. Moreover, if the  data coming from  the host
  interface (like CMH) comes  in several RU chains (several  3270 Writes)
  there will be a problem.



  It could be argued that CMH could be implemented in such a way  so that
  it does not  use multiple Writes (waits  for "input sequence"  and only
  then writes, see CMH  documentation for more details).  However,  it is
  undesirable for performance purposes.  It is also dangerous to  try and
  put all screen data in one DSP command because the limit of  3000 bytes
  could be exceeded if CMH tries to paint a piece of screen as soon as it
  is received (especially for scrolling applications).



  Running applications on SNA or BSC host would also become impossible.



  Therefore, the Change Direction Indicator specified in the RH should be
  used only  to satisfy SNA  and VTAM requirements.  The real  control of
  Flip-Flop mode should be indicated separately, for example in CADR2.



  The following format is suggested for CADR2:


         bits 0-1-determined from IBM 6/8 bit translation table;


         bits 2-6-reserved;


         bit 7   -Change  Direction (1  - last  RU chain  for this
                 direction, 0 -  more RU chains in  this direction
                 are forthcoming).



  The  actions  between VTR  and  the 3270  upon  receiving  these Change
  Direction  bits are  not described  in this  document.    However, this
  information should be enough  to maintain Half Duplex control  of 3270.
  Conceivably, VTR could  copy the Change  Direction (CD) bit  from CADR2


  59                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  into the RH of the message being sent to 3270. This way multiple Writes
  should become possible for VTR/3270 communications.



  However,  for  VTR/VHR   communications  multiple  Writes   require  an
  additional action on the part  of VTR. After the direction  was changed
  by VHR during the first Write, VTR must help VHR to restore its sending
  state  by  changing  send  direction  back  to  VHR  if  VHR  requested
  continuation in CADR2.  This could be achieved  by VTR sending  back to
  VHR a dummy (RH  only) RU indicating Change  Direction if bit 7  of the
  preceding CADR2 was  0. VHR will  be able to  send the second  Write to
  VTR.  VTR sends back a dummy  RU with CD if necessary, and so  on until
  CADR2 indicates Change Direction.



  Duplex states.



  One more consideration regarding  Change Direction, is how  VHR decides
  what is the right value for CD in CADR2. If DSP command has ETB trailer
  then continuation is definitely expected. CMH and SNA HIF's will have a
  definite  sign  from  corresponding  hosts  to  change   direction  and
  therefore will use ETX to indicate change direction to VHR.



  The example of the native data transfer above will look as follows:


                  VHR                             VTR
   DSP command     |                               |
   Wrt, ETB --->   |  ---- RU chain, RH(CD),       |
                   |       CADR2(-CD), Wrt   ----> |   RU chain, RH(-CD),
   DSP command     |  <--- dummy RU, RH(CD)  ----- |   Wrt   ---->
   Wrt, ETB --->   |  ---- RU chain, RH(CD),       |
                   |       CADR2(-CD), Wrt   ----> |   RU chain, RH(-CD),
   DSP command     |  <--- dummy RU, RH(CD)  ----- |   Wrt   ---->
   Wrt, ETX --->   |  ---- RU chain, RH(CD),       |
                   |       CADR2(CD), Wrt    ----> |   RU chain, RH(CD),
                   |                               |   Wrt   ---->
                   |                               |   RU chain, RH(CD),
                   |       RU chain, RH(CD), ----- |   <---- Entr
                   |  <--- Entr                    |
   DSP response    |                               |
   <--- Entr, ETX  |                               |



  Communications with BSC HIF may  have a problem, however if  VHR relies


  60                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


  exclusively on ETB/ETX. To solve this problem, it is suggested that VHR
  examines  also WCC  and specifies  CD  in CADR2  only if  both  ETX and
  keyboard restore in WCC  are specified. Occasionally, there might  be a
  BSC application which does not specify keyboard restore, but  this will
  be considered  a problem of this application.





  3.7.4.2  SNA/DSP mapping for terminal-host data transfer



  This direction of  exchange is represented by  data coming to  VHR from
  VTR.  On  the  presentation  level there  will  be  2  bytes  of header
  information to make it look  as Write type command followed by  a valid
  terminal-to-host 3270 data stream. This information will be transmitted
  to VTR as (possibly)  multi-element RU chain and  (possibly) segmented.
  All TH and RH options valid for LU type 2 will be supported by VHR with
  one exception; VTR must specify Change Direction at the end of every RU
  chain. This limitation is the natural result of the  reversed direction
  of  the transmission  (only  one enter  action per  terminal's  turn to
  send).



  This  data message  will be  mapped into  a DSP  response  message. The
  important points to be observed during the mapping are as follows.



  DSP response  consists of segments  each of which  does not  exceed 256
  bytes.  Segments  could be chained  by the First  Segment (FS)  bit and
  ETB/ETX trailer.  The first byte  of the data  portion of  SNA response
  should be the  beginning of the valid  3270 data stream,  starting with
  AID and so on.



  Therefore, each RU  chain coming from VTR  will be translated to  a DSP
  response  message,  each  RU  chain  corresponding  to  a  separate DSP
  response. The only  important point is not  to exceed the limit  of 256
  bytes for each segment of the DSP response.



  Preserving SNA segmentation  or chaining divisions  of the RU  chain by
  mapping  them  into  X.25  or  TYMNET  IIX  packets  is  of  no special
  importance  (taking  into  account  a  small  256  byte  limit). TYMNET
  packages of  maximum available length  will be used  and output  to the
  network as soon as possible.


  61                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988
























































  62                SNA/SDLC External Reference Manual         SNAE03.D03




  TYMNET SNA/SDLC Interface - Principle of Operation     February 1, 1988


              3.7.5  SSCP-LU handling



  SSCP-LU data messages coming from the host to VHR can not be reasonably
  treated as far as conversion  and transmission of this data to  the DSP
  HIF (like CMH) is concerned. This means, LU operating in VHR  mode will
  reject such data with -RSP(LU busy) and discard the message.














































  63                SNA/SDLC External Reference Manual         SNAE03.D03




  User Interface - Operational Aspects                   February 1, 1988






                 4 -  User Interface - Operational Aspects



  This  section  describes  the  operational  aspects  of   the  SNA/SDLC
  Interface  product  and  is  not  intended  to  describe  the technical
  aspects.


  The aim of this section is to describe how the product is used and what
  operational changes would be necessary.


  Currently  there  are  two  types of  service  available,  that  is the
  SNA/SDLC Native Mode and SNA/DSP Virtual Host Mode.








                      4.1  SNA/SDLC Connection Types







              4.1.1  Natve Mode


  The Native Mode service is the most straight forward to describe of the
  two.  An SNA/SDLC  device utilizing this  mode connects to  an SNA/SDLC
  host. The SNA/SDLC Interface in this simplest form can be linked  to an
  extension cord replacing the leased communication line (see  Figure 5).
  This application allows sharing of network facilities  between multiple
  SNA/SDLC applications.


  Much greater value  can be obtained from  Native Mode service  if there
  are multiple host destinations for the device users.  A device/user may
  utilize a  network services  screen to  perform his/her  network logon.
  Thus each device can access  to a number of hosts or  host applications
  independently.



  64                SNA/SDLC External Reference Manual         SNAE03.D03




  User Interface - Operational Aspects                   February 1, 1988


      *----*
     /      \
    |SNA/SDLC|
    |terminal|
    |   or   |
    |cluster |
     \      /
      *----*
         \
          \
           \/\
              \  SDLC link procedures
               \
        --------------------
        |                  |
        |   SNA/SDLC       |
        |    terminal      |
        |    interface     |
        -------------------
                  |
                  |
          Native  |  Mode
                  |
            ------------------
            |                |
            |   SNA/SDLC     |
            |    Host        |
            |    interface   |
            ------------------
                  \
                   \
                    \/\
                       \ SDLC link procedures
                   ----------
                   |SNA/SDLC|
                   |  Host  |
                   |--------|
                   |  Front |
                   |   End  |
                   ----------




                      Figure 3 - Native Mode Service









  65                SNA/SDLC External Reference Manual         SNAE03.D03




  User Interface - Operational Aspects                   February 1, 1988


              4.1.2  SNA Virtual Host Mode


  In  SNA  8100 virtual  host  mode, the  host  interface  translates all
  communication  from the  3270 BSC  terminal and  formats the  data into
  normal SNA messages. Output to  the 3270 BSC terminal is  translated to
  BSC  by the  host  interface and  SNA  data flow  control  commands are
  transformed into equivalent data sequences recognized by the terminals.
  The SNA  host computer therefore  sees the BSC  terminal as  a SNA/SDLC
  terminal device.












































  66                SNA/SDLC External Reference Manual         SNAE03.D03




  User Interface - Operational Aspects                   February 1, 1988


      *----*
     /      \
    |BSC3270 |
    |terminal|
    |   or   |
    |cluster |
     \      /
      *----*
         \
          \
           \/\
              \  BSC
               \
        --------------------
        |                  |
        |   TYMNET BSC3270 |
        |    terminal      |
        |    interface     |
        -------------------
                  |
                  |
      SNA Virtual | Host Mode
                  |
            ------------------
            |                |
            |       SNA      |
            |  Virtual Host  |
            |    interface   |
            ------------------
                  \
                   \
                    \/\
                       \ SDLC link procedures
                   ----------
                   |SNA/SDLC|
                   |  Host  |
                   |--------|
                   |  Front |
                   |   End  |
                   ----------




                 Figure 4 - SNA Virtual Host Mode Service









  67                SNA/SDLC External Reference Manual         SNAE03.D03




  User Interface - Operational Aspects                   February 1, 1988


                       4.2  Network Services Screen







              4.2.1  Native Mode


  To logon to the network from an SNA/SDLC terminal the user must  in the
  network service  mode.  Whenever there  is no network  virtual circuit,
  the SNA/SDLC network interface places the device in the network service
  mode and is waiting for the user to select the desired  network service
  function.


  The user  may enter  the network  service mode  even after  the network
  virtual circuit exists. To enter the network service mode in this case,
  the user must enter 'network service keyword' when the screen  is owned
  by the SSCP or enter pre-defined PF key when the screen is owned by the
  PLU.   However,  this feature  may  no  be available  for  the  phase 1
  SNA/SDLC interface.







              4.2.2  Virtual Host Mode


  To logon  to the  network from  an BSC  terminal the  user must  in the
  network service  mode.  Whenever there  is no network  virtual circuit,
  the BSC3270 Terminal interface places the device in the network service
  mode and is waiting for the user to select the desired  network service
  function.   Please  see  detail description  in  TYMNET  3270 Reference
  Manual.














  68                SNA/SDLC External Reference Manual         SNAE03.D03




  User Interface - Operational Aspects                   February 1, 1988


                    4.3  User Interface - Configuration



  Generation of the SNA/SDLC interface requires configuration and loading
  of the interface  code. Before the interface  codes can be  loaded into
  job slots on ISIS nodes, their operating environment must be defined.





              4.3.1  Host Access


  The Host interface access configuration must be carefully planed.  When
  the host access for an  interface is generated, several aspects  of the
  configuration must be defined:


     1.  The   numbers   of   SNA/SDLC   host   links   (up   to  eight),
         terminal/cluster controllers  (up to 32  per link),  and logical
         units (up to 32 per controller) must be specified.

     2.  For each  SNA/SDLC host line,  all polling addresses  whose poll
         messages  are to  be  answered by  that host  interface  must be
         defined.

     3.  For  each controller,  all the  logical unit  addresses  must be
         defined.

     4.  For each  line, the  characteristic of  the SDLC  link procedure
         must be defined.

     5.  For each line, its  associated host number must be  defined. The
         host  number  will  be used  in  assigning  device  addresses to
         network circuits.

     6.  For each line, its transmission/receiving speed (i.e. BAUD rate)
         must be defined.


  The  detailed configuration  of the  host access  links of  an SNA/SDLC
  interface is specified in its associated TYMFILE.










  69                SNA/SDLC External Reference Manual         SNAE03.D03




  User Interface - Operational Aspects                   February 1, 1988


              4.3.2  Terminal Access


  When the terminal access links for an SNA/SDLC interface  is generated,
  its  configuration  must  specified.   This  requires  several relevant
  information.


     1.  The  numbers   of  SNA/SDLC  terminal   lines  (up   to  eight),
         terminal/cluster controllers (up  to 32), and logical  units (up
         to 32) must be specified.

     2.  For  each  SNA/SDLC  line,  the  addresses  (up  to  32)  of all
         terminal/cluster controllers to be recognized must be specified.

     3.  For each SNA/SDLC terminal/cluster controller, all  logical unit
         ( devices) addresses must be specified.

     4.  For each controller (PU TYpe 2 Node), the request unit (RU) data
         for the activation of the physical unit must be defined.

     5.  For each device (LU Type  2), the RU data for the  activation of
         the logical unit  and the RU data  for the local binding  of the
         local primary  logical unit session  with the  secondary logical
         unit (i.e. the external device) must be defined.

     6.  For  each device  if supporting  the preset  logon  feature, the
         'logon selection' information  and 'logon request'  strings must
         be defined.


  The control unit  and device (logical  unit) addresses are  in SNA/SDLC
  format.  When the configuration is changed, an SNA/SDLC  interface must
  be  regenerated with  revised configuration  information.  The detailed
  configuration of the terminal access for an SNA/SDLC interface  is also
  specified in the associated Tymfile.







              4.3.3  Polling Address and Logical Unit Address


  The  polling  addresses  for   control  units  must  be   specified  by
  hexadecimal values in the tymfiles. These addresses must be the same as
  that of those linked control units.





  70                SNA/SDLC External Reference Manual         SNAE03.D03




  User Interface - Operational Aspects                   February 1, 1988


                     4.4  System Generation Parameters



  The following sections list the types of parameters which are necessary
  for the configuration  of an SNA/SDLC  interface.  The exact  syntax of
  each configuration  statement will  be defined  at the  TYMNET SNA/SDLC
  Interface System Generation Manual


  All configuration parameters are  defined through assembly macros.







              4.4.1  General Slot Parameters


  The following parameters define  the environment in which  the SNA/SDLC
  interface slots reside and also some general parameters:

     - The time zone correction from GMT for local time.
     - Whether the slot should freeze or restart upon an abend.
     - The ISIS Input and Output RINGS sizes.
     - and some other system related parameters.







              4.4.2  Host Link Parameters


  The  following parameters  are required  for the  generation of  a host
  interface.

     - The network host numbers for the interface.
     - The specific line number, polling addresses, and logical unit
       local addresses for the host.
     - The lines and their ISIS logical unit number.
     - Time outs and retry limits for the handling of the SDLC 
       links.







  71                SNA/SDLC External Reference Manual         SNAE03.D03




  User Interface - Operational Aspects                   February 1, 1988


              4.4.3  Terminal Link Parameters


  The following parameters are required for the generation of  a terminal
  link.

     - Size of the buffer space for the interface. There will be a 
       default value.
     - The lines and their ISIS logical unit numbers.
     - The devices addresses on each line.
     - Whether a particular line requires RTS/CTS handshake before 
       allowing data transmission.
     - The specific logon option for each device (Manual or Preset
       logon).
     - The logon strings for Preset logons.
     - and many other necessary parameters.






































  72                SNA/SDLC External Reference Manual         SNAE03.D03




  User Interface - Operational Aspects                   February 1, 1988






                       5 -  CRM 4 for Host Interface







                               5.1  Overview


  This project   implements the support  of 3270 Display  System Protocol
  (DSP)  connection  request  mode  4  (CRM4)  for  SNA  host  interfaces
  (secondary ports).   An  SNA host interface  (HIF) connected to  an SNA
  primary station will accept CRM4 call requests from terminal PADs which
  support the 3270 DSP CRM4. This will allow terminals, connected to such
  interfaces as  CMT, to be associated with a particular printer  as soon
  as the terminal establishes a call to the SNA HIF.



  The SNA  HIF currently,  in versions 2.00  and earlier,  supports CRM1,
  CRM2 and CRM3.  The next version, 3.00,  will support all of  these CRM
  types with the  addition of CRM4 for  secondary ports. CRM4  support by
  the SNA primary ports will follow in a future version.



  To fully understand this  document, the reader should be  familiar with
  the following documents:


      [1] 3270 Display System Protocol - 2nd Edition June 1983
      [2] Tymnet SNA External Reference Specification 
      [3] Tymnet Circuit Protocol Reference Manual (August 25, 1983)















  73                SNA/SDLC External Reference Manual         SNAE03.D03




  CRM 4 for Host Interface                               February 1, 1988


                       5.2  CRM 4 Calling Procedures




  CRM 4 is an associated device CRM. For this project, CRM 4  is  used by
  the terminal PAD,  such as CMT, to  request a connection for  a printer
  which is to be associated with an existing connection to a terminal.


  For example, the SNA interface  at the SNA host side will  be sysgenned
  to associate one  or more printers with  either one or  more terminals.
  When the end user tries to logon to the SNA host from a  terminal which
  has associated  printers, the SNA  interface will allow  the connection
  only if BOTH the terminal  AND at least one of the  associated printers
  is  not  already connected  to  another  end user,  and  if  the remote
  terminal configuration  matches the  local terminal  configuration.  By
  finding  an available  terminal  and printer  as soon  as  the terminal
  connection  request arrives,  the SNA  HIF will   keep a  terminal from
  being assigned to  a printer which may  already be assigned  to another
  terminal. The printer will be restricted, by these  requirements,  from
  receiving data from the wrong end user.


   When the SNA interface determines that the printer may be  assigned to
  the  terminal, information  uniquely identifying  the terminal  is sent
  back to CMT. This information uniquely identifying the terminal  is now
  echoed  back  by  CMT  inside  a  connection  request  message  for the
  associated  printer  using  the   CRM  4  format.  The  SNA   HIF  will
  successfully assign the requested  printer to this circuit only  if the
  associated terminal is still in the 'BUSY' state AND the printer  is in
  the 'WAIT' state, and also the remote printer configuration  must match
  the local  printer configuration.   The SNA HIF  will tie  together the
  terminal and  associated printer until  BOTH are disconnected  and once
  again become available.


  The  following subsections  will describe  in greater  detail  the call
  establishment and call  clearing procedures. These  descriptions assume
  the configuration illustrated below:














  74                SNA/SDLC External Reference Manual         SNAE03.D03




  CRM 4 for Host Interface                               February 1, 1988


                        - - - - - - - - - - - - - - - - -
                      /                                   \
                 ---------------          ---------   -----------
                 |  SNA        |          |  CMT  |   | CONSAT  |--- CRT1
     -------     |  HIF        |          |       |   |         |--- CRT2
     | IBM |-----| HCRT1&HPRT1 |          |       |   |         |--- CRT3
     | host|     | HCRT2&HPRT1 |          ---------   |         |--- PRT1
     |     |     | HCRT3&HPRT2 |                      |         |--- PRT2
     -------     ---------------                      -----------
                      \                                   /
                        - - - - - - - - - - - - - - - - - 

  Legend:
  &    a logical association setup during system generation
  HCRT host terminal
  HPRT host printer
  CRT  terminal
  PRT  printer
  HIF  host interface 
  CMT  Character Mode Terminal server





                     Figure 5 - Example Configuration









              5.2.1  Call Establishment



  The following stages demonstrate how a call request is made using CRM4.

         Stage 1. When the  end user at CRT2  wishes to logon to  the SNA
            host, the end user will first log into CMT and issue  the CRM
            4 logon selection from  the CMT logon screen.  CMT  will then
            send a 'CALL USER DATA'  message to the SNA HIF to  request a
            connection to  a terminal with  an associated  printer.  This
            message will use  a CRM  3 format and will indicate a printer
            is attached (byte 5 bit 4 of the user data field is set).


         Stage 2.  The SNA  HIF will use  the requested  CRM to  find the
            first available terminal with at least one  available printer


  75                SNA/SDLC External Reference Manual         SNAE03.D03




  CRM 4 for Host Interface                               February 1, 1988


            associated with it.   If HCRT1 and HCRT2  are both in  use or
            don't have terminal configurations which match the requesting
            terminal configuration, then the SNA HIF will check to see if
            HCRT3 would qualify for the terminal connection. For HCRT3 to
            qualify, it  must be  in the  'IDLE' state  and must  have an
            associated printer which is also in the 'IDLE' state. If both
            HCRT3 and  HPRT2 are in  the "IDLE" state,  then the  SNA HIF
            will assign HCRT3 to this circuit. HPRT2 is now in the "WAIT"
            state and HCRT3 is in the "BUSY" state. The SNA HIF returns a
            "CIRCUIT ENABLE"  message to CMT.  This message  contains all
            necessary information to uniquely identify HCRT3.


         Stage 3. CMT now sends a "CALL USER DATA" message with the CRM 4
            format back to  the SNA HIF to  request a connection  for the
            associated  printer  (HPRT2).   The   Additional  Destination
            Designator (ADD) portion of this 'CALL USER DATA'  message is
            the same as the ADD portion of the 'CIRCUIT ENABLE' message.


         Stage  4.   The  SNA  HIF   will  perform  some   checks  before
            successfully  assigning  HPRT2 to  this  circuit.  HCRT3 must
            still be  in the  "BUSY" state AND  HPRT2 must  be in  in the
            "WAIT" state. If either  device is not in the  correct state,
            an  "INVITATION  TO  CLEAR"  message  with  reason  code "03"
            (facility failure  detected) is sent  to CMT. In  addition to
            the state checking, the configuration of HPRT2 in the SNA HIF
            must  match the  configuration of  the printer  found  in the
            "CALL  USER  DATA"  requesting  the  printer  connection. The
            configuration  information  which is  checked  is  the device
            format, host number,  transparency, color and  character set.
            If  the  configuration  information  doesn't  match  then  an
            "EBCDIC"  message will  be sent  to CMT  and the  end-user to
            indicate the mis-match  followed by an "INVITATION  TO CLEAR"
            message also  with cause code  "03" to request  to disconnect
            the printer circuit.



         Stage 5. If all checks are successfull, the SNA HIF  will assign
            HPRT2 to this new circuit. HCRT3 and PRT2 will now be  in the
            "BUSY" state.  The SNA HIF  sends a "CIRCUIT  ENABLE" message
            back to CMT.











  76                SNA/SDLC External Reference Manual         SNAE03.D03




  CRM 4 for Host Interface                               February 1, 1988


          The following table gives the "EBCDIC" messages which  might be
            sent and under what conditions:



       "EBCDIC" MESSAGE                    MESSAGE CAUSE
    --------------------------------      ------------------
  'SNAH 01 - INVALID HOST NUMBER'         o host # mis-match

  'SNAH 03 - CONTROL UNIT NOT AVAILABLE'  o controller with available
                                            CRT & assoc. PRT not found
  'SNAH 04 - DEVICE NOT AVAILABLE'        o no CRT device currently
                                            available 

  'SNAH 06 - DEVICE WITH SPECIFIED        o PRT or CRT has transparency,
   ATTRIBUTE NOT AVAILABLE'                 device size, color, and/or
                                            character size mis-match
  'SNAH 07 - DEVICE NOT ACTIVATED'        o PRT or CRT device not 
                                            activated by SNA host.
  'SNAH 08 - DEVICE ALREADY IN USE'       o CRT or PRT device already 
                                            in use by another end user.
  'SNAH 0B - NO ASSOCIATED DEVICE'        o no PRTs associated to CRT

  'SNAH 0C - ASSOCIATED DEVICE ALREADY    o all associated PRTs are 
   IN USE'                                  unavailable.
       
  'SNAH 10 - ASSOCIATED CRT UNATTACHED'   o CRT associated with this 
                                            PRT not in 'BUSY' state.
  'SNAH 11 - INVALID ASSOCIATION'         o PRT connection is not for
                                            LU.T1 or LU.T3
                                          o CRT and associated PRT are 
                                            not attached correctly.




                     Table 1 - "EBCDIC" Error Messages









              5.2.2  Call Clearing



  Once a terminal has successfully  been assigned by the SNA HIF  to it's
  associated printer, they  will be tied  together until the  circuit for


  77                SNA/SDLC External Reference Manual         SNAE03.D03




  CRM 4 for Host Interface                               February 1, 1988


  BOTH devices is cleared. If just one circuit is lost, the SNA  HIF will
  also clear the other circuit.  These devices will now be in  the "IDLE"
  state. If the inactivity timers  for BOTH devices elapses, the  SNA HIF
  will also clear both circuits and put the devices into "IDLE" state.






              5.2.3  Associating Terminals and Printers



  To associate terminals and  printers together in one pool,  the TYMFILE
  macros for  defining PU and  LU addresses and  labels are used.  No new
  macros were added to implement the CRM 4 project.


  For a terminal to have an associated printer, the terminal's PU and the
  printer's PU must first have  the same 'PU.LABEL' value defined,  or if
  no label is defined,  the same 'PU.ADDRESS' value defined.  In addition
  to this requirement, the terminal's  LU and the printer's LU  must have
  the same 'LU.LABEL' value defined, or if no label is defined,  the same
  'LU.ADDRESS' value defined.





























  78                SNA/SDLC External Reference Manual         SNAE03.D03




  LU Type 1 Virtual Host Printer                         February 1, 1988






                    6 -  LU Type 1 Virtual Host Printer







                               6.1  Overview


  This  document  describes  the general  external  design  of  the LU_T1
  virtual printer feature in  the SNA interface. This feature  allows SNA
  hosts to send LU_T1 SCS printer data streams through TYMNET to an ASYNC
  or Bisync 3270 printer.


  The SNA  interface must map  LU_T1 SCS printer  data streams  into 3270
  Display System Protocol (DSP) Write Structured Field (WSF) commands for
  the network.   The 3270 DSP messages are destined for either  a network
  server or  interface which supports  3270 DSP implementation  for LU_T1
  SCS printer data streams.


  For communication between  an SNA host and  an ASYNC printer,  the 3270
  DSP messages will be sent to the Character Mode Terminal  (CMT) server.
  CMT will then map the 3270 DSP messages into the TYMNET  ASYNC protocol
  understood  by the  destination  ASYNC terminal  PAD  (TYMSAT).  TYMSAT
  then sends the printer data stream in an ASYNC format to the printer.


  When communicating between an SNA host and a 3270 Bisync  printer, 3270
  DSP messages are sent to the 3270 Bisync terminal interface  (PBT). PBT
  then maps the SCS printer data stream from the DSP WSF into 3270 Bisync
  for the printer.


  The following sections describe the format of SCS printer  data streams
  received  from the  SNA host,  the format  of this  data stream  on the
  network side,  and finally  how the  SNA interface  maps between  the 2
  formats.


  To fully understand this  document, the reader should be  familiar with
  the following documents:


     [1] SNA Sessions Between Logical Units (GC20-1868-2)
     [2] IBM 3270 Information Display System Data Stream

  79                SNA/SDLC External Reference Manual         SNAE03.D03




  LU Type 1 Virtual Host Printer                         February 1, 1988


         Programmer's Reference (GA23-0059-0)
     [3] 3274 Control Unit Description and Programmer's Guide
         (GA23-0061-0)
     [4] SNA Format and Protocol Reference Manual (SC30-3112-2)
     [5] 3270 Display System Protocol 2nd Edition June 1983






          6.2  Conversion Between LU_T1 SCS Data and 3270 DSP WSF


  The  SNA interface  will convert  between LU_T1  SNA  Character Streams
  (SCS) and  3270 Display  System Protocol  (DSP) using  Write Structured
  Fields (WSF). LU_T1 SCS printer data flows to and from the SNA  host in
  the  form   of  Request  Units   (RUs)  containing   structured  and/or
  unstructured  fields.   On  the network  side, 3270  terminal  side DSP
  messages carry the LU_T1 SCS  data in the form of WSF  commands between
  the SNA interface and a 3270 DSP terminal interface.





              6.2.1  LU_T1 SCS Data

  For LU_T1 printer data, the SNA  host will use an SCS data  stream. The
  SCS printer data stream is sent in an SNA Request Unit (RU).  There are
  only 2 possible RU formats for this SCS data stream.

  One format sends the SCS data stream as a structured field  following a
  Function Management Header type 1 (FMH1). The second format   sends the
  SCS data  stream without  using structured  fields. This  second format
  would not include an FMH.


   The BIND sent from the host will indicate whether FMHs are  allowed. A
  bit in the Request Header (RH) for that particular SCS RU will indicate
  whether the FMH is present or not.


  The IBM 3274 Programmer's Guide  Chapter 1 discusses the format  of RUs
  using Write Structured Field (WSF) command and FMH1 to convey SCS data.
  In this chapter, it is pointed out that the format header  indicator in
  the  BIND command  (byte  6, bit  1) must  specify  function management
  header included if FMHs are to be used on this LU-LU  session. However,
  in Chapter 5 of this same document, a table indicates very clearly that
  the format indicator in the BIND command must indicate no FMHs included
  or  the  BIND will  be  rejected. Because  this  document  explains how
  structured fields could be used for SCS data, but then points  out that


  80                SNA/SDLC External Reference Manual         SNAE03.D03




  LU Type 1 Virtual Host Printer                         February 1, 1988


  this  is  currently not  supported  by 3274s,  both  methods  have been
  included in this document in case structured fields are ever used.


  The following  sections describe in  detail both structured  (with FMH)
  and unstructured (without FMH) RU formats.




  6.2.1.1  SCS Data Structured Field


  The SCS data structured field has the following general  format whether
  it is outbound (from the host) or inbound (to the host):


  length - type - parameters and data


  The length-field  value includes  the 2  bytes of  the length  field. A
  value of  zero causes the  structured field to  be treated as  the last
  field in the RU.


  If SCS data is sent in the parameter and data field, then the type must
  be X'41'. This is the SCS data identifier.


  The first byte of the parameters and data field must be X'00'.  This is
  a reserved byte and will be rejected by the SNA interface if  not equal
  to X'00'.


  When structured fields are used  to convey SCS printer data, a  FMH1 is
  used to  direct the structured  field to  a 3274 printer  in LU  type 1
  session.  The 3274  will only support FMH  type 1, and the  contents of
  this header  must be X'0601000B6000'.   The FMH-1 will  be the  first 6
  bytes of the RU after the RH. Refer to Appendix II. Function Management
  Header Type 1 a description of the FMH-1 fields.


   As indicated by  the FMH concatenation bit  in the FMH-1 (Byte  1, bit
  0), no FMH  will follow this FMH-1  containing SCS data. This  means an
  FMH-1 with SCS data is the first and only FMH in an RU.


  An FMH-1  must be contained  within a chain.  It is mandatory  that the
  Request  Header  (RH)  proceed  the  FMH-1  and  have  the  Begin Chain
  Indicator set to first in chain.




  81                SNA/SDLC External Reference Manual         SNAE03.D03




  LU Type 1 Virtual Host Printer                         February 1, 1988


   The  RU may  contain one  or  more structured  fields of  the  same or
  different types.  Because  of this, the  length and type  of structured
  field is specified at the  start of each structured field. A  3274 will
  only  accept one  FMH per  RU,  that is,  no concatenation  of  FMHs is
  supported by 3274s.


  The host indicates  structured field usage in  the BIND command  at the
  start of the session. The  format header indicator in the  BIND command
  (byte 6, bit 1) must specify function management header included. Also,
  the format indicator (FI) in the  RH of the first RU in the  chain will
  be on to indicate that an FMH is at the start of the RU. The  3274 will
  only support FMH type 1 and  can only support one FMH per RU.  For each
  RU there maybe one or more structured fields.  These  structured fields
  maybe of various types, such as Outbound  3270 Data Stream (DS), SCS DS
  and so on. Refer to Appendix I.  Structured Fields.


  The following is the format of  an RU which includes  at least  one SCS
  Data structured field. An SCS Data structured field is  not necessarily
  the first structured field in the RU as depicted in this diagram.



                            RU Format with FMH

             <--------------- RU ---------------------------------..>
  ----------------------------------------------------------------
  | TH | RH | FMH | lngth | SCS  | 00 | SCS | other structured 
  |    |    |     |       | ID   |    | Data|   fields .............
  ----------------------------------------------------------------
                   <--- Structured  -------->
                         Field 1             




                    Figure 6 - Structured SCS RU Format
















  82                SNA/SDLC External Reference Manual         SNAE03.D03




  LU Type 1 Virtual Host Printer                         February 1, 1988





  The fields of the SCS structured RU have the following meanings:



  -------------------------------------------------------------------
  Field   Name          Contents    Field    Meaning
                                    Length
  -------------------------------------------------------------------
  TH      Transmission FID = B'02'   6      FID must indicate FID2.
          Header       MPF = B'10'          MPF must indicate first
                                            segment. (Refer to FAPL
                                            for detailed format)

  RH      Request/    BC = B'01'   4 or 3   BC must indicate begin
          Response    FI = B'01'            chain. FI must indicate
          Header                            FMH follows. (Refer to
                                            FAPL for detailed format)

  FMH     Function  X'0601000B6000'  6    The 327x equiped with SFAP 
          Management     (FMH-1)          support requires this format.
          Header                          (Refer to 3274 Programmers
                                           Guide pg.1-26)

  lngth   Length       X'nnnn'       2    Length of structured field.
                                          If X'0000', then indicates
                                          last or only structured field
                                          in transmission. (Refer to 3274
                                          Programmers Guide pg. 1-31)
  SCS ID  SCS Data     X'41'         1    Indicates following structured 
          Identifier                      field contains SCS data stream.
                                          (Refer to Programmer's Guide
                                           pg. 2-26)
                       X'00'         1    Reserved, must be zero.

  SCS     SCS Data               length-4 The SCS printer data stream.
  Data    Structured                      (Refer to Programmers Guide
          Field                            pg. 2-26)



                    Table 2 - Structured SCS RU Fields










  83                SNA/SDLC External Reference Manual         SNAE03.D03




  LU Type 1 Virtual Host Printer                         February 1, 1988


  6.2.1.2  SCS Data without FMH

  The SNA host may send SCS printer data without employing FMHs.  In this
  case, the RU will contain only  SCS printer data as defined by  the IBM
  SNA  Sessions Between  Logical  Units (GC20-1868-2).  SCS  data streams
  consist of a sequential string of SCS controls and data characters. The
  host will convey this SCS string as an RU chain to the SNA interface.


  The SNA interface will expect the  first byte of the RU to be  SCS data
  if the Format Indicator in the RH indicates no FM header  following the
  RH.


  The following  is the format  of an RU  containing SCS data  without an
  FMH.



                           RU Format without FMH

             <--------------- RU ----------------->
  --------------------------------------------------
  | TH | RH |  SCS printer data stream  .......... |
  --------------------------------------------------




                   Figure 7 - Unstructured SCS RU Format
























  84                SNA/SDLC External Reference Manual         SNAE03.D03




  LU Type 1 Virtual Host Printer                         February 1, 1988



  The  following  table describes  the  different fields  for  an  SCS RU
  without an FMH:



  -------------------------------------------------------------------
  Field   Name          Contents    Field    Meaning
                                    Length
  -------------------------------------------------------------------
  TH      Transmission FID = B'02'   6      FID must indicate FID2.
          Header       MPF = B'10'          MPF must indicate first
                                            segment. (Refer to FAPL
                                            for detailed format)

  RH      Request/    BC = B'01'   4 or 3   BC must indicate begin
          Response    FI = B'00'            chain. FI must indicate no
          Header                            FMH follows. (Refer to
                                            FAPL for detailed format)

  SCS     SNA                         n     String of SCS control codes
  Data    Character                         and data characters. (Refer
          String                            to SNA Sessions Between 
                                            Logical Unit Part 2 Ch.1)




                   Table 3 - Unstructured SCS RU Fields







              6.2.2  3270 DSP

  The SNA interface will send the SCS printer data stream to  the network
  as a 3270 DSP command. The  SCS data stream will be enclosed in  a 3270
  Write Structured Field (WSF) command.


  The  following  diagram  is  the  format  of  a  3270  DSP  WSF message
  containing an SCS printer data stream. There could be various  types of
  structured fields in  one DSP WSF message.  An SCS structured  field is
  not  necessarily  the first  structured  field in  the  message  as the
  following diagram demonstrates.






  85                SNA/SDLC External Reference Manual         SNAE03.D03




  LU Type 1 Virtual Host Printer                         February 1, 1988


                          DSP WSF Message Format



  ----------------------------------------------------------------------
  | DSP | ESC | WSF | lngth | SCS | 00 | SCS |  Other Structured | DSP |
  | HDR |     |     |       | ID  |    | Data|      Fields   ....| TLR |
  ----------------------------------------------------------------------
                     <-- Structured Field 1 ->




                     Figure 8 - DSP WSF Message Format








































  86                SNA/SDLC External Reference Manual         SNAE03.D03




  LU Type 1 Virtual Host Printer                         February 1, 1988





  The following  table describes the  fields of the  WSF command  for SCS
  data:



  --------------------------------------------------------------------
  Field   Name      Contents    Field    Meaning
                                Length
  --------------------------------------------------------------------

  DSP     3270 DSP                3      DSP header includes UCN,
  HDR     Header                         flags, and Sequence number.
                                         (Refer to DSP manual)

  ESC     Escape     X'27'        1      First byte of DSP command
                                         must be escape character.

  WSF     Write       X'F3'       1      Identifies the next field 
          Structured                     as a structured field. (Refer 
          Field                          to 3274 Programmer's Guide 
                                         pg. 1-25)

  lngth   Length      nnnn        2      Length of structured field. If
                                         X'0000' then SCS data field end
                                         indicated with ETX trailer.

  SCS ID  SCS Data    X'41'       1      Indicates following structured
          Identifier                     field contains SCS data stream.
                                         (Refer to Programmer's Guide
                                          pg. 2-25)

                      X'00'       1      Reserved must be zero.

  SCS     SCS Data    nnn...  length-4   The SCS printer data stream.
  Data    Structured                     (Refer to Programmer's Guide
          Field                           pg. 2-26)




                     Table 4 - DSP WSF Message Fields










  87                SNA/SDLC External Reference Manual         SNAE03.D03




  LU Type 1 Virtual Host Printer                         February 1, 1988


              6.2.3  Mapping Between LU_T1 SCS and 3270 DSP



  The  SNA interface  will  convert between  RUs consisting  of  SCS data
  streams  on  the host side,  and 3270 DSP  WSF commands  containing SCS
  structured fields on the network side.


  Whether or not the SCS printer data stream is received from the host as
  a structured field, the SCS data stream always has the same format when
  sent to the  network.  The SNA interface  will always use the  3270 DSP
  WSF command when communicating with the network.




  6.2.3.1  SCS Structured Field Mapping to DSP WSF



  If the host is using SCS structured fields, then the SNA interface will
  check the  FMH. If  the FMH has  the value  X'0601000B6000' ,  the BIND
  properly specifies FMH accepted, the TH specifies first in segement and
  the RH specifies  begin chain and FMH  follows, then the  SNA interface
  will proceed to map the remaining  chain of RUs into a WSF  command for
  the network.


  The  WSF  command  is  appended  to  the  beginning  of  the  remaining
  structured fields in the RU  chain.   This WSF command is then  sent to
  the  network  as  a DSP  command;  that  is, a  DSP  header  and Escape
  character is attached to the front of the command and a DSP  trailer is
  appended  to the  end of  the WSF  command (after  the  last structured
  field).


  If the  length byte in  the structured field  is zero, then  the length
  field in the DSP WSF command will also be zero and the message  will be
  terminated with an ETX.


  For a description  of the frame and  network message formats,  refer to
  the sections  entitled 'SCS  RU Format with  FMH' and  section entitled
  '3270 DSP'.




  It is possible to have more  than one structured field in a  single DSP
  WSF command. All structured fields  received from the host in  the same
  RU chain will be mapped into the same WSF command for the network.


  88                SNA/SDLC External Reference Manual         SNAE03.D03




  LU Type 1 Virtual Host Printer                         February 1, 1988


  The following figure demonstrates   an RU chain   containing  FMH-1 and
  only one structured field being  mapped into a DSP WSF  command message
  for the network.

             SCS Structured Field Mapping to DSP WSF Commands


   -----------------------------------------------------------
   |* TH |** RH |*** FMH-1 | lngth | SCS ID | 00 | SCS data  |
   ----------------------------------------------------------
                           \                                 /
                            ---------------------------------
                                       \
                                        \
                                         v
                             --------------------------------
                            /                                \
      ------------------------------------------------------------------
      | DSP HDR | ESC | WSF | lngth | SCS ID | 00 | SCS data | DSP TLR |
      ------------------------------------------------------------------


    * Mapping Field = Whole BIU (B'11') 

   ** Begin Chain Indicator = first in chain (B'1'),
      Format Indicator      = FMH follows (B'1')

  *** FMH-1 = X'0601000B6000'




            Figure 9 - SCS Structured Field Mapping to DSP WSF







  6.2.3.2  SCS Data without FMH Mapping to DSP WSF



  If the host is not using structured fields to convey SCS data, then the
  SNA  interface would  expect the  SCS  data stream  to be  an  RU chain
  without any length bytes, FMHs,  or structured field IDs. The  SCS data
  starts with the first RU in a RU chain. A whole RU chain  received from
  the host is mapped into one DSP WSF command for the network.


   The TH must have  the MPF indicator set  to first in segment  or whole


  89                SNA/SDLC External Reference Manual         SNAE03.D03




  LU Type 1 Virtual Host Printer                         February 1, 1988


  BIU. The RH following this TH must have the BCI set to begin chain. The
  FI must indicate  no FMHs following. When  all of these  conditions are
  met, then the following RU  chain is the  SCS data structured  field of
  the WSF command sent to the network.


   For  more  information on  the  unstructured RU  format  refer  to the
  section entitled SCS RU Format without FMH.


   The SCS data stream from this RU is sent inside a 3270 DSP WSF command
  to the network. The SNA interface adds 2 length bytes (always zero)  an
  SCS ID byte (X'41') and a reserved X'00' byte in front of the  SCS data
  stream.  In  this particular  case,  the length  bytes  will  always be
  X'0000' to specify this structured field as the only field in  this WSF
  command.  An ETX  DSP Trailer  would signify  the end  of the  SCS data
  stream. The WSF command (X'F3') is appended to the front of  the length
  bytes to denote this field  as structured.  For a more  detailed acount
  of the WSF format refer to section entitled '3270 DSP'.




  It is possible to have the RU chain divided into more than one segment,
  and in that  case each segment of  that RU chain would  be concatenated
  into  the SCS  data field  of one  WSF command.   The  following figure
  demonstrates  an RU chain contained in one segment being mapped  into a
  single DSP WSF command message for the network:


            SCS Unstructured Field Mapping to DSP WSF Commands


                           ---------------------------
                           |* TH |** RH  | SCS data  |
                           ---------------------------
                                         \           /
                                          -----------
                                                   \
                                                    \
                                                     v
                                                   ----------
                                                  /          \
   -----------------------------------------------------------------
   | DSP HDR | ESC | WSF | ***lngth | SCS ID | 00 | SCS data | ETX |
   -----------------------------------------------------------------




    * Mapping Field =  whole BIU (B'11')

   ** Begin Chain Indicator = first in chain (B'1'),

  90                SNA/SDLC External Reference Manual         SNAE03.D03




  LU Type 1 Virtual Host Printer                         February 1, 1988


      Format Indicator      = no FMH follows (B'0')

  *** Length = X'0000'




           Figure 10 - SCS Unstructured Field Mapping to DSP WSF














































  91                SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Host Reflect Mode                              February 1, 1988






                      7 -  Virtual Host Reflect Mode







                  7.1  Virtual Host Reflect Introduction


  This GID describes Virtual Host Reflect Function within TYMNET SNA Host
  Interface product.


  The design of this product  is based on Standard ECMA-71  HDLC Selected
  Procedures (Jan. 1981) for the  link level procedures and IBM  SNA FAPL
  (Format and protocol Langauge) manual for higher level SNA protocls.


  TYMNET SNA Interfaces with  primary and secondary ports  provide access
  between  SNA/SDLC protocol  terminals and  hosts utilizing  the packet-
  switching  data  transmission  services of  TYMNET  data  network. This
  interface  can be  used  to replace  leased lines  between  hosts using
  SNA/SDLC PU.T4 protocol and SNA/SDLC PU.T2 terminals connected by LU.T2
  or LU.T3 sessions. Switched Virtual Call services are provided allowing
  user access to multiple SNA hosts.


  In  addition  SNA  Virtual  Host interface  allows  usage  of  BSC 3270
  displays and printers if 3270  Control Unit is connected to  Tymnet BSC
  3270 Terminal  interface. SNA  Virtual Host  interface allows  also for
  switched network access from ASCII termianls and printers  connected to
  TYMSAT interface  and using Tymnet  Character Mode Terminal  Server for
  ASCII to 3270 data stream conversion (Reference to TYMNET SNA ERS).



  Virtual  Host  Reflect  Function  provides  for  yet  another  type  of
  connection. LU.T2/T3 3270 user  having a native connection to  IBM host
  will be  able (by signing  on special VTAM  application running  in the
  host)  to  use  TYMNET  SNA  HIF  as  LU.T2/T3  gateway  (LU.T3  may be
  implemented later).



  The combined action of this VTAM application (VTAM Reflect program) and
  TYMNET SNA Virtual Host Reflect function will make it look  like TYMNET


  92                SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Host Reflect Mode                              February 1, 1988


  SNA/DSP Virtual TIF for other TYMNET products. Specifically, it will be
  able to  communicate to  CMH (TYMNET  3270/ASCII host  convertor) which
  will allow to run Microdata Reality System applications on  3270. Other
  ASCII host connections should be possible if implemented in CMH.


  Any other TYMNET DSP HIF (specifically SNA and BSC 3270) should be able
  to communicate  with SNA  Virtual Host  Reflect Function  providing for
  wide variety of 3270 interconnections.



  The Software design provides for the following features:


  1.  Be layered  like the  protocol,  so that  new layers  can  be added
  without changing code,  and a layer  can be modified  without affecting
  other layers.


  2. Use tables (such as State Machines) to drive code when possible.


  3. Use independent communicating processes rather than  complex control
  structures.


  4. Minimize movement of data from one buffer to another.






                    7.2  Virtual Host Reflect Function


  Virtual Host Reflect  Function will run as  a part of SNA  Virtual Host
  Interface. It will be compatibale with other Host Interface options and
  will be selected on per LU basis by turning on the high bit in  LU type
  during sysgen (LUCTYP in LUCB).



  SNA/SDLC protocols for such LU will be LU.T2 session  protocols between
  primary  LU  in  PU.T4/T5 (represented  by  VTAM  reflect  program) and
  secondary  LU  in  PU.T2  (represented by  TYMNET  SNA  HIF).  The only
  difference  from   the  regular  LU.T2   connection  will  be   on  the
  presentation  level which  will use  3270 outbound  data stream  in the
  inbound direction and visa versa (see PIR 1830).




  93                SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Host Reflect Mode                              February 1, 1988


  All Network I/O level will be  affected and should look as if it  was a
  TIF rather than HIF. This includes such important functions  as circuit
  building and support of DSP protocol. Both should be reversed.  Same is
  true  with  regard  to  DSP/SNA  chaining  and  segmentation  protocols
  mapping.



  This  document  deals with  these  changes one  by  one  discussing the
  problems  and  proposed   solutions.  Printer  support  will   also  be
  considered  (mostly, it  is no  different  from CRT  as far  as  VHR is
  concerned).



  Proper functioning of  Reflect approach depends on  coordinated actions
  of  VHR and  VTAM Reflect  program. This  coordination is  performed by
  adhering to exchange protocols specified below. These protocols require
  some  additional  information  to be  exchanged  between  VHR  and VTAM
  Reflect program (referred to as VTR below).



  This additional information could be carried in 2 or 3 header  bytes as
  defined in VTR DO. These bytes are meant to fake Write Command Code and
  WCC (from VTR  to VHR) and  AID and Cursor  Address (from VHR  to VTR).
  Therefore we have 6 unused bits of WCC (from VTR to VHR) and  12 unused
  bits of Cursor  Address (from VHR to  VTR). The suggested  structure of
  these bits is described below.






                    7.3  Network I/O Reversed Functions








              7.3.1  Virtual Cuircuit Building

  VHR  sould  be  capable  of  building  Virtual  Circuits  and  complete
  connection with DSP information.


                                N O T E !!
                                - - - - --


  94                SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Host Reflect Mode                              February 1, 1988


         Usage of Circuit  building is not  necessarily restricted
                 to  Reflect  Function  only.  Most   likely,  HIF
                 initiated Virtual  Circuits (VC's) could  be used
                 for Virtual Host Printer support.  Therefore, the
                 function  of  building  Virtual  Circuit  will be
                 requested   during  sysgen   for  the   given  LU
                 independently of Reflect Function. Requesting the
                 Reflect  Function  will  imply  HIF  intiated  VC
                 support.


         However,  the  usage  of  Host  Initiated  Logon  for the
                 printer is not discussed in this  document. Other
                 changes  required for  VHR do  not have  (for the
                 most  part)  anything  to  do  with  this printer
                 function.



  Information necessary to build VC could be either stored in  TYMNET HIF
  (similar to pre-stored logon streams in TIF) or given to HIF during the
  logon exchange between HIF and VTAM Reflect program (which in  turn may
  have it pre-stored or taken from 3270 logon screen).



  Another option  to be considered  is the moment  when VC is  built.  In
  case of pre-stored  logon stream it could  be built at the  moment when
  ACTLU comes from the host and torn down when DACTLU is  received.  This
  type of circuit is  close to PVC and it  will be rebuilt if  zapped for
  any reason as  long as LU  stays active. Once  this type of  circuit is
  built  VHR  will  try  to invoke  VTAM  Reflect  program  by  sending a
  configurable SSCP-LU data  message (say, VTR)  to the host  (similar to
  any other application, say TSO).  The expected action from VTR  is BIND
  and then the same way as described below for BIND-time built VC.



  Alternative option is to build and tear VC duirng BIND and  UNBIND.  If
  pre-stored logon stream is not specified this could be the  only option
  available.



  In case  of VTR  (VTAM Reflect program)  sending the  logon information
  there is a possibility of contradiction between pre-stored VHR  and VTR
  logon information. Options are  - indicate contradiction to VTR  or zap
  already built at ACTLU time PVC-type circuit and build another one.



  One more option in case of VTR-supplied logon information has essential


  95                SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Host Reflect Mode                              February 1, 1988


  bearing on  VHR/VTR logon  protocol. VTR  itself could  have pre-stored
  logon information or it could be supplied during  manual stage-by-stage
  logon process.  In the first case all logon information  is transmitted
  to VHR in one piece, in the second case it comes gradually.



  Regardless of ways  of storing and  supplying the logon  information it
  consists  of  network  VC  information  followed  by  DSP  information.
  Network  VC information  consists of  unspecified number  of  VC stages
  (corresponding  to  a  piece  of VC  between  any  2  TYMNET functional
  interfaces like  SNA HIF  or CMH or  TYMCOM or  any such  interface and
  TYMNET gateway).



  It should  be noted  that multistage logon  information is  typical not
  only  in CMH  case but  in case  of any  gateway. CMH  can be  faking a
  gateway as far  as logon process in  concerned. DSP information  is not
  needed then or used to convey other type of information - type of ASCII
  host for example  - or it could  be dummy. Another possibility  is that
  CMH will build  the circuit to TYMCOM  using X.25 Called  Address field
  (part  of DSP  information).  VHR/VTR  interaction does  not  depend on
  these CMH options.



  The format of 1 VC stage is:


  username[:host#][;password]


  Host# and password could be absent.



  The format of one and only DSP information element is:


  CRM;CLDADR;APLID;DCU;DDEV;CLR;EXTATR


  where


  CRM - connection request mode (currently 1-4, disregarded by CMH);


  CLDADR - called address as defined in X.25 Call Request packet;




  96                SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Host Reflect Mode                              February 1, 1988


  APLID - any 1-byte graphic, could  be used to define the type  of ASCII
  host to CMH;


  DCU - destination Control Unit, 1-byte graphic, ignored by CMH;


  DDEV - destnation device, 1-byte graphic, could be used  in conjunction
  with CLDADR by CMH;


  CLR - color (Y/N);


  EXTATR - extended attrubutes (Y/N).



  This logon information  is supplied from VTR  to VHR in the  first RU's
  following BIND and SDT (if circuit is built by VHR at ACTLU time on the
  basis of VHR-prestored information then  VTR logon information could be
  dummy, but it must be present anyway). The VTR logon  information comes
  to VHR either complete in one (first) RU chain (VTR pre-stored case) or
  one logon element at a time,  waiting for reply RU from VHR  before the
  next logon element is sent (logon element is either VC stage or DSP).



  VHR tries to build a circuit or a piece of circuit corresponding to the
  received  logon element  and  sends back  a reply  RU  containing logon
  status information  (success or  failure) and  possible prompt  for the
  next element (VC stage or  DSP) and network data message (the  latter 2
  pieces only in case of VTR manual logon).



  The logon exchange consists therefore of a sequence of logon  RU's from
  VTR alternating with reply RU's from VHR, each sending one RU  chain at
  a time  in a half-duplex  fashion. VTR can  abort this sequence  at any
  moment by sending UNBIND (or DACTLU), VHR can abort it by  TERM-SELF or
  RSHUTD. Other SNA protocol requirement to support logon exchange are no
  different from regular data  exchange mode and discribed later  in this
  document.



  The logon scenario may look therfore as follows:







  97                SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Host Reflect Mode                              February 1, 1988



                  VTR                                     VHR
                   |  ----        BIND              ---->  |
                   |  ----        SDT               ---->  |
                   |  ---- logon RU (network stage) ---->  |
                   |  <--- reply RU (ok, give next) -----  |
                   |  ---- logon RU (network stage) ---->  |
                   |  <--- reply RU (ok, give DSP)  -----  |
                   |  ---- logon RU (DSP info)      ---->  |
                   |  <--- reply RU (ok, logon end) -----  |



                Figure 11 - VTR - VHR Manual Logon Scenario


                                N O T E !!
                                - - - - --

         SNA responses are omitted on this picture.



  For the case when VC is built at ACTLU time (PVC-type) the scenario may
  look as follows:

                  VTR                                     VHR
                   |  ----        ACTLU           ---->    |
                   |                                       |  building VC
                   |                                       |  VC built
                   |  <--- SSCP-LU FMD (VTR)      -----    |
                   |  ----        BIND            ---->    |
                   |  ----        SDT             ---->    |
                   |  ---- logon RU (dummy net,DSP) -->    |
                   |  <--- reply RU (ok, logon end) ---    |



               Figure 12 - VTR - VHR Prestore Logon Scenario


                                N O T E !!
                                - - - - --

         Other scenarios (including logon aborts and failures) are
                 possible.



  The formats of logon and reply RU's are as follows:




  98                SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Host Reflect Mode                              February 1, 1988


  Format of logon RU (VTR to VHR):


  WCMD WCC [logon information]



  WCMD is hex F1 or F5 or anything else (disregarded by VHR);



  WCC fakes 3270 WCC and consists of the following:


  bits  0  and  1  -  determined  from  IBM  6/8  bit  translation  table
  (disregarded by VHR),


  bits 2-5 reserved,


  bit 6  - override VHR  pre-stored logon information  (1 -  zap PVC-type
  circuit and  use VTR  information, 0 -  error if  VHR has  a pre-stored
  information),


  bit 7 - VTR manual/pre-stored (1 for manual, 0 for pre-stored);



  Logon information  could be complete  (in case of  VTR-prestored logon)
  one  logon  element  (VTR manual)  or  empty  (VHR-prestored  case, VTR
  manual/prestored must be set to pre-stored).



  Complete logon information is sent in the format:



  VC stage,VC stage, ... ,VC stage!DSP element



  Any of elements of complete logon information could be absent  and will
  be asumed dummy by VHR.



  Logon elements are transmitted in EBCDIC, no orders or other  3270 data
  stream insertions except for graphics are allowed.



  99                SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Host Reflect Mode                              February 1, 1988


  Reply RU's format (from VHR to VTR):



  EAID CADR1 CADR2 ERCDE [network data message]



  EAID is hex 7D (or anything else to fake AID);



  CADR1 consists of the following:


  bits 0-1 - determined from IBM 6/8 bit translation table,


  bits 2-4 - reserved,


  bit 5 -  continue/completed (0 - logon  completed, 1 - give  next logon
  element, always 0 in case of unrecoverable error or VTR-prestored),


  bit 6 - VC stage/DSP (0 - for VC element, 1 - for DSP),


  bit 7  - enter  half/full duplex  mode of  transmission, valid  only if
  logon completed (bit 5  zero) successfully (ERRCDE=0), 1 -  full duplex
  transmission, 0 - half duplex transmission.



  CADR2 carries SNA protocol  information and is described later  in this
  document;



  ERCDE is a binary value for error code which is defined as follows:


  0 - success,


  1 -  bad username (all  last stage logon  information to be  retyped in
  case of manual logon),


  2 - bad password (only password could be changed during retry),


  3 - circuits busy (try again),

  100               SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Host Reflect Mode                              February 1, 1988


  4 - host  not available (problem  with TYMNET destination  interface or
  wrong host number,


  5 - host out of ports,


  6 - host down,


  7 - access not permitted,


  8 - insufficient information to build circuit,


  9 - incorrect VHR logon override,


  0A - problem with DSP information (followed by text).



  Continuation  of logon  process will  be expected  by VHR  for ERCDE<4,
  otherwise  UNBIND must  be coming  from VTR  (or VHR  will  abort logon
  anyway).  ERCDE=0 and logon complete bit in CADR1 will  signal transfer
  to normal data exchange state.



  The network data messages will  be discarded in case of  VTR pre-stored
  logon.  In case of manual  logon they will be translated to  EBCDIC and
  all necessary 3270  commands and orders (Write,  WCC, SBA, SF)  will be
  attached to the message,  so that it is ready  to be output to  3270 as
  FMD RQ (TH and  RH to be attached by  VTR to present RU chain  with the
  same chaining indicators as the reply RU in which this data  message is
  sent  by  VHR).   The  only  piece  of  information  needed   for  this
  translation  is the  line  number on  the  screen to  start  the output
  message. This will be given to VHR as SYSGEN parameter.





              7.3.2  SNA/DSP protocol and mapping functions



  All DSP protocol (including logon procedure and data exchange)  will be
  reversed  that  is  Reflect  Function in  VHR  will  be  using Terminal
  Interface DSP protocols.



  101               SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Host Reflect Mode                              February 1, 1988


                                N O T E !!
                                - - - - --

         This  should not  be  mixed up  with the  case  when host
                 initiated logon is requested.  Call establishment
                 procedures in this  case will be as  described in
                 DSP host initiated call protocol. No  reversal of
                 DSP fucntions will be performed in this case.



  This  also means  that SNA/DSP  Virtual Host  mapping (as  described in
  TYMNET SNA ERS  document) will be replaced  for the LU's  performing in
  the  Reflect mode.  In some  respects this  mapping reminds  of Virtual
  Terminal (VTI)  mapping, but  they are not  equal becuase  of asymmetry
  between SNA primary (VTI) and secondary (VHR).



  Specifics of this  VHR mapping are  as follows.  Terminal  interface is
  represented by Reflect Function in VHR, host interface could be any DSP
  HIF (including CMH). DSP  multiple user circuits will not  be supported
  (similar to any other TYMNET product).



  7.3.2.1  SNA/DSP host to terminal data transfer



  The following considerations and restrictions apply for  this direction
  of data transfer.



  The data will be coming from HIF envelopped in DSP command  headers and
  trailers. The overall length of  a command does not exceed  3000 bytes.
  Commands  could be  chained by  ETX/ETB trailer.  A DSP  command  has a
  standard DSP header followed  by 3270 data stream command  (like Write,
  Erase/Write,  etc.)  and  valid 3270  outbound  data  stream,  one 3270
  command per one DSP command.



  DSP commands are travelling  through TYMNET in X.25  packets (connected
  by  X.25 M-bit).  Each packet  could be  split into  a few  TYMNET data
  messages, combined into X.25 packet with the help of IIX "turkey level"
  protocol (see TYMNET SNA IIX documents for the details).



  This  data  should be  transmitted  to VHR  compatibly  with  SNA LU.T2


  102               SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Host Reflect Mode                              February 1, 1988


  secondary protocol. For this purpose 3 header bytes (EAID, CADR1, CADR2
  as described above  for logon reply RU  format) will be  attached right
  before 3270  data stream command  to form SNA  RU (one such  header per
  every DSP command). This completes modifications on presentation level.
  The format of CADR2 is descibed later in this section.



  SNA TH and  RH headers will also  be created and attached  right before
  the RU. The bits to be set during this process are BC and EC (Begin and
  End Chain Indicators),  BB and EB (Begin  and End Bracket),  CD (Change
  Direction) and BIU and EIU (Begin and End segment).



  Out  of  these  bits EB  is  always  0 for  the  secondary  because the
  secondary can not end  the bracket for LU type  2. BB will be set  to 1
  (Bracket started) if the session  is not in bracket when VHR  sends the
  RU to VTR. Otherwise BB will be set to 0.



  Begin Chain (BC)  bit will be  set on if and  only if VHR  received the
  beginning of the new  DSP command. The important consideration  here is
  that only one 3270 command is  allowed per RU chain and it must  be the
  fist byte of RU (similar to DSP command).



  End  Chain (EC)  and segmentation  bits  in TH  do not  have  any rigid
  requirements  for  DSP/SNA mapping.  From  SNA standpoint  it  does not
  matter how the chain is split into RU's and RU's into segments  as long
  as RU  and segment  lengths do  not exceed  certain values.  Maximum RU
  value  for secondary  to primary  direction is  defined in  BIND. Also,
  multiple element RU chains could be disallowed in BIND  altogether. The
  size of the segment is limited by the size of SDLC frame.



  For this reason  it is unimportant  to have any  correspondence between
  the way the DSP command is  split into X.25 and TYMNET packets  and the
  way SNA RU  chain is split into  chains and segments. The  algorithm of
  mapping  will try  to keep  segments and  RU's close  to  their maximum
  sizes, but also leave some room there for the next TYMNET packet (if it
  is expected) so that the mapping code is not overcomplicated.



  The important point is that this mapping - one DSP command into  one RU
  chain - is  possible at all which  depends on BIND parameters.  One DSP
  command is up to 3000 bytes long. So, either multiple RU  chains should
  be allowed in BIND or RU size should be no less than 3000.


  103               SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Host Reflect Mode                              February 1, 1988


                                N O T E !!
                                - - - - --

         Although VHR should  be capable to work  without allowing
                 multiple element RU  chains, this BIND  option is
                 undesirable  for  performance  reasons.  VTR will
                 have   (most  likely)   no  access   to  separate
                 segments, only  RU's. Therefore, RU's  should not
                 be very big, so that VTR could pass them along as
                 soon as they were received. However,  RU's should
                 not be  unncecessary small  because it  would add
                 some processing overhead for SNA interface.



  Change Direction (CD) indicator controls the direction  of transmission
  in  Half Duplex  Flip-Flop mode.  LU type  2 performs  in this  mode of
  operation while  in-bracket state.  We will  assume therefore  (for the
  duration of discussion on Change Direction) that VHR/VTR session  is in
  "in-bracet" state  (see also the  section on Half/Full  Duplex opertion
  later in this document).



  In typical 3270 environment, the application will use Flip-Flop mode in
  the following manner. The host application paints the screen as a whole
  or piece-by-piece issuing one or a few 3270 Write commands (one  per RU
  chain). Change direction is specified only in the last of these chains.
  Until this happens, input from the keyboard is inhibited.


                                N O T E !!
                                - - - - --

         There is another way to lock and unlock the keyboard - by
                 manipulating WCC. This second way  (unlike Change
                 Direction)  is   user-recoverable  by   the  user
                 hitting Reset key. A typical SNA application will
                 use  both   methods  to  insure   Flip-Flop  mode
                 simulteneously.



  Once the direction is changed  (and keyboard unlocked by WCC  or Reset)
  the user makes his  or her keystrokes and  hits one of the  enter keys.
  The direction is  changed at this moment.  The important point  is that
  there is only one enter action for (possibly) a few write commands.



  Correspondingly, SNA LU type  2 protocol allows unlimited number  of RU
  chains  in host  to terminal  transmission before  Change  Direction is


  104               SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Host Reflect Mode                              February 1, 1988


  specified by the host. However, every RU chain going from  the terminal
  to the host (except DFC chains which is unimportant for the  purpose of
  this discussion) must specify Change Direction.



  Typical native data exchange may look as follows:

                  370                                     3270
                   | ----- RU chain, RH(-CD), Wrt ---->    |
                   | ----- RU chain, RH(-CD), Wrt ---->    |
                   | ----- RU chain, RH(CD), Wrt  ---->    |
                   | <---- RU chian, RH(CD), Entr -----    |



                 Figure 13 - VTR - VHR Data Exchange Flow





  The screen is painted with  3 Write commands, first two have  -CD.  SNA
  responses are omitted.



  Returning to VHR, it must specify Change Direction at the end  of every
  RU  chain because  it fakes  terminal to  host direction  and  must act
  according to secondary-to-primary LU type 2 protocol.



  However,  this  does not  mean  that this  Change  Direction  is really
  desirable at this  moment. Moreover, if the  data coming from  the host
  interface (like CMH) comes  in several RU chains (several  3270 Writes)
  there will be a problem.



  It could be argued that CMH could be implemented in such a way  so that
  it does not  use multiple Writes (waits  for "input sequence"  and only
  then writes, see CMH  documentation for more details).  However,  it is
  undesirable for performance purposes.  It is also dangerous to  try and
  put all screen data in one DSP command because the limit of  3000 bytes
  could be exceeded if CMH tries to paint a piece of screen as soon as it
  is received (especially for scrolling applications).



  Running applications on SNA or BSC host would also become impossible.



  105               SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Host Reflect Mode                              February 1, 1988


  Therefore, Change  Direction Indicator specified  in RH should  be used
  only to satisfy  SNA and VTAM requirements.  The real control  of Flip-
  Flop mode should be indicated separately, for example in CADR2.



  The following format is suggested for CADR2:


  bits 0-1 - determined from IBM 6/8 bit translation table;


  bits 2-6 - reserved;


  bit 7 -  Change Direction (1  - last RU chain  for this direction,  0 -
  more RU chains in this direction are forthcoming).



  The actions of VTR upon  receiving these Change Direction bits  are not
  prescribed in this document as far as its control of 3270 is concerned.
  However,  this information  should be  enough to  maintain  Half Duplex
  control of 3270.  Conceivably, VTR may  copy Change Direction  bit from
  CADR2 into  RH of  the message being  sent to  3270. This  way multiple
  Writes should become possible for VTR/3270 communications.


                                N O T E !!
                                - - - - --

         Notice the delay in copying CD bit. CADR2 comes to VTR in
                 the first  RU of  the chain, CD  in RH  should be
                 specified in the last RU of the chain.



  However,  for  VTR/VHR   communications  multiple  Writes   require  an
  additional action on the part  of VTR. After the direction  was changed
  by VHR during the first Write, VTR must help VHR to restore its sending
  state  by  changing  send  direction  back  to  VHR  if  VHR  requested
  continuation in CADR2.  This could be achieved  by VTR sending  back to
  VHR  a dummy  (RH only)  RU  indicating Change  Direction if  bit  7 of
  preceding CADR2 was  0. VHR will  be able to  send the second  Write to
  VTR, VTR  sends back dummy  RU with  CD if necessary.  And so  on until
  CADR2 indicates Change Direction.


                                N O T E !!
                                - - - - --

         Dummy RU with CD is legal but not  typical. Occasionally,


  106               SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Host Reflect Mode                              February 1, 1988


                 there  are implementation-specific  probelms with
                 dummy  RU's.   Therefore,  VTR  should   have  an
                 alternate way of handling CD. Namely,  instead of
                 dummy RU with  CD it may send  to VHR a  dummy RU
                 with EB (End Bracket).  This type of dummy  RU is
                 so   typical  that   no  implementation-dependant
                 complications  are  expected.  Also,  this  is an
                 internal  protocol  between  VTR  and   VHR.  So,
                 although formally there is a contention situation
                 after EB, no complications typical for contention
                 are expected because both VTR and VHR  will still
                 keep their own Half Duplex states.



  One more matter regarding Change  Direction is how VHR decides  what is
  the right value for CD in CADR2. DSP protocol gives one  possibility in
  this  respect. If  DSP  command has  ETB trailer  then  continuation is
  definitely expected. CMH and SNA  HIF's will have a definite  sign from
  corresponding hosts to change  direction and therefore will use  ETX to
  indicate change direction to VHR.


                                N O T E !!
                                - - - - --

         This option was never used for SNA HIF so far.


                                N O T E !!
                                - - - - --

         The indication for  CD should be put  in the first  RU of
                 the chain.  ETB and ETX  are both  trailers which
                 come after the last character of RU  chain, which
                 might  be  much  later.  If  the  trailer  is not
                 available  at the  moment when  CD  indication is
                 generated   VHR   will  send   -CD   (not  Change
                 Dircetion)  to VTR  and then  will send  CD  in a
                 separate dummy RU consisting only of 3  RU header
                 bytes (EAID, CADR1, CADR2). VTR will  strip these
                 bytes  and send  dummy  (RH-only) RU  with  CD to
                 3270. The remark  above about replacing CD  by EB
                 applies to this instance too.



  The example of the native data tranfer above will look as follows:






  107               SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Host Reflect Mode                              February 1, 1988



                  VHR                             VTR
   DSP command     |                               |
   Wrt, ETB --->   |  ---- RU chain, RH(CD),       |
                   |       CADR2(-CD), Wrt   ----> |   RU chain, RH(-CD),
   DSP command     |  <--- dummy RU, RH(CD)  ----- |   Wrt   ---->
   Wrt, ETB --->   |  ---- RU chain, RH(CD),       |
                   |       CADR2(-CD), Wrt   ----> |   RU chain, RH(-CD),
   DSP command     |  <--- dummy RU, RH(CD)  ----- |   Wrt   ---->
   Wrt, ETX --->   |  ---- RU chain, RH(CD),       |
                   |       CADR2(CD), Wrt    ----> |   RU chain, RH(CD),
                   |                               |   Wrt   ---->
                   |                               |   RU chain, RH(CD),
                   |       RU chain, RH(CD), ----- |   <---- Entr
                   |  <--- Entr                    |
   DSP response    |                               |
   <--- Entr, ETX  |                               |



                   Figure 14 - VTR - VHR Data Conversion





  Communications with BSC HIF may  have a problem, however if  VHR relies
  exclusively on  ETB/ETX. It  is suggested  therefore that  VHR examines
  also  WCC and  specifies CD  in  CADR2 only  if both  ETX  and keyboard
  restore  in  WCC are  specified.  Occasionally, there  might  be  a BSC
  application which does not  specify keyboard restore, but this  will be
  considered as a problem of this application.


                                N O T E !!
                                - - - - --

         Unfortunately, this  problem occurs  in some  versions of
                 TSO during  signon. It must  be bypassed  in some
                 artificial way.



  7.3.2.2  SNA/DSP terminal to host data transfer



  This direction of  exchange is represented by  data coming to  VHR from
  VTR.  On  the  presentation  level there  will  be  2  bytes  of header
  information to make it look  as Write type command followed by  a valid
  terminal-to-host 3270 data stream. This information will be transmitted
  to VTR as (possibly)  multi-element RU chain and  (possibly) segmented.


  108               SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Host Reflect Mode                              February 1, 1988


  All TH and RH options valid for LU type 2 will be supported by VHR with
  one exception: VTR must specify Change Direction at the end of every RU
  chain. This limitation is the natural result of the  reversed direction
  of  the transmission  (only  one enter  action per  terminal's  turn to
  send).



  This  data  message  will  be mapped  into  DSP  response  message. The
  important points to be observed during the mapping are as follows.



  DSP response  consists of segments  each of which  does not  exceed 256
  bytes. Segments  could be  chained by  the First  Segment (FS)  bit and
  ETB/ETX trailer.  The first byte  of the data  portion of  SNA response
  should be the  beginning of the valid  3270 data stream,  starting with
  AID and so on.



  Therefore, each RU  chain coming from VTR  will be translated to  a DSP
  response  message,  each  RU  chain  corresponding  to  a  separate DSP
  response. The only  important point is not  to exceed the limit  of 256
  bytes for each segement of the DSP response.



  Preserving SNA segmentation  or chaining divisions  of the RU  chain by
  mapping  them  into  X.25  or TYMNET  IIX  packets  is  of  no especial
  importance  (taking  into  account  a  small  256  byte  limit). TYMNET
  packages of  maximum available length  will be used  and output  to the
  network as soon as possible.






                  7.4  Special SNA considerations for VHR














  109               SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Host Reflect Mode                              February 1, 1988


              7.4.1  SSCP-LU handling



  SSCP-LU  data  messages  coming  from the  host  to  VHR  could  not be
  reasonably treated as far  as conversion and transmission of  this data
  to the DSP HIF  (like CMH) is concerned.  So, LU operating in  VHR mode
  will reject such data with -RSP(LU busy) and discard the message.



  A message could come from  HIF (like CMH) while LU-LU session  does not
  exist. This  can happen only  if PVC-type circuit  was built.  The host
  will be notifyed  in this case by  sending VTR application name  to the
  SSCP-LU session and  the host shall anwer  with BIND. Until  it happens
  the message  will stay in  NIO/SNA data queue.  If VTR comes  back with
  UNBIND or VTAM  issues DACTLU this pending  message will be  purged and
  the circuit will be zapped.





              7.4.2  Half Duplex/Full Duplex mode of operation



  All discussions so far assumed Half Duplex mode of operation  when only
  one side  (terminal operator or  host) can transmit  data. This  is not
  true for a typical ASCII host and terminal relations. Therfore if there
  is a goal  to make 3270  operate in a mode  similar to a  typical ASCII
  terminal  this cannot  be achieved  without giving  3270 at  least some
  semblance of Full Duplex operation.



  A  specific problem  which makes  the necessity  to have  such  mode of
  operation absolutely clear is  the impossibility to determine  from any
  formal  approach when  an ASCII  host application  finished to  paint a
  screen and ready to receive.  The only possible approach is wait  for a
  timeout.   This   approach  is   unrelyable   (especially   in  network
  environment) and badly affects performance.



  Therefore if the goal of emulating the ASCII mode is to be achieved the
  full duplex operation of 3270 must be provided.



  The closest 3270 can approach the full duplex mode is when  it operates
  in "between bracket" condition.  The brackets cannot be ended  from the


  110               SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Host Reflect Mode                              February 1, 1988


  secondary. Therefore the primary  (that is VTR) should end  the bracket
  as soon as  possible. That is  every RU chain  sent from VTR  in either
  direction should indicate  End of Bracket.  Also, VTR should  send back
  dummy RU with End of  Bracket after receiving any RU chain  from either
  side.



  This approach  would allow  to output  to the  screen at  virtually any
  moment of time thus bypassing the problem mentioned above.



  The trade-off is some complication  of VTR program. It must be  able to
  handle contention and retransmissions.



  However, as  a matter  of principle such  program could  be built  on a
  simple principle of stacking RU chain if its transmission  is currently
  impossible  and retransmitting  the chain  should it  be rejected  as a
  result of contention.



  The type of the mode (Half  or Full duplex) depends on the type  of the
  host which  the user  is trying  to reach.  In some  cases it  could be
  determined from the  product ID of TYMNET  HIF (like SNA and  BSC HIF's
  require that VTR works in Half  Duplex mode). In case of CMH  this will
  be impossible to determine. Application  ID could be used in  this case
  to differentiate between the 2 types. VTR receives the  indication what
  mode to use in the last reply RU of logon sequence before  entering the
  corresponding mode of data transfer.







              7.4.3  Printer support



  Support for  LU type 3  printer could be  provided in  VHR/VTR product.
  Although VTR will control the printer via LU type 3 session,  this type
  of session  cannot be used  on VTR/VHR connection.  LU type 3  does not
  allow for transmission  of data from the  terminal to the host.   So LU
  type 2 session between VTR and VHR should be used instead.





  111               SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Host Reflect Mode                              February 1, 1988


  All SNA/DSP mapping for this session could be performed the same way as
  for real  LU type 2  (CRT). Every  RU chain coming  from VHR  should be
  followed by  a dummy RU  from VTR to  change direction  of transmission
  back to VHR/VTR.



  A  big  problem with  printer  support is  error  recovery.  Delays are
  inherent  for  the printer.  Say,  paper  jam will  cause  a  delay and
  necessity to re-transmit.



  Sending -RSP in case of  such delay is probably not the  best approach.
  It is suggested that if an RU chain is aleady partailly  transmitted it
  will  be accepted  by VTR  with +RSP  and retained  there  for possible
  retransmission to 3270. But no new RU chain will be started from VHR to
  VTR until the delay condition clears. This could be achieved in  VTR by
  simply not sending the  dummy RU chain with change  direction mentioned
  above while the delay exists.



  If  such  backpressure  is  applied by  VTR  then  VHR  will experience
  accumulation of buffered data for this LU. After a short while VHR will
  pass the  backpressure signal  to the  network. HIF  on the  other side
  (say,  CMH) will  backpressure  the host  and  the print  data  will be
  stopped from sending.



  Printer logon is  no different from CRT  logon. Printer is  separate LU
  and  separate VC  and there  will  be no  knowledge within  VHR  of any
  logical or physical relations between the printer LU and any other LU.



  In other words  VTR will send printer  logon information to VHR  on the
  session for the printer LU. The logon protocol will be the same  as for
  CRT.



  Although not discussed here, the  possible option for VTR is  to obtain
  printer logon information  from the autorized  CRT acting on  behalf of
  this  printer.  Another  possibility  is to  use  PVC-type  VC  for the
  printers.



  If printer logon information is obtained from a CRT there is a question
  when this information is  obtained. There might be a  requirement (like


  112               SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Host Reflect Mode                              February 1, 1988


  in TYMNET BSC interface) that the user can request printer logon at any
  time, including the period when  the CRT used to request it  is already
  in end-to-end session with remote host application.



  In this case there is a problem for VTR to backpressure any  new screen
  updates coming from VHR and to restore the screen in its previous shape
  after printer logon information was obtained.



  Backpressure could be applied from VTR to VHR the same way as described
  previously for the data going  to the printer. As far as  restoring the
  screen  is  concerned  this  is  internal  VTR  function.   A  possible
  technique is to obtain the screen content by issuing Read  Buffer, save
  it and then restore form this information.





































  113               SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Terminal Mode                                  February 1, 1988






                        8 -  Virtual Terminal Mode







                    8.1  Virtual Terminal Introduction


  This section  describes Virtual Terminal  Interface within  TYMNET  SNA
  Terminal Interface product.

  The design  of this   product  is  based   on  Standard   ECMA-71  HDLC
  Selected  Procedures (Jan.  1981) for the link level procedures and IBM
  SNA FAPL  (Format and  protocol Langauge) manual  for higher  level SNA
  protocls.

  TYMNET  SNA Interfaces  with  primary   and  secondary   ports  provide
  access   between SNA/SDLC  protocol terminals  and hosts  utilizing the
  packet-switching  data transmission  services of  TYMNET  data network.
  This  interface   can  be  used to replace  leased lines  between hosts
  using   SNA/SDLC  PU.T4   protocol  and   SNA/SDLC    PU.T2   terminals
  connected   by  LU.T2   or  LU.T3   sessions.   Switched   Virtual Call
  services are provided allowing user access to multiple SNA hosts.

  In addition  SNA Virtual  Host interface allows   usage  of   BSC  3270
  displays  and  printers if 3270 Control Unit is connected to Tymnet BSC
  3270 Terminal  interface.  SNA  Virtual   Host  interface   allows also
  for switched network access from ASCII termianls and printers connected
  to  TYMSAT  interface   and   using  Tymnet   Character   Mode Terminal
  Server for ASCII  to 3270 data  stream conversion (Reference  to TYMNET
  SNA ERS).

  Virtual Host  Reflect Function  provides  for   yet  another   type  of
  connection.   LU.T2/T3   3270 user  having a  native connection  to IBM
  host will be able (by signing on special VTAM  application   running in
  the  host)  to use  TYMNET SNA HIF  as LU.T2/T3  gateway (LU.T3  may be
  implemented later).

  Virtual Terminal Interface  (VTI)  will provide local support  for 3270
  SNA  devices. All  SNA  functions required  for LU.T2  support  will be
  implemented within SNA Terminal Interface which will look as  PU.T4 SNA
  node running  a primary LU.T2  session for PU.T2  SNA node  (like 3274)
  running the secondary LU.T2 session.

  Internally  (in the  direction  of TYMNET)  Virtual  Terminal Interface


  114               SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Terminal Mode                                  February 1, 1988


  product will use  Terminal DSP (TDSP) protocol  which will allow  it to
  communicate  with  any  other  TYMNET  product  using  Host  DSP (HDSP)
  protocol in the direction of  TYMNET. A variety of such  products exist
  already or will be available in the nearest future.

  Specifically,  VTI   will  be  able   to  communicate  to   CMH (TYMNET
  3270/ASCII  host  convertor)   which  will   allow  to   run  Microdata
  Reality   System applications  on 3270.   Other ASCII  host connections
  should be possible if implemented in CMH.

  Any other  TYMNET DSP HIF  (specifically SNA and  BSC 3270)  should  be
  able    to   communicate    with   SNA   Virtual    Terminal  Interface
  providing for wide variety of 3270 interconnections.

  The Software design provides for the following features:

  1.  Be  layered like the  protocol, so that  new layers can   be  added
  without  changing   code,  and   a  layer   can  be   modified  without
  affecting other layers.

  2.  Use   tables  (such   as  State  Machines)   to  drive   code  when
  possible.

  3.   Use independent  communicating  processes   rather   than  complex
  control structures.

  4.  Minimize movement of data from one buffer to another.






        8.2  Principles of Operation for Virtual Terminal Interface


  Implementation of VTI will require changes in the existing SNA Terminal
  Interface product which  are not concentrated  in one specific  area of
  this interface. These changes will be considered in this document  in a
  manner which  follows the  layered structure of  the interface  and the
  protocol itself. However, this document concentrates on  the functional
  issues rather  than formal  layers and will  cross layer  boundaries in
  favour of functional integrity. We will use the word level  rather than
  layer for this reason.










  115               SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Terminal Mode                                  February 1, 1988


              8.2.1  SDLC level

  This layer  should not require  (theoretically) any  extensive changes.
  However, connection establishment error recovery procedures may have to
  be  enchanced. If  so, this  change will  have nothing  to do  with VTI
  function  itself,  but  rather  with  Terminal  Interface  as  a whole.
  Specifics of this enhancement will be documented later.





              8.2.2  PU level

  Remarks on SDLC layer are fully applicable to this level.





              8.2.3  SSCP-LU level at session establishment

  This  level  is also  common  to all  Terminal  Interface  options. Any
  enhancements  on this  level are  meant not  only for  VTI,  but native
  product as well.

  The Terminal Interface as it is currently implemented does  not process
  RSP(ACTLU)  in  full.  Specifically  long  form  of  this  response  is
  processed the same way as short.  As a result, the attempt to  BIND for
  an LU will be made  even if RSP(ACTLU) indicates that the  secondary LU
  is  currently inoperable  (power  off). It  is not  known  whether this
  attempt  can cause  any  real problems.  -RSP(BIND) from  such  LU will
  enable the interface to continue a correct functioning if the secondary
  LU informs TIF of power on condition when the device becomes operable.

  This  way of  operation should  be changed  to the  commonly acceptable
  exchange. Long response for ACTLU will be processed to find out  if the
  LU is  operable. BIND will  be send  to the secondary  LU in  this case
  immediately. Otherwise,  TIF will  wait for  NOTIFY from  the secondary
  before sending BIND.

  Processing  for  some  other session  service  messages  could  be also
  implemented. Although 3274 usage of such messages is limited to NOTIFY,
  support for at least INIT-SELF and TERM-SELF is probably desirable.

  It should be noted that  current implementation of TIF does not  have a
  special  SSCP_SVC  to  handle  these  messages.  Unfortunately, Network
  Services  in  FAPL  are   covered  only  in  narrative  and   no  meta-
  implementation  is  provided.  For this  reason,  processing  for these
  messages will be developped gradually. First release of VTI will handle
  only power on/off condition in RSP(ACTLU) and NOTIFY.



  116               SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Terminal Mode                                  February 1, 1988


              8.2.4  LU-LU level

  VTI operation after LU-LU  session is established will be  an extention
  of current TIF local mode of operation. It will differ from  local mode
  mostly by enhanced error recovery capabilities.

  The most common  for SNA error recovery  situation occurs when  -RSP is
  received from the session partner. All sense codes will be split into 3
  categories according to 3 types of actions which VTI can take for error
  recovery.

  a. Contention category.

  Contention for  LU type  2 session  may occur  only in  between bracket
  state. Typically, brackets are allowed  for LU type 2 session  and this
  is reflected in BIND. If VTI is gennned with BIND which does  not allow
  brackets contention will be treated  the same way as category  b below,
  however this type of BIND is strongly discouraged for usage.

  Contention category is represented by 813 and 814 sense codes. VTI will
  never attempt to open the bracket (as opposed by current TIF) by simply
  setting BB in RH.  Instead, BID will be  used. In case of  -RSP(813) it
  will  be repeated  after a  small timeout.  For -RSP(814)  VTI  will be
  waiting for  RTR. This way,  no loss  of actual data  can occur  due to
  contention between the primary and secondary LU.

  b. Recoverable sense codes.

  This category covers  the sense codes which  could be recovered  by re-
  displaying the screen. Representatives  of this category are  82A, 82B,
  84A and possibly some other sense codes.

  VTI will attempt error recovery for these codes by first  UNBINDing and
  then BINDing the LU-LU session again. After the session is successfully
  re-established again, VTI will request error recovery from the  host by
  sending DSP  status message  to HIF. Sense/Status  bytes of  the status
  will  indicate DC  (Data Check)  and US  (Unit Specify)  with resulting
  sense code X'C4C4'.

  This status will be passed to  the host if HIF happened to be  3270 BSC
  HIF. If also the host follows IBM recommended error recovery procedures
  it will  make an  attempt to  re-send the  whole screen  completing the
  error recovery process.  SNA HIF will  react by sending  LUSTAT(82B) to
  the host which  may also result in  host repainting the screen.  If the
  HIF is  CMH it  will also re-display  the screen.  It should  be noted,
  however, that except for CMH the success of such error recovery depends
  largely on the  ability of the host  to re-send the screen.  No attempt
  will  be made  by any  other TYMNET  DSP HIF  to save  and  re-send the
  information needed to rebuild the screen.

  c. Unrecoverable errors.



  117               SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Terminal Mode                                  February 1, 1988


  These  will include  every error  which is  not covered  in  2 previous
  cases. VTI  will UNBIND  the session, zap  the circuit  and then  go to
  local  session  to   display  Network  Service  screen   (as  currently
  implemented in TIF).





              8.2.5  SSCP-LU vs. LU-LU FMD RU's

  Data messages coming from 3274 could be either SSCP-LU or  LU-LU. SSCP-
  LU messages are in SCS (SNA Character Stream) and typically have a very
  limited volume (normally signon and possibly signoff). The bulk  of the
  data messages are LU-LU and they use 3270 data stream.

  The 3270 user operating in SNA/SDLC mode can select the desired session
  by hitting SYS/REQ key (if both sessions are active). 3270 BSC does not
  have any similar option and uses 3270 data stream only.

  Output data (to  3270) have the same  option. The data is  displayed on
  CRT only if the screen mode selected by the operator coincides with the
  session type which was chosen  by the host for this  message. Otherwise
  3274 replies with -RSP(829) - LU busy. Again, there is  nothing similar
  in BSC which uses only 3270 data stream.

  VTI handling of  these 2 data  streams depends on  what kind of  HIF it
  talks to.  If it happens to be BSC HIF or CMH VTI will assume  that the
  screen  is always  in LU-LU  mode (SYS/REQ  key is  not used).  If this
  assumtion  is  wrong (the  user  hit this  key  accidentally)  VTI will
  receive  -RSP(829).  This  will  be  handled  as  recoverable  error of
  category b above.  That is the session  will be UNBIND and  BIND again.
  This will bring the screen back to LU-LU mode. DSP status  message will
  be sent to HIF next and the last screen will be redisplayed (for BSC it
  depends on error recovery capabilities of the host).

  In case of having SNA HIF as a session partner VTI will attempt to make
  the screen look as  if it was the native  mode, even in terms  of SSCP-
  LU/LU-LU option. The data will always be sent or receivewd from  HIF in
  3270 data stream. The conversion  from or to SCS will be  performed (if
  necessary) at both  SNA TIF and  HIF. It could  be argued that  it will
  create unnecessary  workload for both  interfaces, but  SSCP-LU streams
  are normally so insignificant  as compared to total workload  that this
  is  not  a consideration.   The  double conversion  requires  much less
  adjustment to the existing HIF which makes it preferable.

  To  implement  this  approach  SNA  TIF  and  HIF  must  exchange  some
  information.  HIF  should inform  TIF that it  received BIND  or UNBIND
  (also DACTLU if  application timeout is  requested at HIF).  TIF should
  inform HIF of the screen mode change whenever it learns of this change.
  Data-like  messages   used  in   SYS/REQ  implementation   for  SNA/CMT
  communication will be used for this purpose (see SNAERS.DOC).


  118               SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Terminal Mode                                  February 1, 1988


  VTI will maintain  the mode of the  screen. This mode  information will
  change if such data-like (Write Status) message is received from HIF or
  if the information received  from 3274 indicates that the  operator hit
  the SYS/REQ key.

  There are a  few possibilities how VTI  can learn that SYS/REQ  key was
  hit. It can receive  -RSP(829) - LU busy  - while attempting to  send a
  data message on one of  the two sessions (SSCP-LU or LU-LU).  This will
  be be interpreted by VTI as the indication that currently the screen is
  owned by the  session alternate to what  the data was sent  to. Another
  indication  is receiving  a data  message or  LUSTAT from  3274  on the
  alternate session (that  is different from  previously known to  VTI as
  current screen mode).

  Upon receiving such  indication from 3274  VTI will change  its current
  screen mode and  send a data-like message  (SYS/REQ AID) with  the next
  available  sequence  number to  HIF  (exactly as  CMT  for  CMT/SNA HIF
  SYS/REQ interface). At this moment VTI enters SYS/REQ cycle  similar to
  SYS/REQ cycle of CMT.

  SNA HIF  will receive this  SYS/REQ AID and  respond with  Write Status
  command with the matching sequence number. SYS/REQ cycle will  end when
  VTI gets back Write Status with the matching sequence number.  Any data
  message from the host will be discarded while VTI is in  SYS/REQ cycle.
  Also, if SYS/REQ cycle was initated because of receiving a data message
  or LUSTAT from 3274 these messages will not be responded until  the end
  of SYS/REQ cycle.

  Sequence number used  for SYS/REQ AID  will be non-zero.  Zero sequence
  number is reserved for Write Status initiated by HIF. This  will happen
  whenver BIND or  UNBIND was received by  the host. VTI will  follow the
  Write Status command by BINDing or UNBINDing LU-LU session. This action
  will also change the screen mode known to VTI.

  Any data message  received from HIF outside  the SYS/REQ cycle  will be
  send to the session which corresponds to the last known screen  mode of
  VTI. If this happens to  be SSCP-LU owned screen the data  message from
  HIF will be converted from 3720 to SSCP-LU data stream.

  Since SYS/REQ  and BIND/UNBIND come  from different  sources contention
  between  them is  possible. Unlike  CMT VTI  cannot  ignore BIND/UNBIND
  indication (Write Status with 0 sequnce number) while in SYS/REQ cycle.
  For this reason the status  coming from HIF may be different  from what
  is known  to VTI at  the end  of SYS/REQ cycle.   VTI will  generate an
  extra  SYS/REQ AID  and enter  the next  SYS/REQ cycle  without sending
  anything to 3274 if this situation happens.








  119               SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Terminal Mode                                  February 1, 1988


              8.2.6  SNA/DSP host to terminal data transfer

  The   following  considerations   and  restrictions   apply   for  this
  direction of data transfer.

  The data will be coming from HIF enveloped in DSP  command  headers and
  trailers.  The overall length of a command does not exceed  3000 bytes.
  Commands could be chained by an  ETX/ETB  trailer.   A  DSP command has
  a standard  DSP header followed  by a valid  outbound 3270  data stream
  command (like  Write, Erase/Write, etc.).   There is  one  3270 command
  per one DSP command.

  DSP   commands  are   travelling  through   TYMNET  in   X.25   packets
  (connected  by   X.25 M-bit).  Each  packet could be  split into  a few
  TYMNET  data   messages  (see   TYMNET  SNA   IIX  documents   for  the
  details).

  DSP  commands are  received and  processed by  TDSP part  of  VTI which
  operates  as a  part  of NIO  (Network  I/O) module  of  SNA interface.
  Together with SNA module  they perform the necessary conversion  of DSP
  command to SNA FMD RQ.

  DSP header will be discarded and the information in this header will be
  used to create SNA headers  (see below). Data staream does  not require
  any  conversion if  it  is sent  on LU-LU  session,  otherwise 3270/SCS
  conversion will be performed.

  SNA TH and  RH headers will  be   created  and  attached   right before
  the  RU.  The bits to be  set during this process are BC and  EC (Begin
  and End Chain Indicators),  BB  and  EB  (Begin  and  End Bracket),  CD
  (Change  Direction)  and  BIU and EIU (Begin and End segment).

  BB and EB  bits are not defined  during DSP/SNA conversion by  NIO, but
  are determined by internal logic in SNA module  (LU-SVC). Specifically,
  BB will be always set to 0 by VTI since BID will be used if the session
  is not in bracket when data is sent by VTI.  EB will be always set to 1
  (which will allow contention between the host and terminal operator).

  Begin Chain (BC)  bit will be  set on if and  only if VTI  received the
  beginning of the new DSP command.  The important consideration  here is
  that only one 3270 command is allowed per RU chain and  it  must be the
  fist byte of the RU (similar to DSP command).

  End Chain  (EC) and segmentation  bits in the   TH  do  not   have  any
  rigid  requirements  for DSP/SNA  mapping.  From  an SNA  standpoint it
  does not  matter how the  chain is split   into  RU's  and   RU's  into
  segments  as   long  as RU  and segment lengths  do not  exceed certain
  values.  The  maximum RU  value for secondary  to primary  direction is
  defined  in   the  BIND.    Also, multiple element  RU chains  could be
  disallowed in BIND altogether.  The size of the segment is   limited by
  the size of the SDLC frame.



  120               SNA/SDLC External Reference Manual         SNAE03.D03




  Virtual Terminal Mode                                  February 1, 1988


  For this  reason  it   is  unimportant   to  have   any  correspondence
  between  the   way  the  DSP   command  is split  into X.25  and TYMNET
  packets and  the way SNA  RU chain is  split into chains  and segments.
  The  algorithm  of mapping will try to keep segments and RU's  close to
  their maximum sizes, but also leave some room there for the next TYMNET
  packet   (if it  is expected)  so  that the  mapping code  is  not over
  complicated.

  Mapping of one DSP command into one RU chain is  only  possible  if the
  BIND  parameters   are  set properly.   One DSP command  is up  to 3000
  bytes long.  This means either multiple RU  chains  should   be allowed
  in BIND or RU size should be no less than 3000. VTI gen for BIND should
  comply with this limitation.

  Change   Direction  (CD)   indicator  controls    the    direction   of
  transmission  in Half Duplex Flip-Flop mode.  An LU type 2  performs in
  this  mode of  operation while  in-bracket state.   Since VTI  will end
  bracket after every  RU chain and enter  contention mode this  bit will
  not be used.





              8.2.7  SNA/DSP terminal to host data transfer

  This direction  of exchange  is represented by   data  coming   to  VTI
  from  3274 Control Unit.

  This data  message will be  mapped into a  DSP response  message.   The
  important points to be observed during the mapping are as follows.

  DSP response  consists of segments  each of which  does not  exceed 256
  bytes.  Segments  could be chained  by the First  Segment (FS)  bit and
  ETB/ETX trailer.   The  first   byte  of  the   data  portion   of  SNA
  response  should   be  the   beginning of the  valid 3270  data stream,
  starting with AID and so on.

  Therefore, each RU chain coming from 3274 will be  translated  to a DSP
  response  message,  each  RU  chain  corresponding  to  a  separate DSP
  response.  The only important point is not to exceed the  limit  of 256
  bytes for each segment of the DSP response.

  Preserving SNA segmentation or chaining divisions of the  RU   chain by
  mapping   them   into X.25  or  TYMNET  IIX packets  is  of  no special
  importance (taking  into account  a small  256  byte   limit).   TYMNET
  packages of  maximum available length  will be used  and output  to the
  network as soon as possible.






  121               SNA/SDLC External Reference Manual         SNAE03.D03




                                                         February 1, 1988



























                *   ****  ****  ***** *   * ****  ***** *   *
               * *  *   * *   * *     **  * *   *   *    * * 
              ***** ****  ****  ****  * * * *   *   *     *  
              *   * *     *     *     *  ** *   *   *    * * 
              *   * *     *     ***** *   * ****  ***** *   *
























  122               SNA/SDLC External Reference Manual         SNAE03.D03




  Structured Fields                                      February 1, 1988






                      APPENDIX I.   Structured Fields





  LU-LU session type 1 uses the SNA Character String (SCS) data format as
  opposed to the 3270 Data Stream used by LU-LU sesion types 2 and 3. The
  SCS data maybe  sent as a structured  field by appending  length bytes,
  SCS identifier and a  reserved byte of zeroes  to the start of  the SCS
  data stream.


  The  following table  contains all  the different  types  of structured
  fields which maybe used:



  Types of Structured Fields


   ID      Name
   --      -----
   00      Reset Partition
   01      Read Partition
            02 = Query
            6E = Read Modified All
            F2 = Read Buffer
            F6 = Read Modified
   06      Load Programmed Symbols
   09      Set Reply Mode
   0B      Set Window Origin
   0C      Create Partition
   0D      Destroy Partition
   0E      Activate Partition
   40      Outbound 3270DS
  *41      SCS Data Structured Field
   80      Inbound 3270DS
   81      Query Reply
             81 Query Reply (Usable Area)
             84 Query Reply (Partitions)
             85 Query Reply (Character Sets)
             86 Query Reply (Color)
             87 Query Reply (Highlight)
             88 Query Reply (Reply Modes)
             8A Query Reply (Field Validation)

  * This is the only structured field used by 3270 LU_T1 printers.
    All LU_T1s use SCS data stream not 3270 data stream.

  123               SNA/SDLC External Reference Manual         SNAE03.D03




  Structured Fields                                      February 1, 1988


                   Table 5 - Types of Structured Fields





  The  information  in  this  Appendix was  gathered  from  the  IBM 3270
  Information Display  System Data  Stream Programmer's  Reference (GA23-
  0059-0)  chapter  7  and  the IBM  3274  Control  Unit  Description and
  Programmer's Guide (GA23-0061-0) chapter 1. The  Programmer's Reference
  did not  mention ID X'41';  this ID was  derived from  the Programmer's
  Guide.  Perhaps  the  Programmer's  Guide  is  more  current  than  the
  Programmer's Reference. For more information on structured  field refer
  to these two IBM documents.;  makeappendix;








































  124               SNA/SDLC External Reference Manual         SNAE03.D03




  Function Management Header Type 1                      February 1, 1988






             APPENDIX II.   Function Management Header Type 1





  This  appendix describes  the meaning  of each  indicator in  the FMH-1
  accepted by the 3274.



  FMH-1 Format for 3274 Controller: X'0601000B6000'

  Byte        Bit       Content      Meaning
  ----        ---       -------      -------

   0                    X'06'        Length of header including length 
                                     byte.
   1           0        B'0'         No FMH follows this FMH-1.
              1-7       B'0000001'   FMH-1 identifier

   2          0-3       X'0'         Console is desired medium for data
              4-7       X'0'         Logical subaddress

   3           0        B'0'         Stack to be used is senders send 
                                     stack.
               1        B'0'         Rcvr may direct data to alternate 
                                     medium.
              2-3       B'00'        Reserved
              4-7       X'B'         Structured Field DSP

   4          0-2       B'011'       Begin/end destination selection
               3        B'0'         Transmission exchange format
               4        B'0'         Reserved
               5        B'0'         No compression
               6        B'0'         No compaction
               7        B'0'         Reserved
   5                    X'00'        Reserved for console medium




                        Table 6 - FMH-1 Description







  125               SNA/SDLC External Reference Manual         SNAE03.D03




  Function Management Header Type 1                      February 1, 1988


  This information  was gathered  from the  SNA Sessions  Between Logical
  Units Part 2 Chapter 4.




















































  126               SNA/SDLC External Reference Manual         SNAE03.D03




                                                         February 1, 1988



























                *   ****  ****  ***** *   * ****  ***** *   *
               * *  *   * *   * *     **  * *   *   *    * * 
              ***** ****  ****  ****  * * * *   *   *     *  
              *   * *     *     *     *  ** *   *   *    * * 
              *   * *     *     ***** *   * ****  ***** *   *
























  127               SNA/SDLC External Reference Manual         SNAE03.D03




  LU Type 3 Support for VHR/VTR                          February 1, 1988






                APPENDIX I.   LU Type 3 Support for VHR/VTR





  Support for  an LU  type 3 printer  could be  provided in  the  VHR/VTR
  product.   Although VTR  will  control the  printer  via an  LU  type 3
  session, this type of session  cannot be used on a  VTR/VHR connection.
  LU type 3 does not allow for transmission of data from the  terminal to
  the host.  This means an LU  type 2 session between VTR and  VHR should
  be used instead.



  All SNA/DSP mapping for this session could be performed the same way as
  for real  LU type 2  (CRT). Every  RU chain coming  from VHR  should be
  followed by  a dummy RU  from VTR to  change direction  of transmission
  back to VHR/VTR.



  A  big  problem with  printer  support is  error  recovery.  Delays are
  inherent for the printer. For example, paper jam will cause a delay and
  the necessity to re-transmit.



  Sending -RSP in case of  such delay is probably not the  best approach.
  It is suggested that if an RU chain is already partially transmitted it
  will  be accepted  by VTR  with +RSP  and retained  there  for possible
  retransmission to 3270. But no new RU chain will be started from VHR to
  VTR until the delay condition clears. This could be achieved in  VTR by
  simply not sending the  dummy RU chain with change  direction mentioned
  above while the delay exists.



  If  such  backpressure  is  applied by  VTR  then  VHR  will experience
  accumulation of buffered data for this LU. After a short while VHR will
  pass the  backpressure signal  to the  network. HIF  on the  other side
  (say,  CMH) will  backpressure  the host  and  the print  data  will be
  stopped from sending.



  Printer logon is  no different from CRT  logon. Printer is  separate LU
  and  separate VC  and there  will  be no  knowledge within  VHR  of any
  logical or physical relations between the printer LU and any other LU.

  128               SNA/SDLC External Reference Manual         SNAE03.D03




  LU Type 3 Support for VHR/VTR                          February 1, 1988


  In other words  VTR will send printer  logon information to VHR  on the
  session for the printer LU. The logon protocol will be the same  as for
  CRT.



  Although not discussed here, the  possible option for VTR is  to obtain
  printer logon information from  the authorized CRT acting on  behalf of
  this  printer.  Another  possibility  is to  use  PVC-type  VC  for the
  printers.



  If printer logon information is obtained from a CRT there is a question
  when this information is  obtained. There might be a  requirement (like
  in TYMNET BSC interface) that the user can request printer logon at any
  time, including the period when  the CRT used to request it  is already
  in end-to-end session with remote host application.



  In this case there is a problem for VTR to backpressure any  new screen
  updates coming from VHR and to restore the screen in its previous shape
  after printer logon information was obtained.



  Backpressure could be applied from VTR to VHR the same way as described
  previously for the data going  to the printer. As far as  restoring the
  screen  is  concerned  this  is  internal  VTR  function.   A  possible
  technique is to obtain the screen content by issuing Read  Buffer, save
  it and then restore from this information.






















  129               SNA/SDLC External Reference Manual         SNAE03.D03




  INDEX                                                  February 1, 1988


  BCI  89                          INDEX
  BIU  89


  DSP  @80


  ECI  89


  FMH-1  @125
  FUNCTION MANAGEMENT HEADER TYPE
     1  125


  LU.T1 PRINTER DATA  80


  MAPPING FIELD  89


  RU  @80


  SCS  @80
  SCS UNSTRUCTURED DATA MAPPING  89
  SEGMENT  89


  WSF  @80
























  130               SNA/SDLC External Reference Manual         SNAE03.D03
    h# 