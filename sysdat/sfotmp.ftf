CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C SFOTMP.FTF       LOCATED IN (KFARHANG:38)PROG.FTF                 C
C                                                                   C
C                                                                   C
C       This program is used to breakdown the given traffic in to   c
c  different hours of a day.  For each GMT hour, the program outputsc
c  the Number of new log ins, No. of sessions present during        c
c  that hour, and the connect hours during the hour.  		    c
c                                                                   c
c  Data is in a database similar to the daily netstat.              C
c                                                                   c
c  Created by:  Keyvan Farhangian                                   c
c  Date:        9/28/1987					    c
c                                                                   c
ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
        IMPLICIT INTEGER (A-Z)
	COMMON /ONE/ ALLSES(3),POSSES(3),POSTRA(3),TSEC(3),TEMPS(3)
        COMMON /TWO/ NPOS(3,300),POS(3,300),LOGIN(3,300),SECS(3,300)
	COMMON /THR/ TNPOS(3,12),TPOS(3,12),TLOGIN(3,12),TSECS(3,12)
	COMMON /FOR/ MNPOS(3,12),MPOS(3,12),MLOGIN(3,12),MSECS(3,12)
	COMMON /FIV/ HNPOS(3,12),HPOS(3,12),HLOGIN(3,12),HSECS(3,12)
	COMMON /SIX/ PNPOS(3,12),PPOS(3,12),PLOGIN(3,12),PSECS(3,12)
	DIMENSION INFIL(5),OUTFIL(4)
	REAL PNPOS,PPOS,PLOGIN,PSECS
	REAL TEMPS

	CALL DBSTRT(-1,1,-1,1,-1,1,-1,1,-1,1,-1,1,-1,1)

	TYPE 1
 1	FORMAT(/,1X,'ENTER THE INPUT FILE NAME : ',$)
	ACCEPT 2, (INFIL(I),I=1,5)
 2	FORMAT(5A5)

        TYPE 5
 5      FORMAT(/,1X,'ENTER OUTPUT FILE NAME : ',$)
        ACCEPT 10,(OUTFIL(I),I=1,4)
 10     FORMAT(4A5)

	CALL DBOPEN(INFIL)
	OPEN(20,OUTFIL,OUTPUT)
C
C      INITIALIZATION
C
        DO 30 J=1,3
	   ALLSES(J)=0
	   POSSES(J)=0
	   POSTRA(J)=0
	   TSEC(J)=0
	   TEMPS(J)=0.
	   DO 15 L=1,12
	      TNPOS(J,L)=0
	      MNPOS(J,L)=0
	      HNPOS(J,L)=0
	      TPOS(J,L)=0
	      MPOS(J,L)=0
	      HPOS(J,L)=0
	      TLOGIN(J,L)=0
	      MLOGIN(J,L)=0
	      HLOGIN(J,L)=0
              TSECS(J,L)=0
              MSECS(J,L)=0
              HSECS(J,L)=0
 15	   CONTINUE
           DO 20 I=1,300
              LOGIN(J,I)=0
              NPOS(J,I)=0
              POS(J,I)=0
	      SECS(J,I)=0
 20        CONTINUE
 30     CONTINUE
C
C	THIS SECTION OF THE PROGRAM IS TO HANDLE BANDS 4 AND 5 OF SAN FRANCISCO
C	ROTARY.
C
	DO 32 IND=1,2
	   CALL ALL(IND)
 32	CONTINUE
C
C       PRINT HEADING.
C
	CALL HEADING
C
C       PRINT HOURLY LOGINS AND CONNECT TIME (HOUR).
C
	WRITE(20,33)
 33	FORMAT(18X,6HLOGINS,21X,20HCONNECT TIME (HOURS)/
     -         7X,31(1H-),4X,31(1H-))
	WRITE(20,34)
 34	FORMAT(3H HR,9H    BAND4,9H    BAND5,11X,6HROTARY
     -              ,9H    BAND4,9H    BAND5,11X,6HROTARY)
     	WRITE(20,35)
 35	FORMAT(3H --,2(2(4X,5(1H-)),11X,6(1H-)))
	DO 100 I=1,288
	   J=MOD(I,24)
	   IF(J.EQ.0) J=24
	   SECS(3,I)=SECS(1,I)+SECS(2,I)
           DO 36 IL=1,3
	      TEMPS(IL)=(SECS(IL,I)*1.)/3600.
 36        CONTINUE
	   LOGIN(3,I)=LOGIN(1,I)+LOGIN(2,I)
	   WRITE(20,40) J,(LOGIN(L,I),L=1,3),(TEMPS(L),L=1,3)
 40	   FORMAT(1X,I2,2(1X,I8),1X,I16,2(1X,F8.2),1X,F16.2)
 100	CONTINUE
C
C       PRINT NON-POS AND POS TRANSACTIONS.
C
	WRITE(20,101)
 101	FORMAT(//8X,20HNON-POS TRANSACTIONS,17X,16HPOS TRANSACTIONS/
     -         7X,31(1H-),4X,31(1H-))
	WRITE(20,102)
 102	FORMAT(3H HR,9H    BAND4,9H    BAND5,11X,6HROTARY
     -              ,9H    BAND4,9H    BAND5,11X,6HROTARY)
     	WRITE(20,103)
 103	FORMAT(3H --,2(2(4X,5(1H-)),11X,6(1H-)))
	DO 200 I=1,288
	   J=MOD(I,24)
	   IF(J.EQ.0) J=24
	   NPOS(3,I)=NPOS(1,I)+NPOS(2,I)
	   POS(3,I)=POS(1,I)+POS(2,I)
	   WRITE(20,140) J,(NPOS(L,I),L=1,3),(POS(L,I),L=1,3)
 140	   FORMAT(1X,I2,2(2(1X,I8),1X,I16))
 200	CONTINUE
C
C       COMPUTE AND PRINT DAILY (GMT) LOGINS, NON-POS AND POS
C       TRANSACTIONS, AND CONNECT TIME (SECOND).
C
        CALL DAILY(0)
	CALL DPRINT
C
C	COMPUTE AND PRINT DAILY (CNT) LOGINS, NON-POS AND POS
C	TRANSACTIONS, AND CONNECT TIME (SECONDS).
C
C	CALL DAILY(5)
C	CALL DPRINT

	WRITE(20,234)
 234	FORMAT(//7X,9H    BAND4,7X,9H    BAND5,5X,6HROTARY)
     	WRITE(20,235)
 235	FORMAT(2(11X,5(1H-)),5X,6(1H-))
	ALLSES(3)=ALLSES(1)+ALLSES(2)
	WRITE(20,605) (ALLSES(L),L=1,3)
	POSSES(3)=POSSES(1)+POSSES(2)
	WRITE(20,605) (POSSES(L),L=1,3)
	POSTRA(3)=POSTRA(1)+POSTRA(2)
	WRITE(20,605) (POSTRA(L),L=1,3)
	TSEC(3)=TSEC(1)+TSEC(2)
	WRITE(20,605) (TSEC(L),L=1,3)
 605    FORMAT(1X,2(I15,1X),I10)
        CLOSE(20)
        STOP
        END

	SUBROUTINE DAILY(IJ)
	IMPLICIT INTEGER (A-Z)
	COMMON /ONE/ ALLSES(3),POSSES(3),POSTRA(3),TSEC(3),TEMPS(3)
        COMMON /TWO/ NPOS(3,300),POS(3,300),LOGIN(3,300),SECS(3,300)
	COMMON /THR/ TNPOS(3,12),TPOS(3,12),TLOGIN(3,12),TSECS(3,12)
	COMMON /FOR/ MNPOS(3,12),MPOS(3,12),MLOGIN(3,12),MSECS(3,12)
	COMMON /FIV/ HNPOS(3,12),HPOS(3,12),HLOGIN(3,12),HSECS(3,12)
	COMMON /SIX/ PNPOS(3,12),PPOS(3,12),PLOGIN(3,12),PSECS(3,12)
	REAL PNPOS,PPOS,PLOGIN,PSECS
	REAL TEMPS
	DO 600 K=1,3
	DO 500 I=1,12
	   J1= 1+(I-1)*24+IJ
	   J2=24+(I-1)*24+IJ
	   T1=0
	   T2=0
           T3=0
	   T4=0
	   M1=0
	   M2=0
           M3=0
	   M4=0
	   H1=0
	   H2=0
           H3=0
	   H4=0
	   DO 400 J=J1,J2
	      T1=T1+LOGIN(K,J)
	      IF(LOGIN(K,J).GT.M1) H1=J-(I-1)*24
	      IF(LOGIN(K,J).GT.M1) M1=LOGIN(K,J)
	      T2=T2+NPOS(K,J)
	      IF(NPOS(K,J).GT.M2) H2=J-(I-1)*24
	      IF(NPOS(K,J).GT.M2) M2=NPOS(K,J)
	      T3=T3+POS(K,J)
	      IF(POS(K,J).GT.M3) H3=J-(I-1)*24
	      IF(POS(K,J).GT.M3) M3=POS(K,J)
	      T4=T4+SECS(K,J)
	      IF(SECS(K,J).GT.M4) H4=J-(I-1)*24
	      IF(SECS(K,J).GT.M4) M4=SECS(K,J)
 400	   CONTINUE
	   TLOGIN(K,I)=T1
	   MLOGIN(K,I)=M1
	   PLOGIN(K,I)=(M1*100.)/(T1*1.)
	   HLOGIN(K,I)=H1
	   TNPOS(K,I)=T2
	   MNPOS(K,I)=M2
	   PNPOS(K,I)=(M2*100.)/(T2*1.)
	   HNPOS(K,I)=H2
	   TPOS(K,I)=T3
	   MPOS(K,I)=M3
	   PPOS(K,I)=(M3*100.)/(T3*1.)
	   HPOS(K,I)=H3
	   TSECS(K,I)=T4
	   MSECS(K,I)=M4
	   PSECS(K,I)=(M4*100.)/(T4*1.)
	   HSECS(K,I)=H4
 500	CONTINUE
 600	CONTINUE
        RETURN
	END

	SUBROUTINE DPRINT
	IMPLICIT INTEGER (A-Z)
	COMMON /ONE/ ALLSES(3),POSSES(3),POSTRA(3),TSEC(3),TEMPS(3)
        COMMON /TWO/ NPOS(3,300),POS(3,300),LOGIN(3,300),SECS(3,300)
	COMMON /THR/ TNPOS(3,12),TPOS(3,12),TLOGIN(3,12),TSECS(3,12)
	COMMON /FOR/ MNPOS(3,12),MPOS(3,12),MLOGIN(3,12),MSECS(3,12)
	COMMON /FIV/ HNPOS(3,12),HPOS(3,12),HLOGIN(3,12),HSECS(3,12)
	COMMON /SIX/ PNPOS(3,12),PPOS(3,12),PLOGIN(3,12),PSECS(3,12)
	REAL PNPOS,PPOS,PLOGIN,PSECS
	REAL TEMPS
	WRITE(20,29)
 29	FORMAT(//23HT = TOTAL CONNECT HOURS)
	WRITE(20,30)
 30	FORMAT(22HM = PEAK CONNECT HOURS)
	WRITE(20,31)
 31	FORMAT(30HP = PEAK % TOTAL CONNECT HOURS)
	WRITE(20,32)
 32	FORMAT(13HH = PEAK HOUR)
	WRITE(20,33)
 33	FORMAT(//18X,6HLOGINS,21X,20HCONNECT TIME (HOURS)/
     -         7X,31(1H-),4X,31(1H-))
	WRITE(20,34)
 34	FORMAT(3HDAY,9H    BAND4,9H    BAND5,11X,6HROTARY
     -              ,9H    BAND4,9H    BAND5,11X,6HROTARY)
     	WRITE(20,35)
 35	FORMAT(3H---,2(2(4X,5(1H-)),11X,6(1H-)))
	DO 306 I=1,12
           DO 300 IL=1,3
	      TEMPS(IL)=(TSECS(IL,I)*1.)/3600. 
 300       CONTINUE
	   WRITE(20,301) I,(TLOGIN(L,I),L=1,3),(TEMPS(L),L=1,3)
 301	   FORMAT(I2,1HT,2(1X,I8),1X,I16,2(1X,F8.2),1X,F16.2)
           DO 302 IL=1,3
	      TEMPS(IL)=(MSECS(IL,I)*1.)/3600. 
 302       CONTINUE
	   WRITE(20,303)   (MLOGIN(L,I),L=1,3),(TEMPS(L),L=1,3)
 303	   FORMAT(2X,1HM,2(1X,I8),1X,I16,2(1X,F8.2),1X,F16.2)
	   WRITE(20,304)   (PLOGIN(L,I),L=1,3),(PSECS(L,I),L=1,3)
 304	   FORMAT(2X,1HP,2(2(1X,F8.1),1X,F16.1))
	   WRITE(20,305)   (HLOGIN(L,I),L=1,3),(HSECS(L,I),L=1,3)
 305	   FORMAT(2X,1HH,2(2(1X,I8),1X,I16))
 306	CONTINUE
	WRITE(20,101)
 101	FORMAT(//8X,20HNON-POS TRANSACTIONS,17X,16HPOS TRANSACTIONS/
     -         7X,31(1H-),4X,31(1H-))
	WRITE(20,102)
 102	FORMAT(3HDAY,9H    BAND4,9H    BAND5,11X,6HROTARY
     -              ,9H    BAND4,9H    BAND5,11X,6HROTARY)
     	WRITE(20,103)
 103	FORMAT(3H---,2(2(4X,5(1H-)),11X,6(1H-)))
	DO 407 I=1,12
	   WRITE(20,403) I,(TNPOS(L,I),L=1,3),(TPOS(L,I),L=1,3)
 403	   FORMAT(I2,1HT,2(2(1X,I8),1X,I16))
	   WRITE(20,404)   (MNPOS(L,I),L=1,3),(MPOS(L,I),L=1,3)
 404	   FORMAT(2X,1HM,2(2(1X,I8),1X,I16))
	   WRITE(20,405)   (PNPOS(L,I),L=1,3),(PPOS(L,I),L=1,3)
 405	   FORMAT(2X,1HP,2(2(1X,F8.1),1X,F16.1))
	   WRITE(20,406)   (HNPOS(L,I),L=1,3),(HPOS(L,I),L=1,3)
 406	   FORMAT(2X,1HH,2(2(1X,I8),1X,I16))
 407	CONTINUE
        RETURN
	END

	SUBROUTINE ALL(IND)
        IMPLICIT INTEGER (A-Z)
	COMMON /ONE/ ALLSES(3),POSSES(3),POSTRA(3),TSEC(3),TEMPS(3)
        COMMON /TWO/ NPOS(3,300),POS(3,300),LOGIN(3,300),SECS(3,300)
	COMMON /THR/ TNPOS(3,12),TPOS(3,12),TLOGIN(3,12),TSECS(3,12)
	COMMON /FOR/ MNPOS(3,12),MPOS(3,12),MLOGIN(3,12),MSECS(3,12)
	COMMON /FIV/ HNPOS(3,12),HPOS(3,12),HLOGIN(3,12),HSECS(3,12)
	COMMON /SIX/ PNPOS(3,12),PPOS(3,12),PLOGIN(3,12),PSECS(3,12)
	REAL PNPOS,PPOS,PLOGIN,PSECS
	REAL TEMPS,TEMP1,TEMP2

	IF(IND.EQ.1) CALL DBEXEC('FI FILE B4SFO.5')
	IF(IND.EQ.2) CALL DBEXEC('FI FILE B5SFO.5')
	CALL DBNREC(ALLSES(IND))
 100    CONTINUE
	CALL DBGREC($280)
	CALL DBVAL('STARTDATE',SDATE,'STIMESEC',SSEC)
	CALL DBVAL('ENDDATE',EDATE,'ETIMESEC',ESEC)
	CALL DBVAL('TOTMIN',TOTMIN,'MPVCSESS',MPVC)
	IF(SDATE.LE.EDATE) GOTO 102
	ALLSES(IND)=ALLSES(IND)-1
	GOTO 100
 102	CONTINUE
	TMPVC=MPVC
C	TMPVC=0
C	IF(POS SESSION .AND. (MPVC.EQ.0)) TMPVC=1
C	IF(POS SESSION .AND. (MPVC.NE.0)) TMPVC=MPVC

C	compute total seconds
C
	TOTSEC=ESEC-SSEC
	IF(SDATE.EQ.EDATE) GOTO 120
	L=EDATE-SDATE
	DO 110 I=1,L
	   TOTSEC=TOTSEC+86400
 110	CONTINUE
 120	CONTINUE
	
	IF(TOTSEC.GT.0) GOTO 125
	ALLSES(IND)=ALLSES(IND)-1	
	GOTO 100
 125	CONTINUE
C
C  ASSUME OVERHEAD (LOGIN TIME) FOR NON-POS SESSION IS 30 SECONDS.
C  ASSUME OVERHEAD FOR POS SESSION IS 10 SECONDS.
C
	IF(MPVC.NE.0) GOTO 128
	IF(TMPVC.NE.0) GOTO 127
	TOTSEC=TOTSEC+30
	SSEC=SSEC-30
        IF(SSEC.LT.0) SDATE=SDATE-1
	IF(SSEC.LT.0) SSEC=SSEC+86400
	GOTO 129
 127    CONTINUE
	TOTSEC=TOTSEC+10
	SSEC=SSEC-10
        IF(SSEC.LT.0) SDATE=SDATE-1
	IF(SSEC.LT.0) SSEC=SSEC+86400
	GOTO 129
 128    CONTINUE
	IF(TOTSEC.LE.900) GOTO 129
	ESEC=ESEC-900
	TOTSEC=TOTSEC-900
	IF(ESEC.LT.0) EDATE=EDATE-1
	IF(ESEC.LT.0) ESEC=ESEC+86400
	SSEC=SSEC-10
	TOTSEC=TOTSEC+10
	IF(SSEC.LT.0) SDATE=SDATE-1
	IF(SSEC.LT.0) SSEC=SSEC+86400
 129	CONTINUE

	CALL FINDSE(SDATE,EDATE,START,END,SSEC,ESEC)
	IF((START.EQ.0).AND.(END.EQ.0)) GOTO 130
	IF(END.EQ.0) GOTO 130
	IF(END.LT.START) GOTO 130
	IF(START.NE.0) GOTO 131
	START=1
	SSEC=1
	GOTO 131
 130	CONTINUE
 	WRITE(20,101) START,END
 101	FORMAT(1X,'START ',I5,5X,'END ',I5)
	ALLSES(IND)=ALLSES(IND)-1	
	GOTO 100
 131	CONTINUE
	IF(TMPVC.EQ.0) TSEC(IND)=TSEC(IND)+TOTSEC
	IF(TMPVC.NE.0) POSSES(IND)=POSSES(IND)+1
	IF(TMPVC.NE.0) POSTRA(IND)=POSTRA(IND)+TMPVC
C
C	FIND THE NUMBER OF LOGINS.
C	FIND THE NUMBER OF USERS NON-POS AND POS TRANSACTIONS.
C       FIND THE CONNECT TIME.  
C
C	ASSUME A POS TRANSACTION LASTS 12 SECONDS
C       AND HAS 10 SECONDS OVERHEAD.
C
	IF(TMPVC.NE.0) GOTO 180
	LOGIN(IND,START)=LOGIN(IND,START)+1
	DO 135 I=START,END
	   NPOS(IND,I)=NPOS(IND,I)+1
 135	CONTINUE
	TEMP1=0.
	TEMP2=1.
	GOTO 190
 180	CONTINUE
	IF(TOTSEC.EQ.0) TYPE 181
 181	FORMAT(1X,10HWARNING181)
	TEMP1=(MPVC*1.)/(TOTSEC*1.)
	TEMP2=(MPVC*22.)/(TOTSEC*1.)
	IF(MPVC.NE.0) GOTO 190
	LOGIN(IND,START)=LOGIN(IND,START)+1
	DO 182 I=START,END
	   POS(IND,I)=POS(IND,I)+1
 182	CONTINUE
	TEMP1=0.
	TEMP2=1.
 190	CONTINUE
	CALL DIVIDE(IND,END,START,SSEC,ESEC,TOTSEC,TEMP1,TEMP2)
	GOTO 100
 280	CONTINUE
	RETURN
	END

	SUBROUTINE FINDSE(SDATE,EDATE,START,END,SSEC,ESEC)
        IMPLICIT INTEGER (A-Z)
	REAL TEMP
	TEMP=(SSEC*1.)/3600.
	L=INT(TEMP)
	CALL DATE(SDATE,START,L)
	TEMP=(ESEC*1.)/3600.
	L=INT(TEMP)
	CALL DATE(EDATE,END,L)
	RETURN
	END

	SUBROUTINE DATE(I,J,L)
	IMPLICIT INTEGER (A-Z)
	J=0
	IF(I.EQ.871229) J=1  + L
	IF(I.EQ.871230) J=25 + L
	IF(I.EQ.871231) J=49 + L
	IF(I.EQ.880100) J=49 + L
	IF(I.EQ.880101) J=73 + L
	IF(I.EQ.880102) J=97 + L
	IF(I.EQ.880103) J=121+ L
	IF(I.EQ.880104) J=145+ L
	IF(I.EQ.880105) J=169+ L
	IF(I.EQ.880106) J=193+ L
	IF(I.EQ.880107) J=217+ L
	IF(I.EQ.880108) J=241+ L
	IF(I.EQ.880109) J=265+ L
	RETURN
	END

	SUBROUTINE HEADING
	IMPLICIT INTEGER (A-Z)
	WRITE(20,10)
 10	FORMAT(13HSAN FRANCISCO/13(1H-)//4HDATE/4(1H-))
	WRITE(20,20)
 20	FORMAT(6H871229/6H871230/6H871231/6H880101/6H880102/6H880103
     -  /6H880104/6H880105/6H880106/6H880107/6H880108/6H880109/)
	RETURN
	END

	SUBROUTINE DIVIDE(IND,END,START,SSEC,ESEC,TOTSEC,TEMP1,TEMP2)
        IMPLICIT INTEGER (A-Z)
	COMMON /ONE/ ALLSES(3),POSSES(3),POSTRA(3),TSEC(3),TEMPS(3)
        COMMON /TWO/ NPOS(3,300),POS(3,300),LOGIN(3,300),SECS(3,300)
	COMMON /THR/ TNPOS(3,12),TPOS(3,12),TLOGIN(3,12),TSECS(3,12)
	COMMON /FOR/ MNPOS(3,12),MPOS(3,12),MLOGIN(3,12),MSECS(3,12)
	COMMON /FIV/ HNPOS(3,12),HPOS(3,12),HLOGIN(3,12),HSECS(3,12)
	COMMON /SIX/ PNPOS(3,12),PPOS(3,12),PLOGIN(3,12),PSECS(3,12)
	REAL PNPOS,PPOS,PLOGIN,PSECS
	REAL TEMPS,TEMP1,TEMP2
	IF(START.NE.END) GOTO 100
	LOGIN(IND,END)=LOGIN(IND,END)+TEMP1*TOTSEC
	POS(IND,END)=POS(IND,END)+TEMP1*TOTSEC
	SECS(IND,END)=SECS(IND,END)+TEMP2*TOTSEC
	RETURN
 100	CONTINUE
	LOGIN(IND,START)=LOGIN(IND,START)+TEMP1*(3600-MOD(SSEC,3600))
	LOGIN(IND,END)=LOGIN(IND,END)+TEMP1*MOD(ESEC,3600)
	POS(IND,START)=POS(IND,START)+TEMP1*(3600-MOD(SSEC,3600))
	POS(IND,END)=POS(IND,END)+TEMP1*MOD(ESEC,3600)
	SECS(IND,START)=SECS(IND,START)+TEMP2*(3600-MOD(SSEC,3600))
	SECS(IND,END)=SECS(IND,END)+TEMP2*MOD(ESEC,3600)
	IF(END-START.EQ.1) RETURN
	I1=START+1
	I2=END-1
	DO 190 I=I1,I2
	  LOGIN(IND,I)=LOGIN(IND,I)+TEMP1*3600
	  POS(IND,I)=POS(IND,I)+TEMP1*3600
	  SECS(IND,I)=SECS(IND,I)+TEMP2*3600
 190	CONTINUE
	RETURN
	END
   