CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C       PROGRAM: TOPONC
C       AUTHOR: JO ANN JOELS
C       CREATED: FEB. 1985
C       
C       THIS PROGRAM (TOP ORIGNODE) CREATES A REPORT
C       WHICH LIST FOR ONE GIVEN DAY IN DESCENDING ORDER
C       THE NUMBER OF CHARACTERS WHICH ORIGINATED ON EACH NODE.
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC

        CALL DBSTRT(1,0,1,0,1,0,1,0,1,0,1,0)

        INTEGER NFILE(4),OFILE(2),DATE(6),FILE(3),NAME,EXT,FILNUM(3)

        DATA (FILE(I),I=1,3)/'A','B','C'/,(FILNUM(I),I=1,3)/'1','2','3'/

        NUMFIL=0
CCCCC
C GET THE DAY TO BE PROCEDSSED
CCCCC
100     TYPE 105
105     FORMAT (1X,'ENTER DATE TO PROCESS- (YYMMDD): ',$)
        ACCEPT 110,DATE
110     FORMAT (6A1)

CCCCC
C GET THE REPORT FILE NAME
CCCCC
120     TYPE 125
125     FORMAT (1X,'ENTER FILE NAME FOR REPORT - (5 CHAR NAME,'
     1  ' 3 CHAR EXT): ',$)
        ACCEPT 130,OFILE
130     FORMAT (4A5)

CCCCC
C GET DATA FROM THE 3 DAILY NETSTAT FILES
CCCCC
200     DO 350 I=1,3
        L=FILE(I)

CCCCC
C CREATE THE NETSTAT FILE NAME FROM THE DATE
CCCCC
205     ENCODE(19,210,NFILE)(DATE(II),II=2,6),L
210     FORMAT ('(NETSTAT)',6A1,'.DMS')

CCCCC
C OPEN THE DATA BASE
CCCCC
300     CALL DBERR($400)
        CALL DBOPEN(NFILE)
        CALL DBERR(0)
        NUMFIL=NUMFIL+1
        IF (I.EQ.1)CALL DBEXEC('INIT 1 TOPONC.DMI')

CCCCC
C FIND ALL RECORDS IN THE NETSTAT DATA BASE AND ISSUE THE 
C VALUES COMMAND.
CCCCC
310     CALL DBFIND('ALL')
        CALL DBEXEC('VALUE ON TOPONC.DAT ORIGNODE')

CCCCC
C NOW OPEN THE 'VALUES' FILE AND READ AN ORIGNODE NUMBER
CCCCC
320     OPEN(21,'TOPONC.DAT',INPUT)
330     READ (21,335,END=345)ION
335     FORMAT (I)

CCCCC
C
C FIND ALL RECORDS IN THE NETSTAT DATA BASE FOR THIS ORIGNODE
C AND EVALUATE THE TOTAL NUMBER OF CHARACTERS WHICH ORIGINATED ON
C THIS NODE
CCCCC
340     CALL DBFIND('ORIGNODE','EQ',ION)
        CALL DBEXEC('EVALUATE INODE ORIGNODE ICHAR TOT TOTALCHARS')
        CALL DBEXEC('PRINT INODE ICHAR FORMAT I5 1X I12 END.')

CCCCC
C GO READ NEXT ORIGNODE
CCCCC
        GOTO 330


CCCCC
C GO PROCESS THE NEXT NETSTAT FILE
CCCCC
345     CLOSE(21)
350     CONTINUE

CCCCC
C LOAD THE CHARACTER DATA FILE INTO 1022
CCCCC
400     CALL DBEXEC('RELEASE 1')
        IF (NUMFIL.GT.0) GO TO 450
        TYPE 405,(DATE(I),I=1,6)
405     FORMAT (1X,'NO NETSTATS DATA IS AVAILABLE FOR THIS DAY: ',6A1)
        GO TO 900
450     CALL DBEXEC('LOAD TOPONC')

CCCCC
C CREATE THE FIRST REPORT
CCCCC
500     CALL DBEXEC('USE TOPONC')

CCCCC
C NOW LOAD THE OUTPUT FROM THIS REPORT. AND CREATE THE 
C FINAL REPORT.
CCCCC
550     CALL DBEXEC('LOAD TOPO2')
        CALL DBEXEC('USE TOPO2')

CCCCC
C THE REPORT IS READY IN FILE: TOPON2.RPT.  RENAME THIS FILE TO
C GIVE IT THE NAME THAT THE USER WANTS IT TO HAVE.
CCCCC
600     K=1
        DO 610 I=1,2
        DO 610 J=1,5
        CALL RTC(ICHAR,OFILE(I),J)
        IF (ICHAR.EQ.' ') GOTO 620
        IF (IEXT.EQ.1)GOTO 607
        IF (ICHAR.EQ.'.')GOTO 605
        CALL STC(ICHAR,NAME,J)
        GOTO 610

605     IEXT=1
        GOTO 610

607     CALL STC(ICHAR,EXT,K)
        K=K+1
610     CONTINUE
620     CALL RENAME('TOPO2','RPT',NAME,EXT,0,IERR)
CCCCC
C CLOSE THE DATA BASE
CCCCC
700     CALL DBCLOS

CCCCC
C FINSIHED. QUIT
CCCCC
900     CALL DBEND
        END


CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C SUBROUTINE: FIX
C
C THIS SUBROUTINE CREATES A FIXED FORMAT FILE FROM
C AN OUTPUT FILE CONTAINING THE OUTPUT FROM THE 1022
C VALUES COMMAND.
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
        SUBROUTINE FIX(FILNUM)

        IMPLICIT INTEGER (A-Z)
        DIMENSION FILE1(2),FILE2(2)


        ENCODE(10,105,FILE1)FILNUM
105     FORMAT('TOPON',A1,'.DAT')
        ENCODE(10,107,FILE2)FILNUM
107     FORMAT('TOPON',A1,'.DMI')
110     OPEN (21,FILE1,INPUT)
        OPEN (22,FILE2,OUTPUT)
115     READ(21,120,END=200)THOST,SESS
120     FORMAT (I,1X,I)
        WRITE(22,130)THOST,SESS
130     FORMAT (I5,1X,I5)
        GO TO 115
200     CLOSE(21)
        CLOSE(22)
        RETURN
        END
