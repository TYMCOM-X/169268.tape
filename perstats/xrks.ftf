CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C                                                                       C
C       SUBROUTINE: XRKS                                                C
C                                                                       C
C       THIS SUBROUTINE GETS LINK STATISTICS INFORMATION FROM OUTPUT    C
C       FROM THE XRAY KS COMMAND.  THE OUPUT MUST BE IN THE FORMAT OF   C
C       AN ARRAY AS RETURNED FROM THE AXMOUT SUBROUTINE.                C
C                                                                       C
C       FORMAT: CALL XRKS(OUTDEV,NODE,NEIGH,XRHOLD,XRHSIZ,LLINE)       C
C       ARGUMENTS:                                                      C
C           OUTDEV - DEVICE NUMBER TO WRITE DATA TO DISK                C
C           NODE   - NODE DATA WAS COLLECTED FROM                       C
C           NEIGH  - NEIGHBOR NUMBERR                                   C
C           XRHOLD: INPUT - ARRAY CONTAINING THE OUTPUT FROM AXMOUT.    C
C           XRHSIZ - MAX NUMBER OF LINES IN XRHOLD.  XRHOLD WILL BE      C
C                    DIMENSIONED TO XRHSIZ * 80.                         C
C           LLINE:  INPUT - LAST LINE OF INFORMATION IN XRHOLD.         C
C                                                                       C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC

        SUBROUTINE XRKS(OUTDV1,OUTDV2,OUTTYP,NODE,NEIGH,XRHOLD,
     +  XRHSIZ,LLINE,ECOUNT,ENDFLG,EARRAY,PAGE)

        INTEGER XRHSIZ,XRHOLD(XRHSIZ,80),LLINE,OUTDV1,NODE,NEIGH,CDATE,
     1          SDATE(2),STIME,LCPSI,LHWIN,LCPOU,LHWOU,PCPSI,PHWIN,
     2          PCPSO,PHWOU,OVHDI,OVHDO,UTLZI,UTLZO,CPSIN,CPSOU,CKTS,
     3          PKTSP,PKTSI,PKSTR,DLAIN,DLTEA,DLBUF,DLOUT,DLXMI,DLTOT,
     4          OVLDC,SATRC,BKLGC,PKTSM,IDLCA,CLINE,ONELIN(80),OUTDV2,
     +          OUTTYP,NAMES(49,3),EARRAY(49,8),ECOUNT,PAGE,ENDFLG,
     +          CTIME,LINES(4,4),LINENO

        DATA LCPSI,LHWIN,LCPOU,LHWOU,PCPSI,PHWIN,PCPSO/7*0/
        DATA PHWOU,OVHDI,OVHDO,UTLZI,UTLZO,CPSIN,CPSOU,CKTS/8*0/
        DATA PKTSP,PKTSI,PKTSR,DLAIN,DLTEA,DLBUF,DLOUT,DLXMI,DLTOT/9*0/
        DATA OVLDC,SATRC,BKLGC,PKTSM,IDLCA/5*0/
        DATA ((NAMES(I,J),J=1,3),I=1,29)/'NODE',' ',' ','NEIGH','BOR',
     +  ' ','CDATE',' ',' ','CTIME',' ',' ','LOGCP','S IN',' ','LOGCP',
     +  'S IN ','HW','LOGCP','S OUT',' ','LOGCP','S OUT',' HW',
     +  'PHYCP','S IN',' ','PHYCP','S IN ','HW','PHYCP','S OUT',' ',
     +  'PHYCP','S OUT',' HW','PACK ',
     +  'OVHD ','IN','PACK ','OVHD ','OUT','UTIL ','IN',' ','UTIL ',
     +  'OUT',' ','CHAR/','SEC I','N','CHAR/','SEC O','UT',
     +  'CIRCU','ITS',' ','PACK/','SEC',' ','PACK ','AVG S','IZ',
     +  'RECOR','DS/PA','CK','LDELA','Y IN-','Q','LDELA','Y RTE',
     +  'AR','LDELA','Y BUF','FR','LDELA','Y OUT','-Q','LDELA',
     +  'Y XMI','T','LDELA','Y TOT','AL','OVERL','OAD C','NT'/
        DATA ((NAMES(I,J),J=1,3),I=30,49)/'SATUR','ATE C','NT',
     +  'BACKL','LOG C','NT','PACKE','TS MA','DE','IDLE ','CALLS',' ',
     +  'LINE ','NUMBE','R','MARKI','NG',' ','REXMI','SSION','S',
     +  'XMISS','IONS',' ',
     +  'LINE ','NUMBE','R','MARKI','NG',' ','REXMI','SSION','S',
     +  'XMISS','IONS',' ',
     +  'LINE ','NUMBE','R','MARKI','NG',' ','REXMI','SSION','S',
     +  'XMISS','IONS',' ',
     +  'LINE ','NUMBE','R','MARKI','NG',' ','REXMI','SSION','S',
     +  'XMISS','IONS',' '/

        CLINE=1
        LINENO=1

CCCCC
C IF ENDFLG = 1, THEN FINISHED WITH DATA COLLECTTION. GO WRITE
C LAST PAGE OF FORMATTED OUTPUT.
CCCCC
        IF (ENDFLG.EQ.1) GOTO 970

CCCCC
C GET DATE AND TIME AND CONVERT THEM
CCCCC
90      CALL DATE(SDATE)
        CALL TIME(STIME)
        CALL DATCON(SDATE,CDATE,IERR)
        CALL TIMCON(STIME,CTIME,IERR)

CCCCC
C IF THIS LINE BEGINS WITH A BLANK THEN IGNORE IT.
CCCCC
100     IF (XRHOLD(CLINE,1).NE.' ')GOTO 150
        CLINE=CLINE+1
        IF (CLINE.EQ.LLINE)GOTO 900
        GOTO 100

CCCCC
C THIS LINE CONTAINS SOMETHING BESIDES BLANKS. BRANCH ON VALUE OF
C FIRST WORD OF LINE.
CCCCC
150     IF (XRHOLD(CLINE,1).EQ.'L' .AND. XRHOLD(CLINE,2).EQ.'O' .AND.
     1      XRHOLD(CLINE,3).EQ.'G' .AND. XRHOLD(CLINE,4).EQ.'I')
     2     GOTO 200
        IF (XRHOLD(CLINE,1).EQ.'P' .AND. XRHOLD(CLINE,2).EQ.'H' .AND.
     1      XRHOLD(CLINE,3).EQ.'Y' .AND. XRHOLD(CLINE,4).EQ.'S')
     2     GOTO 250
        IF (XRHOLD(CLINE,1).EQ.'P' .AND. XRHOLD(CLINE,2).EQ.'A' .AND.
     1      XRHOLD(CLINE,3).EQ.'C' .AND. XRHOLD(CLINE,4).EQ.'K')
     2     GOTO 300
        IF (XRHOLD(CLINE,1).EQ.'B' .AND. XRHOLD(CLINE,2).EQ.'A' .AND.
     1      XRHOLD(CLINE,3).EQ.'N' .AND. XRHOLD(CLINE,4).EQ.'D')
     2     GOTO 400
        IF (XRHOLD(CLINE,1).EQ.'C' .AND. XRHOLD(CLINE,2).EQ.'H' .AND.
     1      XRHOLD(CLINE,3).EQ.'A' .AND. XRHOLD(CLINE,4).EQ.'R')
     2     GOTO 450
        IF (XRHOLD(CLINE,1).EQ.'L' .AND. XRHOLD(CLINE,2).EQ.'I' .AND.
     1      XRHOLD(CLINE,3).EQ.'N' .AND. XRHOLD(CLINE,4).EQ.'K' .AND.
     2      XRHOLD(CLINE,6).NE.':')
     3     GOTO 500
        IF (XRHOLD(CLINE,1).EQ.'O' .AND. XRHOLD(CLINE,2).EQ.'V' .AND.
     1      XRHOLD(CLINE,3).EQ.'E' .AND. XRHOLD(CLINE,4).EQ.'R')
     2     GOTO 550
        IF (XRHOLD(CLINE,1).EQ.'L' .AND. XRHOLD(CLINE,2).EQ.'I' .AND.
     1      XRHOLD(CLINE,3).EQ.'N' .AND. XRHOLD(CLINE,4).EQ.'E')
     2     GOTO 600

C       CCCCC
C       C THIS LINE DOESN'T CONTAIN SOMETHING THAT WE ARE LOOKING
C       C FOR, SO CONTINUE
C       CCCCC
        CLINE=CLINE+1
        IF (CLINE.EQ.LLINE) GOTO 900
        GO TO 100

CCCCC
C THE NEXT LINE CONTAINS INFORMATION THAT WE WANT. PUT THIS LINE
C INTO A TEMP ARRAY SO THAT IT CAN BE SCANNED BY THE SCANNING
C SUBROUTINES.
CCCCC
200     CLINE=CLINE+1
        DO 210 I=1,80
        ONELIN(I)=XRHOLD(CLINE,I)
210     CONTINUE

C       CCCCC
C       C GET ALL STATISTICS ON THE LINE
C       CCCCC
220     CALL AXISCA(ONELIN,14,LCPSI,IERR)
        CALL AXISCA(ONELIN,29,LHWIN,IERR)

C       CCCCC
C       C NEXT LINE ALSO CONTAINS LOGICAL LINK STATS, GET THEM
C       CCCCC
        CLINE=CLINE+1
        DO 225 I=1,80
        ONELIN(I)=XRHOLD(CLINE,I)
225     CONTINUE

C       CCCCC
C       C GET ALL STATISTICS ON THE LINE
C       CCCCC
227     CALL AXISCA(ONELIN,14,LCPOU,IERR)
        CALL AXISCA(ONELIN,29,LHWOU,IERR)

C       CCCCC
C       C FINISHED WITH THIS LINE. GO LOOK AT NEXT
C       CCCCC
230     CLINE=CLINE+1
        GOTO 100


CCCCC
C THE NEXT LINE CONTAINS INFORMATION THAT WE WANT. PUT THIS LINE
C INTO A TEMP ARRAY SO THAT IT CAN BE SCANNED BY THE SCANNING
C SUBROUTINES.
CCCCC
250     CLINE=CLINE+1
        DO 255 I=1,80
        ONELIN(I)=XRHOLD(CLINE,I)
255     CONTINUE

C       CCCCC
C       C GET ALL PHYSICAL LINK STATISTICS ON THIS LINE
C       CCCCC
260     CALL AXISCA(ONELIN,14,PCPSI,IERR)
        CALL AXISCA(ONELIN,29,PHWIN,IERR)

C       CCCCC
C       C THERE ARE PHYSICAL LINK STATISTICS ON THE NEXT LINE TOO.
C       CCCCC
265     CLINE=CLINE+1
        DO 267 I=1,80
        ONELIN(I)=XRHOLD(CLINE,I)
267     CONTINUE

C       CCCCC
C       C GET ALL PHYSICAL LINK STATISTICS ON THIS LINE
C       CCCCC
268     CALL AXISCA(ONELIN,14,PCPSO,IERR)
        CALL AXISCA(ONELIN,29,PHWOU,IERR)

C       CCCCC
C       C FINISHED WITH THIS LINE. GO LOOK AT NEXT
C       CCCCC
270     CLINE=CLINE+1
        GOTO 100

CCCCC
C THIS NEXT LINE CONTAINS PACKET INFORMATION. CK IF IT HAS PACKET
C OVERHEAD OR PACK STATISTICS INFORMATION.
CCCCC
300     IF (XRHOLD(CLINE,8).EQ.'S')GOTO 350
CCCCC
C THE NEXT LINE CONTAINS PACKET OVERHEAD INFORMATION. PUT THIS LINE
C INTO A TEMP ARRAY SO THAT IT CAN BE SCANNED BY THE SCANNING
C SUBROUTINES.
CCCCC
        CLINE=CLINE+1
        DO 310 I=1,80
        ONELIN(I)=XRHOLD(CLINE,I)
310     CONTINUE

C       CCCCC
C       C GET ALL STATISTICS ON THIS LINE
C       CCCCC
320     CALL AXISCA(ONELIN,10,OVHDI,IERR)
        CALL AXISCA(ONELIN,26,OVHDO,IERR)

C       CCCCC
C       C FINISHED WITH THIS LINE. GO LOOK AT NEXT
C       CCCCC
330     CLINE=CLINE+1
        GOTO 100

CCCCC
C THE NEXT LINE CONTAINS PACKET STATISTICS INFORMATION. PUT THIS LINE
C INTO A TEMP ARRAY SO THAT IT CAN BE SCANNED BY THE SCANNING
C SUBROUTINES.
CCCCC
350     CLINE=CLINE+1
        DO 355 I=1,80
        ONELIN(I)=XRHOLD(CLINE,I)
355     CONTINUE

C       CCCCC
C       C GET ALL STATISTICS ON THIS LINE
C       CCCCC
360     CALL AXISCA(ONELIN,19,PKTSP,IERR)
        CALL AXISCA(ONELIN,43,PKTSI,IERR)

C       CCCCC
C       C NEXT LINE ALSO CONTAINS PACKET STATISTICS
C       CCCCC
        CLINE=CLINE+1
        DO 365 I=1,80
        ONELIN(I)=XRHOLD(CLINE,I)
365     CONTINUE

C       CCCCC
C       C GET ALL STATISTICS ON THIS LINE
C       CCCCC
367     CALL AXISCA(ONELIN,22,PKTSR,IERR)

C       CCCCC
C       C FINISHED WITH THIS LINE. GO LOOK AT NEXT
C       CCCCC
370     CLINE=CLINE+1
        GOTO 100

CCCCC
C THE NEXT LINE CONTAINS BANDWIDTH UTILIZATION INFORMATION. PUT THIS LINE
C INTO A TEMP ARRAY SO THAT IT CAN BE SCANNED BY THE SCANNING
C SUBROUTINES.
CCCCC
400     CLINE=CLINE+1
        DO 410 I=1,80
        ONELIN(I)=XRHOLD(CLINE,I)
410     CONTINUE

C       CCCCC
C       C GET ALL STATISTICS ON THIS LINE
C       CCCCC
420     CALL AXISCA(ONELIN,10,UTLZI,IERR)
        CALL AXISCA(ONELIN,26,UTLZO,IERR)

C       CCCCC
C       C FINISHED WITH THIS LINE. GO LOOK AT NEXT
C       CCCCC
430     CLINE=CLINE+1
        GOTO 100

CCCCC
C THIS LINE CONTAINS CHAR/SEC PER CIRCUIT INFORMATION. PUT THIS LINE
C INTO A TEMP ARRAY SO THAT IT CAN BE SCANNED BY THE SCANNING
C SUBROUTINES.
CCCCC
450     CLINE=CLINE+1
        DO 455 I=1,80
        ONELIN(I)=XRHOLD(CLINE,I)
455     CONTINUE

C       CCCCC
C       C GET ALL STATISTICS ON THIS LINE
C       CCCCC
460     CALL AXISCA(ONELIN,10,CPSIN,IERR)
        CALL AXISCA(ONELIN,24,CPSOU,IERR)
        CALL AXISCA(ONELIN,42,CKTS,IERR)

C       CCCCC
C       C FINISHED WITH THIS LINE. GO LOOK AT NEXT
C       CCCCC
470     CLINE=CLINE+1
        GOTO 100

CCCCC
C THIS LINE CONTAINS LINK DELAY INFORMATION. PUT THIS LINE
C INTO A TEMP ARRAY SO THAT IT CAN BE SCANNED BY THE SCANNING
C SUBROUTINES.
CCCCC
500     CLINE=CLINE+2
        DO 510 I=1,80
        ONELIN(I)=XRHOLD(CLINE,I)
510     CONTINUE

C       CCCCC
C       C GET ALL STATISTICS ON THIS LINE
C       CCCCC
520     CALL AXISCA(ONELIN,7,DLAIN,IERR)
        CALL AXISCA(ONELIN,17,DLTEA,IERR)
        CALL AXISCA(ONELIN,27,DLBUF,IERR)
        CALL AXISCA(ONELIN,37,DLOUT,IERR)
        CALL AXISCA(ONELIN,47,DLXMI,IERR)
        CALL AXISCA(ONELIN,57,DLTOT,IERR)

C       CCCCC
C       C FINISHED WITH THIS LINE. GO LOOK AT NEXT
C       CCCCC
530     CLINE=CLINE+1
        GOTO 100

CCCCC
C THE NEXT LINE CONTAINS INFORMATION THAT WE WANT. PUT THIS LINE
C INTO A TEMP ARRAY SO THAT IT CAN BE SCANNED BY THE SCANNING
C SUBROUTINES.
CCCCC
550     CLINE=CLINE+1
        DO 555 I=1,80
        ONELIN(I)=XRHOLD(CLINE,I)
555     CONTINUE

C       CCCCC
C       C GET ALL STATISTICS ON THIS LINE
C       CCCCC
560     CALL AXISCA(ONELIN,7,OVLDC,IERR)
        CALL AXISCA(ONELIN,23,SATRC,IERR)
        CALL AXISCA(ONELIN,39,BKLGC,IERR)
        CALL AXISCA(ONELIN,55,PKTSM,IERR)
        CALL AXISCA(ONELIN,69,IDLCA,IERR)

C       CCCCC
C       C FINISHED WITH THIS LINE. GO LOOK AT NEXT
C       CCCCC
570     CLINE=CLINE+1
        GOTO 100

CCCCC
C THIS LINE CONTAINS INFORMATION THAT WE WANT. PUT THIS LINE
C INTO A TEMP ARRAY SO THAT IT CAN BE SCANNED BY THE SCANNING
C SUBROUTINES.
CCCCC
600     DO 610 I=1,80
        ONELIN(I)=XRHOLD(CLINE,I)
610     CONTINUE

C       CCCCC
C       C GET ALL STATISTICS ON THIS LINE
C       CCCCC
620     CALL AXISCA(ONELIN,6,LINES(LINENO,1),IERR)
        CALL AXISCA(ONELIN,21,LINES(LINENO,2),IERR)
        CALL AXISCA(ONELIN,39,LINES(LINENO,3),IERR)
        CALL AXISCA(ONELIN,53,LINES(LINENO,4),IERR)
        LINENO=LINENO+1

C       CCCCC
C       C FINISHED WITH THIS LINE. GO LOOK AT NEXT
C       CCCCC
630     CLINE=CLINE+1
        GOTO 100


CCCCC
C WRITE UNFORMATTED INFORMATION TO OUTPUT FILE.
CCCCC
900     IF (OUTTYP.EQ.1) GOTO 950
        IPOS=SIZE(OUTDV1)+1
        WRITE(OUTDV1#IPOS,910)NODE,NEIGH,CDATE,CTIME,
     1          LCPSI,LHWIN,LCPOU,LHWOU,PCPSI,PHWIN,
     2          PCPSO,PHWOU,OVHDI,OVHDO,UTLZI,UTLZO,CPSIN,CPSOU,CKTS,
     3          PKTSP,PKTSI,PKSTR,DLAIN,DLTEA,DLBUF,DLOUT,DLXMI,DLTOT,
     4          OVLDC,SATRC,BKLGC,PKTSM,IDLCA,((LINES(I,J),J=1,4),I=1,4)

910     FORMAT (I5,I5,I6,I4,8(I8),4(I2),16(I4),I8,16(I4))
        IF (OUTTYP.EQ.2) GOTO 999

CCCCC
C USER WANTS FORMATTED OUTPUT.
CCCCC

950     ECOUNT=ECOUNT+1
        IF (ECOUNT.GT.8)GOTO 970

        EARRAY(1,ECOUNT)=NODE
        EARRAY(2,ECOUNT)=NEIGH
        EARRAY(3,ECOUNT)=CDATE
        EARRAY(4,ECOUNT)=CTIME
        EARRAY(5,ECOUNT)=LCPSI
        EARRAY(6,ECOUNT)=LHWIN
        EARRAY(7,ECOUNT)=LCPOU
        EARRAY(8,ECOUNT)=LHWOU
        EARRAY(9,ECOUNT)=PCPSI
        EARRAY(10,ECOUNT)=PHWIN
        EARRAY(11,ECOUNT)=PCPSO
        EARRAY(12,ECOUNT)=PHWOU
        EARRAY(13,ECOUNT)=OVHDI
        EARRAY(14,ECOUNT)=OVHDO
        EARRAY(15,ECOUNT)=UTLZI
        EARRAY(16,ECOUNT)=UTLZO
        EARRAY(17,ECOUNT)=CPSIN
        EARRAY(18,ECOUNT)=CPSOU
        EARRAY(19,ECOUNT)=CKTS
        EARRAY(20,ECOUNT)=PKTSP
        EARRAY(21,ECOUNT)=PKTSI
        EARRAY(22,ECOUNT)=PKSTR
        EARRAY(23,ECOUNT)=DLAIN
        EARRAY(24,ECOUNT)=DLTEA
        EARRAY(25,ECOUNT)=DLBUF
        EARRAY(26,ECOUNT)=DLOUT
        EARRAY(27,ECOUNT)=DLXMI
        EARRAY(28,ECOUNT)=DLTOT
        EARRAY(29,ECOUNT)=OVLDC
        EARRAY(30,ECOUNT)=SATRC
        EARRAY(31,ECOUNT)=BKLGC
        EARRAY(32,ECOUNT)=PKTSM
        EARRAY(33,ECOUNT)=IDLCA
        EARRAY(34,ECOUNT)=LINES(1,1)
        EARRAY(35,ECOUNT)=LINES(1,2)
        EARRAY(36,ECOUNT)=LINES(1,3)
        EARRAY(37,ECOUNT)=LINES(1,4)
        EARRAY(38,ECOUNT)=LINES(2,1)
        EARRAY(39,ECOUNT)=LINES(2,2)
        EARRAY(40,ECOUNT)=LINES(2,3)
        EARRAY(41,ECOUNT)=LINES(2,4)
        EARRAY(42,ECOUNT)=LINES(3,1)
        EARRAY(43,ECOUNT)=LINES(3,2)
        EARRAY(44,ECOUNT)=LINES(3,3)
        EARRAY(45,ECOUNT)=LINES(3,4)
        EARRAY(46,ECOUNT)=LINES(4,1)
        EARRAY(47,ECOUNT)=LINES(4,2)
        EARRAY(48,ECOUNT)=LINES(4,3)
        EARRAY(49,ECOUNT)=LINES(4,4)
        GOTO 999

970     PAGE=PAGE+1
        IPOS=SIZE(OUTDV2)+1
        WRITE (OUTDV2#IPOS,972)PAGE
972     FORMAT(///,20X,'XRAY LINK STATISTICS REPORT',10X,'PAGE ',I5,/,
     +  /,21X,7('LINK',3X),'LINK')
        IPOS=SIZE(OUTDV2)+1
        WRITE(OUTDV2#IPOS,973)(EARRAY(1,I),I=1,8),(EARRAY(2,I),I=1,8)
973     FORMAT(19X,7(I6,1X),I6,/,19X,7(I6,1X),I6,/)

974     DO 980 I=3,49
        IPOS=SIZE(OUTDV2)+1
        WRITE(OUTDV2#IPOS,975)(NAMES(I,J),J=1,3),(EARRAY(I,J),J=1,8)
975     FORMAT (5X,2A5,A3,1X,7(I6,1X),I6)
980     CONTINUE

        IPOS=SIZE(OUTDV2)+1
        WRITE (OUTDV2#IPOS,982)
982     FORMAT (25(/))
        IF (ENDFLG.EQ.1) GOTO 999
        ECOUNT=1
        DO 985 I=1,49
        DO 985 J=1,8
        EARRAY(I,J)=0
985     CONTINUE



CCCCC
C RETURN
CCCCC
999     RETURN
        END
