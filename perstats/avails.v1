CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C PROGRAM: AVAIL.FTF
C AUTHOR: JO ANN JOELS
C DATE: AUGUST, 1991
C
C THIS PROGRAM WAS WRITTEN FOR GARY WALKER TO COMPUTE STATISTICS
C ON NETWORK AVAILIBILITY FOR ANY ONE GIVEN MONTH.
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC

        INTEGER RANGES(23,2),RCOUNT(23),RAVAIL(23),PCTILE(3),
     +          PCREC(3),MINAV,MAXAV,INITT,LAST,NUMDB,
     +          DBASE(50,5),NUMREC,SDATE(2),EDATE(2),SMONTH,SYEAR,
     +          NUMHST,NUMDAY,AVHRS,MONTBL(12),DUPCMD(14),CURDB(5),
     +          HSTNAM(5),HSTCMD(10),CNODE,ONEPC,TOTNOD,RECNO,
     +          WORSTT(10),OUTNAM(3),AVNHRS

        REAL RFREQ(23),RMEAN(23),WORSTE(10),PCAVAL(3)

        DATA RANGES/1,10,11,50,51,100,101,150,151,200,201,250,251,
     +              300,301,350,351,400,401,450,451,500,501,600,
     +              601,700,701,800,801,900,901,1000,1001,1500,
     +              1501,2000,2001,3000,3001,4000,4001,5000,5001,
     +              10000,10001,100000/

        DATA MONTBL/31,28,31,30,31,30,31,31,30,31,30,31/

        CALL DBSTRT(1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,
     +          1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,
     +          1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,
     +          1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,
     +          1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0)

        NUMRNG = 23
        NUMRNG = 23
        NUMDB = 0
        MINAV = 999999
        MAXAV = 0
        AVGAV = 0
        COMFRQ = 0
        INITT = 0
        LAST = 0
        NUMREC = 0


C INIT THE ARRAYS 
        DO 100 I = 1,NUMRNG
        RCOUNT(I) = 0
        RAVAIL(I) = 0
        RFREQ(I) = 0
        RMEAN(I) = 0
100     CONTINUE

        PCTILE(1) = 90
        PCTILE(2) = 95
        PCTILE(3) = 99





C       CCCCC
C       C OPEN THE DATA BASE LIST FILE AND READ ALL OF THE
C       C DATA BASE NAMES THAT WILL BE SEARCHED FOR THE
C       C TICKET INFORMATION
C       CCCCC

        OPEN(21,'AVAIL.DBS',INPUT, ERR = 910)
        DO 150 I=1,50
                READ(21,120,END = 155)(DBASE(I,J),J=1,5)
120             FORMAT(5A5)
                NUMDB = NUMDB+1
150     CONTINUE
155     CLOSE(21)

C       CCCCC
C       C OPEN THE 1022 DATA BASE CONTAINING
C       C THE NUMBER OF NODES IN THE NETWORK FOR EACH MONTH
C       CCCCC

        CALL DBOPEN('HSTMNT')

C       CCCCC
C       C PROMPT FOR THE START DATE AND END DATE
C       CCCCC
160     TYPE 165
165     FORMAT(1X,'ENTER START DATE(MM/DD/YYYY): ',$)
        ACCEPT 170,SDATE
170     FORMAT(2A5)

        TYPE 175
175     FORMAT(1X,'ENTER ENDDATE(MM/DD/YYYY): ',$)
        ACCEPT 170,EDATE

C       CCCCC
C       C GET A LIST OF HOST NUMBERS TO SELECT FOR
C       CCCCC
176     TYPE 177
177     FORMAT (1X,'ENTER HOST FILENAME: ',$)
        ACCEPT 178,HSTNAM
178     FORMAT(5A5)

C       CCCCC
C       C FROM THE START DATE, DETERMINE THE MONTH AND
C       C YEAR. THIS INFORMATION WILL BE USED TO DETERMINE
C       C THE NUMBER OF NODES AND DAYS IN A MONTH.
C       CCCCC

180     DECODE(10,185,SDATE)SMONTH,SYEAR
185     FORMAT(I2,4X,I4)

C       CCCC
C       C FIND THE NUMBER OF NODES FOR THIS MONTH
C       CCCCC
190     CALL DBFIND('YEAR','EQ',SYEAR,'AND','MONTH','EQ',SMONTH)
        CALL DBGREC($900)
        CALL DBVAL('HOSTS',TOTNOD)
        CALL DBCLOSE

C       CCCCC
C       C OPEN A FLAT FILE WHICH WILL CONTAIN ALL RECORDS FOR
C       C THE SPECIFIED MONTH.  RECORDS FROM EACH
C       C DATA BASE WILL BE APPENDED TO THIS FILE (IF THERE
C       C ARE ANY IN THE DATABASE FOR THE SPECIFIED MONTH).
C       CCCCC
        OPEN(22,'AVAIL.DMI',OUTPUT,ERR=920)

C       CCCCC
C       C DETERMINE THE NUMBER OF DAYS IN THE MONTH
C       CCCCC
200     NUMDAY = MONTBL(SMONTH)

C       CCCCC
C       C NOW COMPUTE THE TOTAL NUMBER OF AVAILABLE HOURS
C       C IN THE MONTH
C       CCCCC
210     AVHRS = NUMDAY*24*TOTNOD
        AVNHRS = NUMDAY*24

C       CCCCC
C       C LOOP THROUGH ALL OF THE DATA BASE FILES
C       CCCCC
250     DO 310 I = 1, NUMDB

C       CCCCC
C       C OPEN THE CURRENT DATA BASE
C       CCCCC
        DO 260 II = 1,5
                CURDB(II)=DBASE(I,II)
260     CONTINUE
        CALL DBOPEN(CURDB)

C       CCCCC
C       C SELECT ONLY THOSE RECORDS IN THE TYMNET NETWORK,
C       C WITH SEVERITY OF ONE AND WHOSE CLOSE OUT CODE
C       C DOES NOT CONTAIN "PROJ" OR "CUST. IND."
C       CCCCC
265     CALL DBFIND('ALL')
        CALL DBSRCH('NET','CT','TYMNET','AND','SVER','EQ',1,'AND',
     +          'COC','NCT','PROJ','AND','COC','NCT','CUST. IND.')
        ENCODE(66,270,DUPCMD)SDATE,EDATE
270     FORMAT('SEARCH LAST AND DUP BETWEEN INT("',2A5,'") INT("',
     +          2A5,'")')
        CALL DBEXEC(DUPCMD)
C       CCCCC
C       C IF THERE WAS A HOST FILE SPECIFIED, THEN SELECT
C       C RECORDS FOR JUST THE HOSTS IN THE FILE.
C       CCCCC
        IF ( HSTNAM(1) .EQ. '     ' ) GOTO 275
        ENCODE(50,271,HSTCMD)HSTNAM
271     FORMAT('SEARCH LAST AND HOST EQ @',5A5)
        CALL DBEXEC(HSTCMD)
275     CALL DBSRCH('LAST','AND','ELM','GE',0)
        CALL DBNREC(IREC)

        TYPE 276,(CURDB(II),II=1,5),IREC
276     FORMAT(/,1X,'DATABASE: ',5A5,1X,'RECORDS SELECTED: ',I6,/)

C       CCCCC
C       C LOOP THROUGH ALL RECORDS SELECTED
C       CCCCC
280     CALL DBGREC($300)
        CALL DBVAL('ELM',ELM,'TNUM',ITCKT,'NODE',INODE)

C       CCCCC
C       C DETERMINE THE DOWN TIME IN HOURS FOR THIS RECORD.
C       CCCCC
285     ELH = 0.0
        IF ( ELM.EQ.0 ) GOTO 290
        ELH = ELM/60.

C       CCCCC
C       C  WRITE THE RECORD TO A FLAT FILE.
C       CCCCC
290     WRITE(22,295)ITCKT,INODE,ELH
295     FORMAT(I8,1X,I6,1X,F10.3)

C       CCCCC
C       C READ THE NEXT RECORD.
C       CCCCC
        GOTO 280

C       CCCCC
C       C CLOSE THIS DATA BASE AND GO PROCESS THE NEXT
C       CCCCC
300     CALL DBCLOSE
310     CONTINUE

C       CCCCC
C       C FINISHED WITH ALL OF THE DATA BASES.  CLOSE THE
C       C FLAT FILE AND LOAD IT INTO 1022.
C       CCCCC
320     CLOSE(22)
        CALL DBEXEC('LOAD AVAIL')

C       CCCCC
C       C SORT THE MONTHLY DATA BASE BY NODE NUMBER
C       C THEN LOOP THROUGH THE DATA BASE CREATING A NEW
C       C FLAT FILE WHICH CONTAINS ONLY ONE RECORD
C       C PER NODE.
C       CCCCC

        CALL DBOPEN('AVAIL')
        CALL DBFIND('ALL')
        CALL DBEXEC('SORT KEY NODE')

C       CCCCC
C       C OPEN THE FLAT FILE TO CONTAIN ONE RECORD PER NODE.
C       CCCCC
        OPEN(22,'AVAILN.DMI',OUTPUT,ERR=930)

        TOTELH = 0
        FIRST = 0
330     CALL DBGREC($350)
        CALL DBVAL('NODE',INODE,'ELH',ELH)
        IF ( FIRST .NE. 0 ) GOTO 335
                CNODE = INODE
                FIRST = 1
                NUMNOD = 1

335     IF ( INODE.NE.CNODE ) GOTO 340
                TOTELH = TOTELH + ELH
                GOTO 330

C       CCCCC
C       C THE NODE HAS CHANGED. OUTPUT A RECORD TO THE FLAT FILE.
C       CCCCC
340     WRITE(22,341)CNODE,TOTELH
341     FORMAT(I8,1X,F20.3)
        CNODE = INODE
        TOTELH = ELH
        NUMNOD = NUMNOD+1
        GOTO 330

350     CALL DBCLOSE
        CLOSE(22)
        CALL DBEXEC('LOAD AVAILN')
        CALL DBOPEN('AVAILN')
        CALL DBEXEC('SORT KEY ELH')
        CALL DBFIND('ALL')

C       CCCC
C       C DETERMINE HOW MANY NODES ARE IN 1 PERCENT OF
C       C ALL NODES
C       CCCCC
370     ONEPC = TOTNOD/100
        PCREC(1) = PCTILE(1)*ONEPC
        PCREC(2) = PCTILE(2)*ONEPC
        PCREC(3) = PCTILE(3)*ONEPC

        NOOUT = TOTNOD - NUMNOD
        DO 380 I = 1,3
        RECNO = PCREC(I) - NOOUT
        IF ( RECNO.LT.0 ) GOTO 375
        CALL DBGREC($385,RECNO)
        CALL DBVAL('ELH',ELH)
372     PCAVAL(I) = (1.0 - ELH/AVNHRS)*100.0
        GOTO 380

375     PCAVAL(I) = 100.0
380     CONTINUE
        GOTO 390

385     TYPE 386,RECNO
386     FORMAT(1X,'ERROR. UNABLE TO FIND RECORD NUMBER: ',I6)
        GOTO 999


390     CALL DBCLOSE

C       CCCCC
C       C FIND THE WORST 10 ELM'S FROM THE AVAIL DATA BASE.
C       CCCCC
400     CALL DBOPEN('AVAIL')
        CALL DBFIND('ALL')
        CALL DBEXEC('SORT ELH DESC')
        ICOUNT = 1
410     CALL DBGREC($999)
        CALL DBVAL('TCKT',ITCKT,'ELH',ELH)
        WORSTT(ICOUNT) = ITCKT
        WORSTE(ICOUNT)= ELH
        ICOUNT = ICOUNT +1
        IF (ICOUNT .GT. 10 ) GOTO 420
        GOTO 410

420     CALL DBCLOSE

C       CCCCC
C       C OUTPUT THE REPORT
C       CCCCC
800     IF ( SMONTH.GT.9 ) GOTO 803
                ENCODE(9,802,OUTNAM)SYEAR,SMONTH
802     FORMAT('AV',I4,'.',I1)
        GOTO 805

803     ENCODE(10,804,OUTNAM)SYEAR,SMONTH
804     FORMAT('AV',I4,'.',I2)

805     OPEN(22,OUTNAM,OUTPUT,ERR=940)
        WRITE(22,801)SDATE,EDATE
801     FORMAT(////,30X,'NETWORK AVAILABILITY',/,29X,2A5,' - ',2A5)
        WRITE(22,808)PCAVAL(1)
808     FORMAT(//,22X,'90TH PERCENTILE: ',F8.2,' % AVAILABILITY')
        WRITE(22,806)PCAVAL(2)
806     FORMAT(/,22X,'95TH PERCENTILE: ',F8.2,' % AVAILABILITY')
        WRITE(22,807)PCAVAL(3)
807     FORMAT(/,22X,'99TH PERCENTILE: ',F8.2,' % AVAILABILITY')

        WRITE(22,809)
809     FORMAT(///,23X,'10 WORST TICKETS BY ELASPED HOURS',/)
        WRITE(22,811)
811     FORMAT(27X,'TICKET',7X,'ELASPED HOURS',/,
     +         27X,'--------',5X,'-------------',/)


        DO 815 I = 1,10
        WRITE(22,813)WORSTT(I),WORSTE(I)
813     FORMAT(26X,I8,5X,F10.2)
815     CONTINUE
        CLOSE(22)
        GOTO 999

900     TYPE 905,SMONTH,SYEAR
905     FORMAT(1X,'ERROR NO REC IN HSTMNT FOR: ',I2,1X,I4)
        GOTO 999

910     TYPE 915
915     FORMAT(1X,'ERROR. UNABLE TO OPEN FILE: AVAIL.DBS')
        GOTO 999

920     TYPE 925
925     FORMAT(1X,'ERROR. UNABLE TO OPEN FILE: AVAIL.DMI')
        GOTO 999

930     TYPE 935
935     FORMAT(1X,'ERROR. UNABLE TO OPEN FILE: AVAILN.DMI')
        GOTO 999

940     TYPE 945,OUTNAM
945     FORMAT(1X,'ERROR. UNABLE TO OPEN FILE: ',2A5,/)
        GOTO 999
999     CALL DBEND
        END
 