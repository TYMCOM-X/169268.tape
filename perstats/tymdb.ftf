CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C                                                                    C
C       PROGRAM: TYMDB                                               C
C       AUTHOR: JO ANN JOELS                                         C
C       CREATED: SEPTEMBER, 1985                                     C
C       LAST UPDATE: MARCH, 1986                                     C
C       UPDATED BY: JO ANN JOELS
C       VERSION: 2.0                                                 C
C                                                                    C
C       THIS PROGRAM READS TYM FILES AND UPDATES 1022 DATA BASES     C
C       WITH THE INFORMATION FROM THE TYM FILES.  FOR A COMPLETE      C
C       OF THIS PROGRAM READ (JJOELS)TYMDB.DOC.                       C
C                                                                    C
C       VERSION 2.0 - ADDED XRAY LOOKUP AND INFORMATION RETRIEVAL    C
C                                                                    C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC


100     CALL DBSTRT (1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,
     1  1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,
     2  1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0)
        INTEGER IPARAM(75,7),HPARAM(15,7),SPARAM(20,7),CPARAM(10,7),
     1         INPAR,HNPAR,SNPAR,CNPAR,IVAL(75,2),
     2         HVAL(15,4),CVAL(10,2),ERROR,POS,TYPE(3),
     3         TYMNAM(4),CREDAT(2),CRETIM,UPDDAT,UPDTIM,JUNK,NODE,
     4         LOGPOS,LOGDEV,TDATE(2),TTIME,TYMDEV,TYMPOS,CDATE,
     5         END(2),DIRNAM(2),DIRCNT,STR1(80),STR2(15),FOUND,STRPOS,
     6          DNAME(2),DIRCNT,IGPAR(40,2),IGNPAR,TYMCNT,SDATE(2),
     7          STIME,EDATE(2),ETIME,DIRDEV

        COMMON LOGPOS,LOGDEV

        DIRCNT=1
        LOGDEV=26
        TYMDEV=22
        DIRDEV=21
CCCCC
C READ THE PARAMETER FILE
CCCCC
150     CALL INPAR(HPARAM,HNPAR,IPARAM,INPAR,SPARAM,SNPAR,CPARAM,
     1       CNPAR,IGPAR,IGNPAR,ERROR)

C       CCCCC
C       C IF ERROR OCCURRED DURING READING OF FILE, QUIT.
C       CCCCC
        IF (ERROR.NE.0) GOTO 9999

CCCCC
C INIT THE ARRAYS THAT HOLD PARAMETER VALUES
CCCCC
200     CALL INIT(IPARAM,IVAL,HVAL,CVAL)

CCCCC
C OPEN THE 1022 DATA BASES
CCCCC
300     CALL DBOPEN ('TYMNOD','TYMLIN','TYMSLO','TYMLU','TYMCS',
     1               'TYMHST','PRODID')

CCCCC
C IN THE NODE DATA BASE CHANGE 'EXIST' FOR ALL NODES TO 0.
C BY THE END OF THE PROGRAM 'EXIST' WILL REFLECT WHICH NODES 
C STILL HAVE TYM FILES AND WHICH HAVE BEEN DELETED FROM THE NETWORK.
CCCCC
325     CALL DBSET(1)
        CALL DBFIND('ALL')
        CALL DBCHNG('EXIST',0)

CCCCC
C OPEN THE LOG FILE AND OUPUT THE DATE AND TIME
CCCCC
350     OPEN (LOGDEV,'TYMDB.LOG',RANDOUT)
        LOGPOS=SIZE(LOGDEV)+1
        CALL DATE(TDATE)
        CALL TIME(TTIME)
        SDATE(1)=TDATE(1)
        SDATE(2)=TDATE(2)
        STIME=TTIME
        WRITE (LOGDEV#LOGPOS,355)TDATE,TTIME
355     FORMAT(//,1X,'PROGRAM STARTUP: ',2A5,1X,A5,//)

CCCCC
C OPEN THE TYMDB STATUS FILE AND OUTPUT THE DATE AND STARTUP MESSAGE
CCCCC
        OPEN (17,'TYMDB.STA',OUTPUT)
        WRITE(17,356)TDATE
356     FORMAT (2A5,/,'TYMDB STARTED')
        CLOSE(17)

CCCCC
C OPEN THE FILE CONTAINING THE LIST OF DIRECTORY NAMES TO PROCESS ON THIS
C SYSTEM.
CCCCC
400     OPEN (19,'TYMDB.DIR',INPUT)
        DIRCNT=0
405     READ (19,410,END=9999)DIRNAM
410     FORMAT (2A5)
        DIRCNT=CIRCNT+1

CCCCC
C BUILD THE FILE NAME FOR THE FILE CONTAINING THE LIST AF ALL TYMFILES
C IN THE DIRECTORY.
CCCCC
415     ENCODE(8,420,DNAME)DIRCNT
420     FORMAT ('TYMDB.D',I1)

CCCCC
C NOW OPEN THE LIST OF TYM FILES
CCCCC
425     OPEN(21,DNAME,INPUT)

C       CCCCC
C       C SKIP OVER THE 1ST 5 LINES OF THE FILE.  THESE LINES
C       C ARE HEADER INFORMATION
C       CCCCC
450     DO 460 I=1,5
        READ (21,455)JUNK
455     FORMAT (A1)
460     CONTINUE

CCCCC
C BEGIN THE LOOP THROUGH THIS LIST OF TYM FILES
CCCCC

C       CCCCC
C       C CHECK TO SEE IF THIS TYM FILE IS TO BE PROCESSED.
C       C IF FILE IS OK TO PROCESS THEN THE NODE NUMBER, THE FILE NAME
C       C AND THE TYM FILE CREATION DATE AND TIME WILL BE RETURNED.
C       CCCCC
500     CALL BEGIN(21,DIRNAM,TYMNAM,CREDAT,CRETIM,NODE,ERROR)
C       TYPE 501,ERROR
501     FORMAT (1X,'RETURN FROM BEGIN: ',I4)
C               CCCCC
C               C IF ERROR FLAG IS SET TO 1 THEN END OF DIRECTORY
C               C FILE HAS BEEN REACHED. UPDATING OF DATA BASES
C               C HAS BEEN COMPLETED. GO CLOSE FILE AND QUIT.
C               CCCCC
                IF (ERROR.EQ.1) GO TO 8000

C               CCCCC
C               C IF ERROR FLAG IS SET TO 2 THEN EITHER THERE WAS 
C               C AN ERROR READING THE TYM FILE OR THE FILE IS NOT
C               C TO BE PROCESSED. IN EITHER CASE, THERE
C               C IS NO FURTHER PROCESSING TO BE DONE ON THIS FILE.
C               C GO LOOK AT NEXT FILE.
C               CCCCC
                IF (ERROR.NE.2) GOTO 600
                CLOSE(TYMDEV)
                GO TO 500

C       CCCCC
C       C CHECK TO SEE OF THE 1022 DATA BASES NEED TO BE UPDATED FOR
C       C THIS NODE
C       CCCCC
600     CALL UPDCHK(TYMNAM,TDATE,TDATEC,CREDAT,CRETIM,CDATE,NODE,ERROR)

C               CCCCC
C               C IF ERROR FLAG IS SET TO 1 THEN DO NOT NEED
C               C TO UPDATE. GO CHECK ON NEXT TYM FILE IN LIST.
C               CCCCC
C       TYPE 601,NODE,ERROR
601     FORMAT (1X,'PROCESSING: ',I5,1X,'ERROR = ',I4)
                IF (ERROR.EQ.1)  GOTO 500

C               CCCCC
C               C IF NODE NUMBER IS LT 2000 THEN THIS IS NOT A 
C               CCCC
                IF (NODE.LT.2000) GO TO 500

C               CCCCC
C               C IF ERROR FLAG IS SET TO 2,3, OR 4 THEN THE TYM FILE DOES
C               C NOT NEED TO BE READ. IF ERROR=2 OR 4 GET XRAY INFORMATION.
C               C IF ERROR=3, THEN GET DDT INFORMATION.
C               CCCCC
                IF (ERROR.EQ.2.OR.ERROR.EQ.4) GOTO 1450
                IF (ERROR.EQ.3) GOTO 1475

C       CCCCC
C       C OPEN THE TYM FILE
C       CCCCC
700     OPEN (TYMDEV,TYMNAM,INPUT,ERR=710)
        CALL DATE(TDATE)
        CALL TIME(TTIME)
        LOGPOS=SIZE(LOGDEV)+1
        WRITE (LOGDEV#LOGPOS,705)TYMNAM,TDATE,TTIME
705     FORMAT (//,1X,'PROCESSING: ',4A5,' AT ',2A5,1X,A5)
        GO TO 800

710     TYPE 720,TYMNAM
720     FORMAT (1X,'UNABLE TO OPEN TYM FILE: ',4A5)
        GO TO 500

C       CCCCC
C       C SCAN COMMENTS AT BEGINNING OFTYM FILE FOR
C       C HEADER INFORMATION. (CODE VERSION NUMBERS, MEMORY, ETC.)
C       CCCCC
800     CALL SCANC(TYMDEV,HPARAM,HNPAR,HVAL,ERROR)

C               CCCCC
C               C IF NODE IS 'PICO' DON'T LOOK FOR OTHER 
C               C INFORMATION ON THE NODE
C               CCCCC
                IF (HVAL(10,1).NE.'XXXXX') GO TO 1000
                IF (ERROR.NE.0) GOTO 1400

C       CCCCC
C       C SCAN FILE FOR HARDWARE, SOFTWARE, AND ISIS CONFIGURATION 
C       C PARAMETERS
C       CCCCC
900     CALL SCANP(TYMDEV,IPARAM,INPAR,IVAL,IGPAR,IGNPAR,ERROR)

C       CCCCC
C       C LOOK AT FIRST PARAMETER ENCOUNTERED AND SET TYM FILE TYPE
C       CCCCC
1000     CALL SETTYP(TYPE,IVAL,INPAR,HVAL)

C       CCCCC
C       C UPDATE THE NODE DATA BASE WITH THE INFORMATION
C       C GATHERED SO FAR.
C       CCCCC

1100    CALL UPDNOD(NODE,TYPE,TDATEC,CDATE,CRETIM,HVAL,IVAL,ERROR)

C               CCCCC
C               C IF NODE IS 'PICO' TIME TO STOP
C               CCCCC

                IF (HVAL(10,1).NE.'XXXXX') GO TO 1400


C       CCCCC
C       C SCAN THE TYM FILE FOR THE NETWORK CONFIGURATION PARAMETERS.
C       CCCCC
1200    CALL SCANN(TYMDEV,NODE,CDATE,CRETIM,END,ERROR)

C               CCCCC
C               C IF END OF TYM FILE HAS BEEN REACHED. FINISHED.
C               CCCCC
1210            IF (ERROR.NE.0) GO TO 1400

C       CCCCC
C       C SCAN REST OF FILE DEPENDING ON WHICH PARAMETER ENDED THE PREVIOUS
C       CCCCC
C       C SCAN.
1300    IF (END(1).NE.'SLOT ') GO TO 1325
        CALL SCANS(TYMDEV,CDATE,CRETIM,TYMNAM,NODE,SPARAM,SNPAR,IGPAR,
     1  IGNPAR,ERROR)
        GO TO 1400

1325    IF (END(1).NE.'CONSA') GO TO 1350
        CALL SCANCS(TYMDEV,CPARAM,CNPAR,CVAL,IGPAR,IGNPAR,CDATE,CRETIM,
     1  NODE,ERROR)
        GO TO 1400

1350    IF (END(1).NE.'XLINK') GO TO 1375
        CALL XLINK(NODE,IPARAM,ERROR)
        IF (TYPE(1).NE.'CONSA') GO TO 1360
        CALL SCANCS(TYMDEV,CPARAM,CNPAR,CVAL,IGPAR,IGNPAR,CDATE,CRETIM,
     1  NODE,ERROR)
        GO TO 1400

1360    IF (TYPE(1).NE.'ISIS-') GO TO 1400
1362    READ (TYMDEV,1365,END=1400)(STR1(I),I=1,80)
1365    FORMAT (80A1)
        STR2(1)='SLOT'
        STR2(2)='     '
        STRPOS=1
        CALL AXLSCA(STR1,STR2,STRPOS,'N',FOUND)
        IF (FOUND.EQ.0) GO TO 1362
        CALL SCANS(TYMDEV,CDATE,CRETIM,TYMNAM,NODE,SPARAM,SNPAR,IGPAR,
     1  IGNPAR,ERROR)
        GO TO 1400

1375    LOGPOS=SIZE(LOGDEV)+1
        WRITE (LOGDEV#LOGPOS,1380)
1380    FORMAT (1X,'UNRECOGNIZABLE END TO NETWORK CONFIGURATION',
     1  ' SECTION.')



CCCCC
C FINISHED READING TYM FILE. CLOSE IT.
CCCCC
1400    CLOSE(TYMDEV)

CCCCCC
C GET XRAY INFORMATION FOR THIS NODE.
CCCCC
1450    CALL XRAY(NODE,CDATE,CRETIM,ERROR)
C       TYPE 1451,ERROR
1451    FORMAT (1X,'RETURN FROM XRAY: ',I4)

CCCCC
C GET DDT INFORMATION FOR THIS NODE.
CCCCC
1475    CALL DDT(NODE,ERROR)

CCCCC
C FINISHED WITH THIS NODE. GO LOOK AT TYM FILE FOR NEXT NODE.
C FIRST, RE-INIT VALUE HOLDING ARRAYS.
CCCCC
1500    CALL INIT(IPARAM,IVAL,HVAL,CVAL)
        TYMCNT=TYMCNT+1
        GOTO 500

CCCCC
C REACHED END OF THISDIRECTORY FILE.  CLOSE IT.
CCCCC
8000    CLOSE(21)
C       CCCCC
C       C GO SEE IF THERE IS ANOTHER DIRECTORY ON THIS SYSTEM WITH
C       C TYM FILE TO PROCESS.
C       CCCCC
        GO TO 405

CCCCC
C PROGRAM FINISHED.
CCCCC
9999    CALL DBCLOS
        CLOSE(LOGDEV)
        CLOSE(19)
        CALL DATE(EDATE)
        CALL TIME(ETIME)
        TYPE 10000,SDATE,STIME,EDATE,ETIME,TYMCNT
10000   FORMAT (1X,'PROGRAM STARTED: ',2A5,1X,A5,/,
     1          1X,'PROGRAM ENDED: ',2A5,1X,A5,/,
     2          1X,'NODES PROCESSED = ',I4)
        OPEN (17,'TYMDB.STA',RANDOUT)
        IPOS=SIZE(17)+1
        WRITE(17#IPOS,10005)
10005   FORMAT ('TYMDB FINISHED')
        CLOSE(17)
        CALL DBEND
        END
    